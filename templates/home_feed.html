{% extends "base.html" %}
{% block content %}
<style>
  /* Right rail: match left filter rail (flush to edge, sharp corners) */
  .home-right{background:#fff;border-left:1px solid #e5e7eb;border-radius:0;box-shadow:none;}
  /* Two stacked blocks (mini-map + stats) but flush; divider between them */
  .rail-card{border:0;border-radius:0;background:transparent;overflow:hidden;}
  .rail-card + .rail-card{margin-top:0;border-top:1px solid #e5e7eb;}
  .rail-card-head{padding:14px 14px 12px;background:#fff;}
  .rail-section{padding:14px 14px 12px;border-top:1px solid #e5e7eb;background:#fff;}
  .rail-section:first-of-type{border-top:0;}

  /* Home right-rail minimap crop:
     Keep the underlying CONUS framing/zoom unchanged, but crop top/bottom to save vertical space. */
  .minimap-crop{height:235px; overflow:hidden; background:#f3f4f6;}
  .minimap-crop img{width:100%; height:130%; object-fit:cover; object-position:50% 42%; display:block;}

</style>
<!-- v441 — Home clickwrap (Welcome + policies) -->
<div id="es-clickwrap" class="es-clickwrap" aria-hidden="true">
  <div class="es-clickwrap-backdrop"></div>
  <div class="es-clickwrap-panel" role="dialog" aria-modal="true" aria-labelledby="es-clickwrap-title">
    <div class="es-clickwrap-title" id="es-clickwrap-title">Welcome to EnforcedSpeed.</div>
    <div class="es-clickwrap-body">EnforcedSpeed aggregates real-world speeding ticket data submitted by drivers. Posted speed limits are the law and must always be obeyed. This site does not provide legal advice, encourage speeding, or suggest that any enforcement patterns replace posted limits.</div>
    <div class="es-clickwrap-terms">
      By using this service you agree to our
      <a href="{{ url_for('terms') }}" target="_blank" rel="noopener">Terms</a>,
      <a href="{{ url_for('privacy') }}" target="_blank" rel="noopener">Privacy</a>,
      and
      <a href="{{ url_for('cookies') }}" target="_blank" rel="noopener">Cookie Policy</a>.
    </div>

    <label class="es-clickwrap-check">
      <input id="es-clickwrap-check" type="checkbox" />
      <span>I agree</span>
    </label>

    <button id="es-clickwrap-continue" class="es-clickwrap-btn" type="button" disabled>Continue</button>

    <div class="es-clickwrap-footer">
      <a href="{{ url_for('login', next=request.path) }}">Log in</a> to prevent this message again.
    </div>
  </div>
</div>



<div class="home-shell">

    {# Left sidebar: sticky filters (desktop). Collapses behind button on mobile. #}
    <aside class="home-left" id="homeFiltersSidebar">
      <div class="filters-rail">
        <div class="filters-scroll">
        <form method="get" action="{{ url_for('home') }}" class="filterbar" id="feedFilters">
          <div class="filterbox">
            <div class="filterbox-title">Filter Speeding Tickets</div>
            <div class="filterbar-row filterbar-row--stack">

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-state">State</label>
                <select id="filter-state" name="state" class="filterbar-select" onchange="this.form.submit()">
                  <option value="" {% if not filter_state %}selected{% endif %}>All states</option>
                  {% for opt in state_filter_options %}
                    <option value="{{ opt.code }}" {% if filter_state == opt.code %}selected{% endif %}>{{ opt.code }}</option>
                  {% endfor %}
                </select>
              </div>

                            <div class="filterbar-item">
                <label class="filterbar-label" for="filter-county">County</label>
                <div class="filter-autocomplete-wrap">
                  <input id="filter-county" value="{{ filter_county_label or '' }}" placeholder="Start typing (e.g., Franklin)" autocomplete="off">
                  <input type="hidden" id="filter-county-geoid" name="county_geoid" value="{{ filter_county_geoid or '' }}">
                  <div class="filter-suggestions" id="filter-county-suggestions" style="display:none"></div>
                </div>
              </div>

<div class="filterbar-item filterbar-item--tight">
                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                  <label class="filterbar-label" for="filter-verify" style="margin:0;">Photo <span class="filter-check">✓</span></label>
                  <label class="switch">
                    <input type="checkbox" id="filter-verify" name="verify" value="verified" {% if filter_verify == 'verified' %}checked{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
<div class="filterbar-item filterbar-item--tight">
  <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
    <label class="filterbar-label" for="filter-pin" style="margin:0;">Map pin <span class="filter-check">✓</span></label>
    <label class="switch">
      <input type="checkbox" id="filter-pin" name="pin" value="1" {% if filter_pin %}checked{% endif %} onchange="this.form.submit()">
      <span class="slider"></span>
    </label>
  </div>
</div>



              <div class="filterbar-item">
  <label class="filterbar-label" for="filter-speed-limit">Posted speed limit</label>
  <select id="filter-speed-limit" name="speed_limit" class="filterbar-select" onchange="this.form.submit()">
    <option value="any" {% if (filter_speed_limit_list|length == 0) %}selected{% endif %}>Any</option>
    <option value="lte35" {% if 'lte35' in filter_speed_limit_list %}selected{% endif %}>≤ 35 mph</option>
    <option value="40-55" {% if '40-55' in filter_speed_limit_list %}selected{% endif %}>40–55 mph</option>
    <option value="gte60" {% if 'gte60' in filter_speed_limit_list %}selected{% endif %}>≥ 60 mph</option>
  </select>
</div>

              <div class="filterbar-item">
  <label class="filterbar-label" for="filter-overage">Overage (mph over)</label>
  <select id="filter-overage" name="overage" class="filterbar-select" onchange="this.form.submit()">
    <option value="all" {% if (filter_over_list|length == 0) %}selected{% endif %}>Any</option>
    <option value="1-10" {% if '1-10' in filter_over_list %}selected{% endif %}>1–10 mph over</option>
    <option value="11-20" {% if '11-20' in filter_over_list %}selected{% endif %}>11–20 mph over</option>
    <option value="21+" {% if '21+' in filter_over_list %}selected{% endif %}>≥ 21 mph over</option>
  </select>
</div>
              
              

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-date">Date</label>
                <select id="filter-date" name="date" class="filterbar-select" onchange="this.form.submit()">
                  {% for o in date_options %}
                    <option value="{{ o.value }}" {% if filter_date == o.value %}selected{% endif %}>{{ o.label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-sort">Sort by</label>
                <select id="filter-sort" name="sort" class="filterbar-select" aria-label="Sort by" onchange="this.form.submit()">
                  <option value="new" {% if filter_sort == 'new' %}selected{% endif %}>Newest</option>
                  <option value="old" {% if filter_sort == 'old' %}selected{% endif %}>Oldest</option>
                  <option value="most_over" {% if filter_sort in ['most_over', 'least_strict'] %}selected{% endif %}>Highest overage</option>
                  <option value="least_over" {% if filter_sort in ['least_over', 'most_strict'] %}selected{% endif %}>Lowest overage</option>
</select>
              </div>

              

<div class="filterbar-item filterbar-item--tight">
{% if is_admin %}
                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                  <label class="filterbar-label" for="filter-deleted-mode" style="margin:0;">Deleted (admin)</label>
                  <select id="filter-deleted-mode" name="deleted" class="filter-select" onchange="this.form.submit()" style="max-width:140px;">
                    <option value="hide" {% if (deleted_mode or 'hide') == 'hide' %}selected{% endif %}>Hide</option>
                    <option value="include" {% if deleted_mode == 'include' %}selected{% endif %}>Include</option>
                    <option value="only" {% if deleted_mode == 'only' %}selected{% endif %}>Only</option>
                  </select>
                </div>
                {% endif %}
              </div>

<div class="filterbox-footer">
                <a class="filterbar-clear {% if not filters_active %}is-disabled{% endif %}" href="{{ url_for('home', clear=1) }}">Clear</a>
              </div>

            </div>
          </div>

</form>
        </div>

        <div class="filters-footer">
          <div class="filters-footer-links">
          <a href="{{ url_for('privacy') }}">Privacy</a>
          <span class="dot">·</span>
          <a href="{{ url_for('terms') }}">Terms</a>
          <span class="dot">·</span>
          <a href="{{ url_for('cookies') }}">Cookie Policy</a>
        </div>
          <div class="filters-footer-meta">© 2025–2026 EnforcedSpeed™ · Developed by Conor Gordon · Mindra LLC</div>
        </div>
      </div>
    </aside>

    <script>
      // Multi-select dropdown behavior (speed limit + overage):
      // - Do NOT submit on each checkbox click (allows multi-select)
      // - Close on outside click or Done, keeping selections
      // - Submit when the dropdown closes if selections changed
      (function(){
        var form = document.getElementById("feedFilters");
        if(!form) return;

        function textOf(cb){
          return cb.getAttribute("data-label") || "";
        }

        function updateSummary(d){
          var summary = d.querySelector(".multi-summary");
          if(!summary) return;
          var checks = Array.prototype.slice.call(d.querySelectorAll("input[type=checkbox]"));
          var selected = checks.filter(function(c){ return c.checked; }).map(textOf).filter(Boolean);
          summary.textContent = selected.length ? selected.join(", ") : "Any";
        }

        function submitIfDirty(d){
          if(!d || !d._dirty) return;
          if(d._submitting) return;
          d._submitting = true;
          d._dirty = false;
          form.submit();
        }

        var multis = Array.prototype.slice.call(document.querySelectorAll("details[data-multi]"));
        multis.forEach(function(d){
          d._dirty = false;
          d._submitting = false;
          updateSummary(d);

          d.addEventListener("change", function(e){
            if(e.target && e.target.matches && e.target.matches("input[type=checkbox]")){
              d._dirty = true;
              updateSummary(d);
            }
          });

          var done = d.querySelector("[data-multi-done]");
          if(done){
            done.addEventListener("click", function(ev){
              ev.preventDefault();
              d.open = false;
              submitIfDirty(d);
            });
          }

          d.addEventListener("toggle", function(){
            if(!d.open){
              submitIfDirty(d);
            }
          });
        });

        document.addEventListener("click", function(e){
          multis.forEach(function(d){
            if(!d.open) return;
            if(d.contains(e.target)) return;
            d.open = false;
            submitIfDirty(d);
          });
        });
      })();
    </script>

    {# Main column: welcome tile + feed (unchanged) #}
    <div class="home-center">

      {# Mobile-only toggle button for the filter sidebar #}
      <button type="button" class="home-filters-toggle" id="homeFiltersToggle">Filters</button>

      {# --- Welcome tile (clickable CTA) --- #}
      {% set submit_url = url_for('submit') %}
      {% if current_user.is_authenticated %}
        {% set welcome_url = submit_url %}
      {% else %}
        {% set welcome_url = url_for('register', next=submit_url) %}
      {% endif %}

      <a class="card home-welcome-card home-welcome-link" href="{{ welcome_url }}" style="margin:0;">
  <div class="home-submit-plus-inner" aria-hidden="true">
    <div class="home-submit-plus-ring">
      <div class="home-submit-plus-sign"></div>
    </div>
  </div>
</a>

      {# Feed starts immediately below welcome card. #}

      {# Feed starts immediately below welcome card. #}

      {# Preserve active query params (used for infinite scroll + fallback pagination). #}
      {% set q = request.args.to_dict(flat=False) %}
      {% set _ = q.pop('page', None) %}
      {% set _ = q.pop('fragment', None) %}

      <div id="feed-items">
        {% set show_empty = True %}
        {% include '_feed_items.html' %}
      </div>

      <div id="feed-sentinel"
           data-base-url="{{ url_for('home', **q) }}"
           data-next-page="{{ pagination.next_num if pagination.has_next else '' }}"
           data-has-next="{{ '1' if pagination.has_next else '0' }}"
           style="height:1px;"></div>

      <div id="feed-loading" class="subtle feed-loading" style="display:none; margin-top:14px; text-align:center;"><span class="es-spinner" aria-hidden="true"></span><span>Loading…</span></div>
      <button id="feed-loadmore" type="button" style="display:none; width:100%; margin-top:14px;">Load more</button>
      <div id="feed-end" class="subtle feed-endcap" style="display:none; margin-top:14px; text-align:center;">No more posts.</div>

  {% if pagination.pages > 1 %}

    <div class="card ticket-card feed-pagination" style="margin-top:16px;">
      <div class="row" style="justify-content:space-between;gap:12px;">
        <div>
          {% if pagination.has_prev %}
            <a class="action-link" href="{{ url_for('home', page=pagination.prev_num, **q) }}">← Newer</a>
          {% endif %}
        </div>
        <div class="subtle">Page {{ pagination.page }} of {{ pagination.pages }}</div>
        <div>
          {% if pagination.has_next %}
            <a class="action-link" href="{{ url_for('home', page=pagination.next_num, **q) }}">Older →</a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

</div>

<style>

  /* Reuse the exact thank_you thermometer styling (scoped to this template). */
  .ticket-card{padding-top:18px;padding-bottom:18px;overflow:hidden}

  /* Infinite feed: hide fallback pager when JS is active. */
  html.es-infinite-feed .feed-pagination{display:none}

  .thermo-label{font-size:13px;font-weight:700;color:#374151}
  .thermo-line{display:flex;align-items:center;gap:10px}
  .thermo-bar{flex:1;height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden;position:relative}
  .thermo-fill{height:100%;background:#cbd5e1;border-radius:999px}
  .thermo-tick{position:absolute;top:0;bottom:0;width:2px;background:#9ca3af;opacity:.85;transform:translateX(-1px)}
  .thermo-tick.tick-90{left:90%;background:#111827;opacity:1}
  .thermo-value{min-width:54px;text-align:right;font-size:12px;font-weight:800;color:#111827}
  .thermo-p90{position:absolute;left:90%;top:-32px;transform:translateX(-50%);font-size:11px;font-weight:700;color:#111827;white-space:nowrap}

  .ticket-top{margin-top:-10px}
  .ticket-user{font-weight:400}
  .ticket-user .user-link{font-weight:500}
  .ticket-date{font-weight:400}
  /* Header layout: username on the left, OCR pill top-right aligned to username line. */
  .ticket-headwrap{display:block}
  .ticket-headrow{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .ticket-userline{display:flex;align-items:center;gap:8px}
  .ticket-avatar{width:22px;height:22px;border-radius:999px;object-fit:cover;display:block;background:#e5e7eb;flex:0 0 auto}
  .comment-userline{display:inline-flex;align-items:center;gap:6px}
  .comment-avatar{width:18px;height:18px;border-radius:999px;object-fit:cover;display:inline-block;background:#e5e7eb;vertical-align:middle}

  .ticket-usercount{font-size:13px;font-weight:600;color:#6b7280}
  .ticket-ocr{align-self:flex-start;margin-top:0;display:flex;justify-content:flex-end;align-items:center;gap:8px;flex-wrap:wrap}
  .ticket-info{border:1px solid #e5e7eb;background:#fff;border-radius:999px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:13px;line-height:1;cursor:pointer}
  .ticket-info:hover{background:#f9fafb}

  /* Under-username State/County/Road line */
  .ticket-state-link{color:inherit;text-decoration:none}
  .ticket-state-link:hover{text-decoration:underline}
  .ticket-county-link{color:inherit;text-decoration:none}
  .ticket-county-link:hover{text-decoration:underline}
  .ticket-submeta{margin-top:4px;font-size:12.5px;color:#6b7280;display:flex;gap:6px;flex-wrap:wrap}
  .ticket-submeta-count{font-weight:600;color:#4b5563;text-decoration:none}
  .ticket-submeta-count:hover{text-decoration:underline}
  .ticket-staticmap-link{display:block;width:100%;height:100%}
  .ticket-submeta-sep{opacity:.8}
  .user-link{text-decoration:none;color:inherit}
  .user-link:hover{text-decoration:underline}

  /* Static map (ticket card hero)
     FB-style: the *media block* (map + action row + optional caption) is square.
     The map itself becomes shorter to accommodate the footer.
  */
    /* FB-style square media frame:
     - The *frame* is square (matches FB post media).
     - The map image is allowed to be shorter inside the square (letterboxed) so it doesn't feel overly tall.
  */
  .ticket-staticmap-frame{
    margin-top:12px;
    border-radius:14px;
    overflow:hidden;
    border:1px solid #e5e7eb;
    background:#f3f4f6;
    aspect-ratio:1/1;
    position:relative;
  }

  .ticket-staticmap-frame .ticket-staticmap-wrap{
    margin-top:0;
    border:0;
    border-radius:0;
    width:100%;
    height:100%;
    background:transparent;
    position:relative;
    aspect-ratio:auto;
  }

  .ticket-staticmap-frame .ticket-staticmap{
    display:block;
    width:100%;
    height:100%;
    object-fit:contain;
    object-position:center center;
  }

.ticket-staticmap-wrap{width:100%;overflow:hidden;background:#f3f4f6;position:relative;}
  .ticket-caption--clamp{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}

  .ticket-speedpill{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:rgba(255,255,255,.95);border:1px solid #e5e7eb;border-radius:999px;padding:6px 12px;font-size:13px;font-weight:700;color:#111827;box-shadow:0 2px 8px rgba(0,0,0,.06);z-index:2;white-space:nowrap}
  .ticket-speedpill--pinmode{top:50%;left:50%;transform:translate(-50%,calc(-100% - 56px))}
  .ticket-speedpill-over{font-weight:700;color:#f97316;margin-left:8px}
  .ticket-pin-refine{position:absolute;left:12px;top:12px;z-index:2}

  /* Ticket card center (Version 5). */
  .ticket-center{margin-top:12px;text-align:center;position:relative}
  .ticket-roadstate{font-size:20px;font-weight:600;color:#111827;letter-spacing:.01em}
  /* Speed line: keep the "90 in a 65" centered, and place "+25 mph" in the center of the right-hand side. */
  .ticket-speedrow{margin-top:10px;display:flex;justify-content:center;align-items:baseline}
    .ticket-speedtext{font-size:18px;font-weight:600;color:#111827;display:flex;align-items:baseline;gap:10px}
  .ticket-speedin{font-weight:600;color:#111827}
  .ticket-overageblue{font-size:18px;font-weight:600;color:#2563eb;white-space:nowrap}
  .ticket-overageinline{font-size:14px;margin-left:8px;}
  /* Float the +mph BETWEEN road/state and speed line (center-right). */
  .ticket-overagefloat{position:absolute;top:36px;left: calc(70% + 14px);transform:translate(-50%,-50%);}
  /* Add a touch more whitespace above/below the EnforcedSpeed sentence. */
  .ticket-enforcedline{margin-top:30px;margin-bottom:30px;font-size:13.5px;font-weight:400;color:#374151;line-height:1.35}

  .ticket-actions{margin-top:0px;padding-top:0;border-top:0}
  /* Force "View all…" to match Like/Comment exactly (no local overrides). */
  .ticket-total .action-link{font-size:inherit;line-height:inherit;font-weight:inherit;text-align:right;display:inline}
  .ticket-total{flex:1;min-width:160px}

  /* v58 refinements */
  .ticket-card{padding-top:18px;padding-bottom:18px;overflow:hidden}
  .ticket-top{margin-top:-10px}
  .thermo-line{display:flex;align-items:center;gap:10px}
  .thermo-bar{flex:1}
  .thermo-value{position:static;font-size:12px;font-weight:800;color:#111827;min-width:52px;text-align:right}

</style>

<script>
  function membersOnly(id){
    var el=document.getElementById('mo-'+id);
    if(!el){return;}
    el.style.display='inline';
    setTimeout(function(){ el.style.display='none'; }, 900);
  }
  function toggleComment(id){
    var el=document.getElementById('commentbox-'+id);
    if(!el){return;}
    el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
  }
  function toggleReply(commentId){
    var el=document.getElementById('replybox-'+rootId);
    if(!el){return;}
    el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
  }

  // Open the reply box for a comment and (if empty) prefill an @mention.
  function openReplyWithMention(rootId, parentId, username){
    var box = document.getElementById('replybox-'+rootId);
    if(!box){return;}
    box.style.display = 'block';
    try{
      var pid = box.querySelector('input[name="parent_id"]');
      if(pid && parentId){ pid.value = parentId; }
    }catch(e){}
    try{
      var ta = box.querySelector('textarea[name="body"]');
      if(!ta){return;}
      var current = (ta.value || '').trim();
      if(!current && username){
        ta.value = '@' + username + ' ';
      }
      ta.focus();
      // Move cursor to end
      ta.selectionStart = ta.selectionEnd = ta.value.length;
    }catch(e){}
  }

  // --- Preserve scroll position across POST/redirect actions (Like / Comment / Delete) ---
  // The home feed posts back to the server and redirects to the same URL.
  // Without this, the browser returns to the top after the redirect.
  function esRememberScrollFromNode(node){
    try{
      var card = (node && node.closest) ? node.closest('.ticket-card') : null;
      if(card && card.id){ sessionStorage.setItem('es_home_restore_target', card.id); }
      sessionStorage.setItem('es_home_restore_y', String(window.scrollY || 0));
      sessionStorage.setItem('es_home_restore_ts', String(Date.now()));
    }catch(e){}
  }
  function esClearRememberedScroll(){
    try{
      sessionStorage.removeItem('es_home_restore_target');
      sessionStorage.removeItem('es_home_restore_y');
      sessionStorage.removeItem('es_home_restore_ts');
    }catch(e){}
  }
  function esBindPreserveScroll(root){
    try{
      var scope = root || document;
      var forms = scope.querySelectorAll('form.js-preserve-scroll');
      forms.forEach(function(f){
        try{
          if(f.dataset && f.dataset.esBound === '1') return;
          if(f.dataset) f.dataset.esBound = '1';
        }catch(e){}
        f.addEventListener('submit', function(){ esRememberScrollFromNode(f); }, {capture:true});
      });
    }catch(e){}
  }

  function esRestoreRememberedScroll(){
    try{
      var ts = parseInt(sessionStorage.getItem('es_home_restore_ts') || '0', 10);
      if(!ts) return;
      if(Date.now() - ts > 60000){ esClearRememberedScroll(); return; }
      var targetId = sessionStorage.getItem('es_home_restore_target');
      var y = parseInt(sessionStorage.getItem('es_home_restore_y') || '0', 10);
      esClearRememberedScroll();

      setTimeout(function(){
        try{
          if(targetId){
            var el = document.getElementById(targetId);
            if(el){ el.scrollIntoView({block:'center'}); return; }
          }
          if(!isNaN(y) && y > 0){ window.scrollTo(0, y); }
        }catch(e){}
      }, 50);
    }catch(e){}
  }

  // Enter submits, Shift+Enter adds a new line (comments + replies only)
  (function bindEnterToSubmit(){
    try{
      document.addEventListener('keydown', function(e){
        var t = e.target;
        if(!t) return;
        if(t.classList && t.classList.contains('js-comment-body')){
          if(e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            var form = t.closest('form');
            if(form){
              try{ esRememberScrollFromNode(t); }catch(e){}
              if(form.requestSubmit){ form.requestSubmit(); }
              else{ form.submit(); }
            }
          }
        }
      });
    }catch(e){}
  })();

  document.addEventListener('DOMContentLoaded', function(){
    try{ esBindPreserveScroll(); }catch(e){}
    try{ esRestoreRememberedScroll(); }catch(e){}
  });

  // Note: comment/reply boxes are closed by default on page load.
</script>

<script>
  function convertLocalTimes(){
    var nodes = document.querySelectorAll('.js-localtime[data-utc]');
    if(!nodes || nodes.length === 0) return;

    function formatLocal(d){
      try{
        return new Intl.DateTimeFormat(undefined, {
          month: 'short',
          day: '2-digit',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        }).format(d);
      }catch(e){
        return d.toLocaleString();
      }
    }

    nodes.forEach(function(el){
      var iso = el.getAttribute('data-utc');
      if(!iso) return;
      var d = new Date(iso);
      if(isNaN(d.getTime())) return;
      el.textContent = formatLocal(d);
    });
  }

  function toggleComments(reportId, totalCount){
    var link = document.getElementById('toggle-comments-' + reportId);
    if(!link) return false;
    var isExpanded = link.getAttribute('data-expanded') === '1';

    var card = link.closest('.card');
    if(!card) return false;

    var items = card.querySelectorAll('[id^="comment-"]');

    if(!isExpanded){
      items.forEach(function(el){ el.style.display = ''; });
      link.textContent = 'Collapse comments';
      link.setAttribute('data-expanded','1');
      try{ convertLocalTimes(); }catch(e){}
    }else{
      items.forEach(function(el){ el.style.display = 'none'; });
      var lbl = link.getAttribute('data-label');
      link.textContent = lbl ? lbl : ('View all ' + totalCount + ' comments');
      link.setAttribute('data-expanded','0');
    }
    return false;
  }

  

  // --- Mobile helpers (home) ---
  function initHomeFiltersToggle(){
    var btn = document.getElementById('homeFiltersToggle');
    var sidebar = document.getElementById('homeFiltersSidebar');
    if(!btn || !sidebar) return;

    function setCollapsed(v){
      if(v){ sidebar.classList.add('is-collapsed'); }
      else{ sidebar.classList.remove('is-collapsed'); }
    }

    try{
      if(window.matchMedia && window.matchMedia('(max-width: 980px)').matches){
        setCollapsed(true);
      }
    }catch(e){}

    btn.addEventListener('click', function(){
      sidebar.classList.toggle('is-collapsed');
    });
  }
document.addEventListener('DOMContentLoaded', function(){
    try{ convertLocalTimes(); }catch(e){}
    try{ initHomeFiltersToggle(); }catch(e){}
  });
</script>

<script>
  // --- Infinite feed (Home): load more posts as you scroll ---
  (function initInfiniteHomeFeed(){
    try{ document.documentElement.classList.add('es-infinite-feed'); }catch(e){}

    function qsJoin(base, extra){
      return base + (base.indexOf('?') >= 0 ? '&' : '?') + extra;
    }


// Lazy-load ticket static map images so initial home load is lighter.
(function(){
  var blank = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
  function initLazy(rootEl){
    rootEl = rootEl || document;
    var imgs = rootEl.querySelectorAll('img.ticket-staticmap[data-src]');
    if(!imgs || !imgs.length) return;
    if(!('IntersectionObserver' in window)){
      for(var i=0;i<imgs.length;i++){
        if(!imgs[i].getAttribute('src') || imgs[i].getAttribute('src')===blank){
          imgs[i].setAttribute('src', imgs[i].getAttribute('data-src'));
        }
      }
      return;
    }
    var io = window.__esMapLazyIO;
    if(!io){
      io = new IntersectionObserver(function(entries){
        for(var j=0;j<entries.length;j++){
          var e = entries[j];
          if(!e.isIntersecting) continue;
          var im = e.target;
          var ds = im.getAttribute('data-src');
          if(ds){
            im.setAttribute('src', ds);
            im.removeAttribute('data-src');
          }
          try{ io.unobserve(im); }catch(_e){}
        }
      }, { root:null, rootMargin:'800px 0px', threshold:0.01 });
      window.__esMapLazyIO = io;
    }
    for(var k=0;k<imgs.length;k++){
      try{ io.observe(imgs[k]); }catch(e){}
    }
  }
  window.esLazyLoadStaticMaps = initLazy;
  document.addEventListener('DOMContentLoaded', function(){ initLazy(document); });
})();

    async function fetchNext(nextPage, baseUrl){
      var url = qsJoin(baseUrl, 'page=' + encodeURIComponent(nextPage) + '&fragment=1');
      var resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if(!resp.ok){ throw new Error('HTTP ' + resp.status); }
      return await resp.json();
    }

    document.addEventListener('DOMContentLoaded', function(){
      var sentinel = document.getElementById('feed-sentinel');
      var container = document.getElementById('feed-items');
      var loadingEl = document.getElementById('feed-loading');
      var endEl = document.getElementById('feed-end');
      var btn = document.getElementById('feed-loadmore');
      if(!sentinel || !container) return;

      var baseUrl = sentinel.getAttribute('data-base-url') || '/';
      var nextPage = parseInt(sentinel.getAttribute('data-next-page') || '', 10);
      var hasNext = (sentinel.getAttribute('data-has-next') === '1') && !isNaN(nextPage);
      var loading = false;

// Persist feed position so refresh returns to the same spot (session/tab only).
var stateKey = 'es_feed_state:' + baseUrl;
var loadedPages = 1; // initial page already rendered server-side
function saveState(){
  try{
    var st = { y: window.scrollY || 0, pages: loadedPages, ts: Date.now() };
    sessionStorage.setItem(stateKey, JSON.stringify(st));
  }catch(e){}
}
// Throttle scroll saves.
var saveT = null;
window.addEventListener('scroll', function(){
  if(saveT) return;
  saveT = window.setTimeout(function(){ saveT=null; saveState(); }, 250);
}, { passive:true });
window.addEventListener('beforeunload', saveState);


      function setLoading(v){
        loading = v;
        if(loadingEl) loadingEl.style.display = v ? 'block' : 'none';
        if(btn) btn.disabled = !!v;
      }

      function setDone(){
        hasNext = false;
        if(endEl) endEl.style.display = 'block';
        if(btn) btn.style.display = 'none';
      }

      async function loadMore(){
        if(!hasNext || loading) return;
        setLoading(true);
        try{
          var data = await fetchNext(nextPage, baseUrl);
          var html = (data && data.html) ? String(data.html) : '';
          if(html.trim().length){
            var tmp = document.createElement('div');
            tmp.innerHTML = html;
            while(tmp.firstChild){ container.appendChild(tmp.firstChild); }
            loadedPages += 1;
            saveState();
            try{ if(window.esBindPreserveScroll){ window.esBindPreserveScroll(container); } }catch(e){}
            try{ if(window.convertLocalTimes){ window.convertLocalTimes(); } }catch(e){}
            try{ if(window.esLazyLoadStaticMaps){ window.esLazyLoadStaticMaps(container); } }catch(e){}
          }

          if(data && data.has_next && data.next_page){
            nextPage = parseInt(data.next_page, 10);
            if(isNaN(nextPage)){ setDone(); }
          }else{
            setDone();
          }
        }catch(e){
          // Fallback: show manual button if auto-load fails
          try{ if(btn){ btn.style.display = 'block'; } }catch(_e){}
        }finally{
          setLoading(false);
        }
      }

      if(!hasNext){ setDone(); return; }
function startAutoLoad(){
  // IntersectionObserver for auto-load; fallback to button for older browsers.
  if(!hasNext) return;
  if('IntersectionObserver' in window){
    var obs = new IntersectionObserver(function(entries){
      for(var i=0;i<entries.length;i++){
        if(entries[i].isIntersecting){ loadMore(); break; }
      }
    }, { root: null, rootMargin: '600px 0px', threshold: 0 });
    try{ obs.observe(sentinel); }catch(e){}
  }else{
    if(btn){ btn.style.display = 'block'; btn.addEventListener('click', loadMore); }
  }
}

// Restore saved scroll + loaded pages (if any) for this query.
(function restoreState(){
  var raw = null;
  try{ raw = sessionStorage.getItem(stateKey); }catch(e){}
  if(!raw){ startAutoLoad(); return; }
  var st = null;
  try{ st = JSON.parse(raw); }catch(e){ startAutoLoad(); return; }
  if(!st || !st.ts){ startAutoLoad(); return; }
  // Ignore very old state (2 hours) to avoid surprise jumps.
  if(Date.now() - st.ts > 2*60*60*1000){ startAutoLoad(); return; }

  var targetPages = parseInt(st.pages || 1, 10);
  if(isNaN(targetPages) || targetPages < 1) targetPages = 1;
  var targetY = parseInt(st.y || 0, 10);
  if(isNaN(targetY)) targetY = 0;

  if(targetPages === 1 && targetY === 0){ startAutoLoad(); return; }

  // Load additional pages sequentially until we reach prior depth or run out,
  // then scroll back to the saved position. Only after that do we enable auto-load.
  (async function(){
    while(hasNext && loadedPages < targetPages){
      await loadMore();
    }
    try{
      window.requestAnimationFrame(function(){
        window.scrollTo(0, targetY);
        saveState();
        startAutoLoad();
      });
    }catch(e){
      window.scrollTo(0, targetY);
      saveState();
      startAutoLoad();
    }
  })();
})();

    });
  })();
</script>

    </div> {# /home-center #}

    {# Right rail: static mini-map (trending counties). Click anywhere to open the full interactive map. #}
    <aside class="home-right" aria-label="Ticket map">
      {# Card 1: Static mini-map (no title; full-bleed image + tiny overlay link) #}
      <div class="rail-card" style="border-radius:0;">
        {% if maps_api_key %}
          <a href="{{ url_for('map_view') }}" style="display:block; position:relative; width:100%;">
            <div class="minimap-crop">
              <img src="{{ url_for('api_home_minimap_staticmap') }}" alt="Trending counties map">
            </div>
            <span class="subtle" style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.92); border:1px solid rgba(0,0,0,0.08); padding:4px 8px; border-radius:999px; font-size:12px; text-decoration:none;">Open full map</span>
          </a>
        {% else %}
          <div class="subtle" style="padding:12px 14px 14px;">Map not configured yet (missing GOOGLE_MAPS_API_KEY).</div>
        {% endif %}
      </div>

      {# Card 2: Trending + Followed (separate container, flush aligned) #}
      <div class="rail-card" style="border-radius:0;">

      {# Card 2: Trending + Followed (separate container, flush aligned) #}
      <div class="rail-card">
        <div class="rail-section">
  <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:8px;">
    <div style="display:flex; flex-direction:column; line-height:1.1;">
      <div style="font-weight:600;">Trending counties</div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <div style="display:flex; justify-content:flex-end; font-size:11px; color:#6b7280; gap:4px; padding:0 0;">
      <span style="width:24px; text-align:right;">7d</span>
      <span style="width:24px; text-align:right;">30d</span>
      <span style="width:24px; text-align:right;">1y</span>
      <span style="width:46px; text-align:right; line-height:1.05;"><span style="display:block; font-size:10px; font-weight:500; opacity:0.85;">Avg.</span><span style="display:block; font-size:11px; font-weight:600;">Overage</span></span>
    </div>

    {% if trending_counties and trending_counties|length > 0 %}
      <div style="margin-top:6px; display:flex; flex-direction:column; gap:8px;">
        {% for c in trending_counties %}
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <a href="{{ url_for('map_view', county=c.geoid) }}" class="subtle" style="flex:1; text-decoration:none; font-weight:500; white-space:normal; overflow:visible; text-overflow:clip; min-width:0; line-height:1.15;">
              {{ c.label }}, {{ c.st }}
            </a>

            <div style="display:flex; align-items:center; gap:4px; font-size:12px; font-variant-numeric:tabular-nums;">
              <span style="width:24px; text-align:right;">{{ c.c7 }}</span>
              <span style="width:24px; text-align:right;">{{ c.c30 }}</span>
              <span style="width:24px; text-align:right;">{{ c.c365 }}</span>
              <span style="width:46px; text-align:right;">{{ c.ovr }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="subtle" style="padding:6px 2px 2px;">Not enough data yet.</div>
    {% endif %}
  </div>

        </div>

        <div class="rail-section">
  <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:8px;">
    <div style="display:flex; flex-direction:column; line-height:1.1;">
      <div style="font-weight:600;">Counties you follow</div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <div style="display:flex; justify-content:flex-end; font-size:11px; color:#6b7280; gap:4px; padding:0 0;">
      <span style="width:24px; text-align:right;">7d</span>
      <span style="width:24px; text-align:right;">30d</span>
      <span style="width:24px; text-align:right;">1y</span>
      <span style="width:46px; text-align:right; line-height:1.05;"><span style="display:block; font-size:10px; font-weight:500; opacity:0.85;">Avg.</span><span style="display:block; font-size:11px; font-weight:600;">Overage</span></span>
    </div>

    {% if not current_user.is_authenticated %}
      <div class="subtle" style="margin-top:8px;">Log in to follow counties.</div>
    {% elif followed_counties and followed_counties|length > 0 %}
      <div style="margin-top:6px; display:flex; flex-direction:column; gap:8px;">
        {% for c in followed_counties %}
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <a href="{{ url_for('map_view', county=c.geoid) }}" class="subtle" style="flex:1; text-decoration:none; font-weight:500; white-space:normal; overflow:visible; text-overflow:clip; min-width:0; line-height:1.15;">
              {{ c.label }}, {{ c.st }}
            </a>

            <div style="display:flex; align-items:center; gap:4px; font-size:12px; font-variant-numeric:tabular-nums;">
              <span style="width:24px; text-align:right;">{{ c.c7 }}</span>
              <span style="width:24px; text-align:right;">{{ c.c30 }}</span>
              <span style="width:24px; text-align:right;">{{ c.c365 }}</span>
              <span style="width:46px; text-align:right;">{{ c.ovr }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="subtle" style="margin-top:8px;">You haven’t followed any counties yet.</div>
    {% endif %}
  </div>

        </div>
      </div>
    </aside>


</div> {# /home-shell #}

{# --- Ticket details modal (eye icon) --- #}
<div id="ticketInfoModal" class="modal" style="display:none;">
  <div class="modal-backdrop" id="ticketInfoBackdrop"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="ticketInfoTitle">
    <div class="modal-title" id="ticketInfoTitle">Ticket details</div>
    <div class="subtle" id="ticketInfoBody" style="margin-top:10px; white-space:pre-wrap;"></div>
    <div class="modal-actions">
      <button type="button" class="btn" id="ticketInfoClose">Close</button>
    </div>
  </div>
</div>

<script>
  (function(){
    const modal = document.getElementById('ticketInfoModal');
    if(!modal) return;
    const backdrop = document.getElementById('ticketInfoBackdrop');
    const closeBtn = document.getElementById('ticketInfoClose');
    const body = document.getElementById('ticketInfoBody');

    function close(){ modal.style.display='none'; }
    function open(text){
      body.textContent = text;
      modal.style.display='block';
    }

    backdrop && backdrop.addEventListener('click', close);
    closeBtn && closeBtn.addEventListener('click', close);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='block') close(); });

    document.addEventListener('click', function(e){
      const btn = e.target && e.target.closest ? e.target.closest('.ticket-info') : null;
      if(!btn) return;
      const photoKey = btn.getAttribute('data-photo-key') || '';
      const ocrStatus = btn.getAttribute('data-ocr-status') || '';
      const ocrError = btn.getAttribute('data-ocr-error') || '';
      const verStatus = btn.getAttribute('data-verification-status') || '';
      const attempts = btn.getAttribute('data-verify-attempts') || '';
      const reason = btn.getAttribute('data-verify-reason') || '';
      const posted = btn.getAttribute('data-posted-speed') || '';
      const ticketed = btn.getAttribute('data-ticketed-speed') || '';
      const overage = btn.getAttribute('data-overage') || '';

      const lines = [];
      lines.push(`Photo: ${photoKey ? 'uploaded' : 'none'}`);
      if(photoKey) lines.push(`Photo key: ${photoKey}`);
      if(posted !== '' || ticketed !== ''){
        let p = posted === '' ? null : parseInt(posted,10);
        let t = ticketed === '' ? null : parseInt(ticketed,10);
        if(p !== null && t !== null && t < p){ const tmp=p; p=t; t=tmp; }
        if(p !== null) lines.push(`Posted speed: ${p}`);
        if(t !== null) lines.push(`Ticketed speed: ${t}`);
        if(p !== null && t !== null) lines.push(`Overage: ${t - p}`);
        else if(overage !== '') lines.push(`Overage: ${overage}`);
      }
      lines.push(`OCR status: ${ocrStatus || 'n/a'}`);
      if(ocrError) lines.push(`OCR error: ${ocrError}`);
      lines.push(`Verification: ${verStatus || 'n/a'}`);
      if(attempts !== '') lines.push(`Verify attempts: ${attempts}`);
      if(reason) lines.push(`Verify reason: ${reason}`);

      open(lines.join('\n'));
    });
  })();
</script>

{# --- Owner-only pin refine modal (feed) --- #}
{% if current_user.is_authenticated and maps_api_key %}
<div id="feedPinModal" class="modal" style="display:none;">
  <div class="modal-backdrop" id="feedPinBackdrop"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="feedPinTitle">
    <div class="modal-title" id="feedPinTitle">Refine pin</div>
    <div class="subtle" style="margin-top:6px;">
      Drag the pin to the closest spot on the road. We'll snap it to the nearest road line.
    </div>
    <div id="feedPinMap" style="width:100%; height:360px; margin-top:12px; border:1px solid #e5e7eb; border-radius:12px;"></div>
    <div class="subtle" id="feedPinStatus" style="margin-top:10px; display:none;"></div>
    <div class="modal-actions">
      <button type="button" class="btn btn-ghost" id="feedPinCancel">Cancel</button>
      <button type="button" class="btn" id="feedPinSave">Save pin</button>
    </div>
  </div>
</div>
{% endif %}

{% if current_user.is_authenticated and maps_api_key %}
<script>
  (function(){
    const modal = document.getElementById('feedPinModal');
    if(!modal) return;

    const backdrop = document.getElementById('feedPinBackdrop');
    const btnCancel = document.getElementById('feedPinCancel');
    const btnSave = document.getElementById('feedPinSave');
    const statusEl = document.getElementById('feedPinStatus');
    const mapEl = document.getElementById('feedPinMap');

    let activeReportId = null;
    let map = null;
    let marker = null;

    function showStatus(msg){
      if(!statusEl) return;
      statusEl.textContent = msg;
      statusEl.style.display = 'block';
    }
    function clearStatus(){
      if(!statusEl) return;
      statusEl.textContent = '';
      statusEl.style.display = 'none';
    }

    function close(){
      modal.style.display = 'none';
      activeReportId = null;
      clearStatus();
    }

    function ensureGoogleMaps(cb){
      if(window.google && google.maps){ cb(); return; }
      if(window.__esFeedMapsLoading){
        window.__esFeedMapsCallbacks.push(cb);
        return;
      }
      window.__esFeedMapsLoading = true;
      window.__esFeedMapsCallbacks = [cb];
      const s = document.createElement('script');
      s.src = "https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}";
      s.async = true;
      s.defer = true;
      s.onload = function(){
        const cbs = window.__esFeedMapsCallbacks || [];
        window.__esFeedMapsCallbacks = [];
        cbs.forEach(fn => { try{ fn(); }catch(e){} });
      };
      document.head.appendChild(s);
    }

    function open(reportId, lat, lng){
      activeReportId = reportId;
      modal.style.display = 'block';
      clearStatus();

      ensureGoogleMaps(function(){
        const center = { lat: lat, lng: lng };
        if(!map){
          map = new google.maps.Map(mapEl, {
            center: center,
            zoom: 16,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
          });
          marker = new google.maps.Marker({ position: center, map: map, draggable: true });
          map.addListener('click', function(e){
            if(!e || !e.latLng) return;
            marker.setPosition(e.latLng);
          });
        }else{
          map.setCenter(center);
          map.setZoom(16);
          marker.setPosition(center);
        }
      });
    }

    function bindTriggers(){
      document.querySelectorAll('.ticket-pin-refine').forEach(btn => {
        btn.addEventListener('click', function(){
          const rid = parseInt(btn.getAttribute('data-report-id') || '0', 10);
          const lat = parseFloat(btn.getAttribute('data-lat') || '0');
          const lng = parseFloat(btn.getAttribute('data-lng') || '0');
          if(!rid || !lat || !lng) return;
          open(rid, lat, lng);
        });
      });
    }

    async function save(){
      if(!activeReportId || !marker) return;
      const pos = marker.getPosition();
      const lat = pos.lat();
      const lng = pos.lng();
      btnSave.disabled = true;
      try{
        const res = await fetch('/api/update_ticket_pin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ report_id: activeReportId, lat: lat, lng: lng })
        });
        const data = await res.json().catch(()=>({}));
        if(res.ok && data
<script>
  (function(){
    const KEY = "es_clickwrap_v1";
    function hasAccepted(){
      try { return window.localStorage && localStorage.getItem(KEY) === "1"; } catch(e) {}
      // cookie fallback
      return document.cookie.split(";").some(v => v.trim().startsWith(KEY + "=1"));
    }
    function setAccepted(){
      try { if (window.localStorage) localStorage.setItem(KEY, "1"); } catch(e) {}
      // 180-day cookie fallback
      try { document.cookie = KEY + "=1; Max-Age=" + (60*60*24*180) + "; Path=/; SameSite=Lax"; } catch(e) {}
    }
    function show(){
      const wrap = document.getElementById("es-clickwrap");
      if(!wrap) return;
      wrap.setAttribute("aria-hidden","false");
      wrap.classList.add("is-open");
      document.body.classList.add("es-modal-open");
    }
    function hide(){
      const wrap = document.getElementById("es-clickwrap");
      if(!wrap) return;
      wrap.setAttribute("aria-hidden","true");
      wrap.classList.remove("is-open");
      document.body.classList.remove("es-modal-open");
    }

    document.addEventListener("DOMContentLoaded", function(){
      const wrap = document.getElementById("es-clickwrap");
      if(!wrap) return;

      if(!hasAccepted()){
        show();
      }

      const cb = document.getElementById("es-clickwrap-check");
      const btn = document.getElementById("es-clickwrap-continue");
      if(cb && btn){
        const sync = () => { btn.disabled = !cb.checked; };
        cb.addEventListener("change", sync);
        sync();
        btn.addEventListener("click", function(){
          if(!cb.checked) return;
          setAccepted();
          hide();
        });
      }
    });
  })();
</script>
 && data.ok){
          showStatus(data.snapped ? 'Saved. Pin snapped to nearest road.' : 'Saved.');
          // Reload to refresh static map image + any downstream aggregates.
          setTimeout(()=>{ window.location.reload(); }, 450);
        }else{
          showStatus('Could not save pin. Please try again.');
          btnSave.disabled = false;
        }
      }catch(e){
        showStatus('Could not save pin. Please try again.');
        btnSave.disabled = false;
      }
    }

    if(backdrop) backdrop.addEventListener('click', close);
    if(btnCancel) btnCancel.addEventListener('click', close);
    if(btnSave) btnSave.addEventListener('click', save);

    bindTriggers();
  })();
</script>
{% endif %}
{% endblock %}
