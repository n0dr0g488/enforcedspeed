<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EnforcedSpeed</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7f9; }
      .wrap { max-width: 720px; margin: 40px auto; padding: 0 16px; }
      .card { background: #fff; border-radius: 14px; padding: 20px; box-shadow: 0 8px 26px rgba(0,0,0,.08); }
      h1 { margin: 0; font-size: 28px; text-align: center; }
      p { margin: 10px 0 18px; color: #444; line-height: 1.45; text-align: center; }
      label { display: block; margin: 14px 0 6px; font-weight: 600; }
      input { width: 100%; box-sizing: border-box; padding: 12px 12px; border: 1px solid #d6d9dd; border-radius: 10px; font-size: 15px; color: #111827; background: #fff; }
      input::placeholder { color: #9ca3af; }
      .btn { display: inline-block; width: 100%; margin-top: 16px; padding: 12px 14px; border: 0; border-radius: 12px; background: #111827; color: #fff; font-weight: 800; cursor: pointer; font-size: 16px; }
      .btn:hover { opacity: .92; }
      .errors { margin: 14px 0 0; padding: 12px; border-radius: 12px; background: #fff1f2; border: 1px solid #fecdd3; color: #991b1b; }
      .footer { margin-top: 18px; text-align: center; color: #6b7280; font-size: 12px; }
      .subtle { color: #6b7280; font-size: 12px; }
      .right { text-align: right; }

      .preview {
        margin-top: 10px;
        padding: 12px;
        border: 1px solid #e6e8eb;
        border-radius: 12px;
        background: #fafafa;
      }
      .preview .row { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: #111827;
        color: #fff;
        font-size: 12px;
        font-weight: 800;
      }

      .blocks {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 16px;
      }
      .block {
        background: #fafafa;
        border: 1px solid #e6e8eb;
        border-radius: 12px;
        padding: 12px;
      }
      .block ol {
        margin: 8px 0 0 18px;
        padding: 0;
        color: #444;
      }
      .block li { margin-bottom: 10px; }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3730a3;
        font-size: 12px;
        font-weight: 700;
        margin-right: 6px;
      }

      @media (max-width: 600px) {
        .blocks { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <h1>Enforced Speed</h1>
        <p>Received a speeding ticket? Submit your details to see how you compare.</p>

        <p class="subtle" style="margin-top:-10px;">
          {% if current_user.is_authenticated %}
            Logged in as <strong>@{{ current_user.username }}</strong> ·
             <a href="{{ url_for('profile', username=current_user.username) }}">My profile</a> ·
             <a href="{{ url_for('logout') }}">Log out</a>
          {% else %}
            <a href="{{ url_for('login') }}">Log in</a> ·
            <a href="{{ url_for('register') }}">Create account</a> <span class="subtle">(Log in to hide anonymous and see member-only data)</span>
          {% endif %}
</p>


        {% if form.errors %}
          <div class="errors">
            <strong>Fix these:</strong>
            <ul>
              {% for field, errs in form.errors.items() %}
                {% for err in errs %}
                  <li>{{ err }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <form method="post" action="{{ url_for('submit_ticket') }}" id="ticketForm">
          {{ form.hidden_tag() }}

          <label for="state">{{ form.state.label.text }}</label>
          {{ form.state(id="state", list="state_list") }}
          <datalist id="state_list">
            {% for s in state_options %}
              <option value="{{ s }}"></option>
            {% endfor %}
          </datalist>

          <label for="road_name">{{ form.road_name.label.text }}</label>
          {{ form.road_name(id="road_name") }}

          <div class="preview" id="roadPreview" style="display:none;">
            <div class="row">
              <div class="subtle">Road bucket preview</div>
              <div class="badge" id="bucketKeyBadge"></div>
            </div>
            <div class="subtle" id="bucketHint" style="margin-top:8px;"></div>
            <div class="subtle" id="bucketAmbiguity" style="margin-top:10px;"></div>
          </div>

          <label for="posted_speed">{{ form.posted_speed.label.text }}</label>
          {{ form.posted_speed(id="posted_speed", type="text", inputmode="numeric", autocomplete="off", spellcheck="false") }}

          <label for="ticketed_speed">{{ form.ticketed_speed.label.text }}</label>
          {{ form.ticketed_speed(id="ticketed_speed", type="text", inputmode="numeric", autocomplete="off", spellcheck="false") }}<div class="subtle" style="margin: 6px 0 10px 0;">
            {% if hide_anon %}
              Viewing: <strong id="viewingMode">Members only</strong> · <a href="{{ url_for('home') }}">Show anonymous too</a>
            {% else %}
              Viewing: <strong id="viewingMode">All posts</strong> · {% if current_user.is_authenticated %}
              <a href="{{ url_for('home', hide_anon=1) }}">Hide anonymous</a>
            {% else %}
              <a href="#" id="hideAnonLink" onclick="
                var vm=document.getElementById('viewingMode');
                var old=vm.innerText;
                vm.innerText='Members only';
                var msg=document.getElementById('loginRequiredMsg');
                if(msg){msg.style.display='inline';}
                setTimeout(function(){ vm.innerText=old; }, 700);
                return false;
              ">Hide anonymous</a>
              <span id="loginRequiredMsg" class="subtle" style="display:none; margin-left:8px;">You must be logged in to hide anonymous posts.</span>
            {% endif %}
            {% endif %}
          </div>
<div class="blocks">
            <div class="block">
              <strong>Most Strict</strong>
              <ol>
                {% for r in most_strict %}
                  <li>
                    <span class="pill">{{ r.state }}</span>
                    <span class="pill">{{ format_road_bucket(r.road) }}</span>
                    {% if r.member_pct == 0 %}<span class="pill">100% anonymous data</span>{% else %}<span class="pill">{{ r.member_pct }}% member data</span>{% endif %}<br>
                     +{{ '%.1f'|format(r.median_overage) }} mph <a href="{{ url_for('bucket_tickets', state=r.state, road=r.road) }}">(tickets: {{ r.tickets }})</a>
                  </li>
                {% endfor %}
              </ol>

              <div class="subtle right" style="margin-top: 6px;">
                {% if hide_anon %}
                  <a href="{{ url_for('strictness', hide_anon=1) }}">more</a>
                {% else %}
                  <a href="{{ url_for('strictness') }}">more</a>
                {% endif %}
              </div>
            </div>

            <div class="block">
              <strong>Least Strict</strong>
              <ol>
                {% for r in least_strict %}
                  <li>
                    <span class="pill">{{ r.state }}</span>
                    <span class="pill">{{ format_road_bucket(r.road) }}</span>
                    {% if r.member_pct == 0 %}<span class="pill">100% anonymous data</span>{% else %}<span class="pill">{{ r.member_pct }}% member data</span>{% endif %}<br>
                     +{{ '%.1f'|format(r.median_overage) }} mph <a href="{{ url_for('bucket_tickets', state=r.state, road=r.road) }}">(tickets: {{ r.tickets }})</a>
                  </li>
                {% endfor %}
              </ol>

              <div class="subtle right" style="margin-top: 6px;">
                {% if hide_anon %}
                  <a href="{{ url_for('strictness', hide_anon=1) }}">more</a>
                {% else %}
                  <a href="{{ url_for('strictness') }}">more</a>
                {% endif %}
              </div>
            </div>
          </div>
{{ form.submit(class_="btn") }}

          <div class="subtle right" style="margin-top: 8px;">
            Total tickets submitted: <strong>{{ ticket_count }}</strong>
          </div>
        </form>
      </div>

      <div class="footer">
        © 2025 EnforcedSpeed · Developed by Conor Gordon · Gordon Capital Holdings LLC
      </div>
    </div>

    <script>
      const stateEl = document.getElementById("state");
      const roadEl = document.getElementById("road_name");
      const previewEl = document.getElementById("roadPreview");
      const badgeEl = document.getElementById("bucketKeyBadge");
      const hintEl = document.getElementById("bucketHint");
      const ambEl = document.getElementById("bucketAmbiguity");

      const postedEl = document.getElementById("posted_speed");
      const ticketedEl = document.getElementById("ticketed_speed");
      const formEl = document.getElementById("ticketForm");

      let t = null;

      async function refreshPreview() {
        const state = (stateEl.value || "").trim();
        const road = (roadEl.value || "").trim();

        if (!road) {
          previewEl.style.display = "none";
          return;
        }

        const params = new URLSearchParams({ state, road });
        const res = await fetch(`/api/road_preview?${params.toString()}`);
        const data = await res.json();

        if (!data.predicted_road_key) {
          previewEl.style.display = "none";
          return;
        }

        previewEl.style.display = "block";
        badgeEl.textContent = data.predicted_road_label || data.predicted_road_key;

        if (data.suggestions && data.suggestions.length) {
          const labels = data.suggestions.map(s => s.label || s.key);
          hintEl.textContent = `Similar buckets seen: ${labels.join(", ")}`;
        } else {
          hintEl.textContent = "";
        }

        ambEl.innerHTML = "";
        if (data.ambiguity_options && data.ambiguity_options.length) {
          const btns = data.ambiguity_options
            .map(opt =>
              `<button type="button" data-opt="${opt}"
                style="margin-right:8px; padding:6px 10px; border-radius:999px; border:1px solid #d1d5db; background:#fff; cursor:pointer; font-weight:700;">
                ${opt}
              </button>`
            )
            .join("");

          ambEl.innerHTML = `Did you mean: ${btns}`;

          ambEl.querySelectorAll("button[data-opt]").forEach(b => {
            b.addEventListener("click", () => {
              roadEl.value = b.getAttribute("data-opt") || roadEl.value;
              refreshPreview();
            });
          });
        }
      }

      function schedulePreview() {
        if (t) clearTimeout(t);
        t = setTimeout(refreshPreview, 200);
      }

      // Visual formatting (safe because inputs are type="text")
      function stripToNumeric(str) {
        return (str || "").replace(/[^\d.]/g, "");
      }

      function applyMph(el) {
        const v = stripToNumeric(el.value);
        if (v) el.value = `${v} mph`;
      }

      function applyDollar(el) {
        const v = stripToNumeric(el.value);
        if (v) el.value = `$${v}`;
      }

      function stripField(el) {
        el.value = stripToNumeric(el.value);
      }

      postedEl.addEventListener("blur", () => applyMph(postedEl));
      ticketedEl.addEventListener("blur", () => applyMph(ticketedEl));

      [postedEl, ticketedEl].forEach(el => {
        el.addEventListener("focus", () => stripField(el));
      });

      // Before submit: strip formatting so Flask validators receive clean numbers
      formEl.addEventListener("submit", () => {
        stripField(postedEl);
        stripField(ticketedEl);
      });

      stateEl.addEventListener("input", schedulePreview);
      roadEl.addEventListener("input", schedulePreview);
    </script>
  </body>
</html>
