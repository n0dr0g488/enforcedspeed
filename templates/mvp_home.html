{% extends "base.html" %}
{% block content %}

    <div class="wrap">
      <div class="card">

        <p>Received a speeding ticket? Submit your details to see how you compare.</p>



        {% if form.errors %}
          <div class="errors">
            <strong>Fix these:</strong>
            <ul>
              {% for field, errs in form.errors.items() %}
                {% for err in errs %}
                  <li>{{ err }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <form method="post" action="{{ url_for('submit_ticket') }}" id="ticketForm" enctype="multipart/form-data">
          {{ form.hidden_tag() }}

          <label for="state">{{ form.state.label.text }}</label>
          {{ form.state(id="state", list="state_list") }}
          <datalist id="state_list">
            {% for s in state_options %}
              <option value="{{ s }}"></option>
            {% endfor %}
          </datalist>

          <label for="road_name">{{ form.road_name.label.text }}</label>
          {{ form.road_name(id="road_name") }}

          <div class="preview" id="roadPreview" style="display:none;">
            <div class="row">
              <div class="subtle">Road bucket preview</div>
              <div class="badge" id="bucketKeyBadge"></div>
            </div>
            <div class="subtle" id="bucketHint" style="margin-top:8px;"></div>
            <div class="subtle" id="bucketAmbiguity" style="margin-top:10px;"></div>
          </div>

          <label for="posted_speed">{{ form.posted_speed.label.text }}</label>
          {{ form.posted_speed(id="posted_speed", type="text", inputmode="numeric", autocomplete="off", spellcheck="false") }}

          <label for="ticketed_speed">{{ form.ticketed_speed.label.text }}</label>
          {{ form.ticketed_speed(id="ticketed_speed", type="text", inputmode="numeric", autocomplete="off", spellcheck="false") }}

          <label for="photo">Photo (optional for OCR ticket verification)</label>
          <div class="photo-field">
            {{ form.photo(id="photo", accept="image/jpeg,image/png") }}
            <div class="subtle" id="photoHint" style="margin-top:6px;">
              JPG/JPEG or PNG only for now. iPhone HEIC is not supported yet.
            </div>
            <div class="subtle" style="margin-top:4px;">
              Photo privacy: Uploaded photos are used only to attempt OCR verification and are automatically deleted shortly after processing (and always within 24 hours).
            </div>
            <div class="subtle" id="photoSelected" style="margin-top:4px;"></div>
          </div>

          <div class="blocks">
            <div class="block">
              <strong>Most Strict</strong>
              <ol>
                {% for r in most_strict %}
                  <li>
                    <span class="pill">{{ r.state }}</span>
                    <span class="pill">{{ format_road_bucket(r.road) }}</span>
	                    <br>
                     +{{ '%.1f'|format(r.median_overage) }} mph <a href="{{ url_for('bucket_tickets', state=r.state, road=r.road) }}">(tickets: {{ r.tickets }})</a>
                  </li>
                {% endfor %}
              </ol>

              <div class="subtle right" style="margin-top: 6px;">
                {% if hide_anon %}
                  <a href="{{ url_for('strictness', hide_anon=1) }}">more</a>
                {% else %}
                  <a href="{{ url_for('strictness') }}">more</a>
                {% endif %}
              </div>
            </div>

            <div class="block">
              <strong>Least Strict</strong>
              <ol>
                {% for r in least_strict %}
                  <li>
                    <span class="pill">{{ r.state }}</span>
                    <span class="pill">{{ format_road_bucket(r.road) }}</span>
	                    <br>
                     +{{ '%.1f'|format(r.median_overage) }} mph <a href="{{ url_for('bucket_tickets', state=r.state, road=r.road) }}">(tickets: {{ r.tickets }})</a>
                  </li>
                {% endfor %}
              </ol>

              <div class="subtle right" style="margin-top: 6px;">
                {% if hide_anon %}
                  <a href="{{ url_for('strictness', hide_anon=1) }}">more</a>
                {% else %}
                  <a href="{{ url_for('strictness') }}">more</a>
                {% endif %}
              </div>
            </div>
          </div>
          {{ form.submit(class_="btn") }}

          <div class="subtle right" style="margin-top: 8px;">
            Total tickets submitted: <strong>{{ ticket_count }}</strong>
          </div>
        </form>
      </div>
    </div>

    <script>
      const stateEl = document.getElementById("state");
      const roadEl = document.getElementById("road_name");
      const previewEl = document.getElementById("roadPreview");
      const badgeEl = document.getElementById("bucketKeyBadge");
      const hintEl = document.getElementById("bucketHint");
      const ambEl = document.getElementById("bucketAmbiguity");

      const postedEl = document.getElementById("posted_speed");
      const ticketedEl = document.getElementById("ticketed_speed");
      const formEl = document.getElementById("ticketForm");

      const photoEl = document.getElementById("photo");
      const photoSelectedEl = document.getElementById("photoSelected");
      const allowedPhotoExts = ["jpg", "jpeg", "png"];

      let t = null;

      async function refreshPreview() {
        const state = (stateEl.value || "").trim();
        const road = (roadEl.value || "").trim();

        if (!road) {
          previewEl.style.display = "none";
          return;
        }

        const params = new URLSearchParams({ state, road });
        const res = await fetch(`/api/road_preview?${params.toString()}`);
        const data = await res.json();

        if (!data.predicted_road_key) {
          previewEl.style.display = "none";
          return;
        }

        previewEl.style.display = "block";
        badgeEl.textContent = data.predicted_road_label || data.predicted_road_key;

        if (data.suggestions && data.suggestions.length) {
          const labels = data.suggestions.map(s => s.label || s.key);
          hintEl.textContent = `Similar buckets seen: ${labels.join(", ")}`;
        } else {
          hintEl.textContent = "";
        }

        ambEl.innerHTML = "";
        if (data.ambiguity_options && data.ambiguity_options.length) {
          const btns = data.ambiguity_options
            .map(opt =>
              `<button type="button" data-opt="${opt}"
                style="margin-right:8px; padding:6px 10px; border-radius:999px; border:1px solid #d1d5db; background:#fff; cursor:pointer; font-weight:700;">
                ${opt}
              </button>`
            )
            .join("");

          ambEl.innerHTML = `Did you mean: ${btns}`;

          ambEl.querySelectorAll("button[data-opt]").forEach(b => {
            b.addEventListener("click", () => {
              roadEl.value = b.getAttribute("data-opt") || roadEl.value;
              refreshPreview();
            });
          });
        }
      }

      function schedulePreview() {
        if (t) clearTimeout(t);
        t = setTimeout(refreshPreview, 200);
      }

      // Visual formatting (safe because inputs are type="text")
      function stripToNumeric(str) {
        return (str || "").replace(/[^\d.]/g, "");
      }

      function applyMph(el) {
        const v = stripToNumeric(el.value);
        if (v) el.value = `${v} mph`;
      }

      function applyDollar(el) {
        const v = stripToNumeric(el.value);
        if (v) el.value = `$${v}`;
      }

      function stripField(el) {
        el.value = stripToNumeric(el.value);
      }

      postedEl.addEventListener("blur", () => applyMph(postedEl));
      ticketedEl.addEventListener("blur", () => applyMph(ticketedEl));

      [postedEl, ticketedEl].forEach(el => {
        el.addEventListener("focus", () => stripField(el));
      });

      // Before submit: strip formatting so Flask validators receive clean numbers
      formEl.addEventListener("submit", (e) => {
        stripField(postedEl);
        stripField(ticketedEl);

        // Client-side guard to prevent confusing "grey/no photo" results.
        // Server still validates, this just gives immediate feedback.
        if (photoEl && photoEl.files && photoEl.files.length) {
          const name = (photoEl.files[0].name || "").toLowerCase();
          const ext = name.includes(".") ? name.split(".").pop() : "";
          if (!allowedPhotoExts.includes(ext)) {
            e.preventDefault();
            alert(`Unsupported photo format: .${ext || "?"}. Please upload JPG/JPEG or PNG (iPhone HEIC not supported yet).`);
          }
        }
      });

      if (photoEl) {
        photoEl.addEventListener("change", () => {
          if (!photoSelectedEl) return;
          if (!photoEl.files || !photoEl.files.length) {
            photoSelectedEl.textContent = "";
            return;
          }
          const f = photoEl.files[0];
          const name = f.name || "(selected)";
          photoSelectedEl.textContent = `Selected: ${name}`;
        });
      }

      stateEl.addEventListener("input", schedulePreview);
      roadEl.addEventListener("input", schedulePreview);
    </script>
{% endblock %}
