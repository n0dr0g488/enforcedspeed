{% extends "base.html" %}
{% block content %}

<div class="home-shell">

    {# Left sidebar: sticky filters (desktop). Collapses behind button on mobile. #}
    <aside class="home-left" id="homeFiltersSidebar">
      <div class="filters-rail">
        <form method="get" action="{{ url_for('home') }}" class="filterbar" id="feedFilters">
          <div class="filterbox">
            <div class="filterbox-title">Filter Speeding Tickets</div>
            <div class="filterbox-section">Location</div>

            <div class="filterbar-row filterbar-row--stack">

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-state">State</label>
                <select id="filter-state" name="state" class="filterbar-select" onchange="this.form.submit()">
                  <option value="" {% if not filter_state %}selected{% endif %}>All states</option>
                  {% for opt in state_filter_options %}
                    <option value="{{ opt.code }}" {% if filter_state == opt.code %}selected{% endif %}>{{ opt.code }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-road">Road</label>
                <input id="filter-road" name="road" class="filterbar-input" type="text" value="{{ filter_road or '' }}" placeholder="I-95, US-1, SR-520" autocomplete="off" list="road_suggestions">
                <datalist id="road_suggestions">
                  {% for s in road_suggestions %}
                    <option value="{{ s }}"></option>
                  {% endfor %}
                </datalist>
              </div>

              <div class="filterbox-section">Enforcement</div>

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-speed-limit">Posted speed limit</label>
                {% set ssel = [] %}
                {% for b in speed_limit_buckets %}
                  {% if b.value in filter_speed_limit_list and b.value != 'any' %}
                    {% set _ = ssel.append(b.label) %}
                  {% endif %}
                {% endfor %}

                <details class="multi" data-multi>
                  <summary class="multi-summary">
                    {% if ssel|length == 0 %}Any{% else %}{{ ssel|join(', ') }}{% endif %}
                  </summary>
                  <div class="multi-panel">
                    {% for b in speed_limit_buckets %}
                      {% if b.value != 'any' %}
                        {% set _id = 'sl-' ~ b.value %}
                        <label class="multi-opt">
                          <input type="checkbox" id="{{ _id }}" name="speed_limit" value="{{ b.value }}" data-label="{{ b.label }}" {% if b.value in filter_speed_limit_list %}checked{% endif %}>
                          <span>{{ b.label }}</span>
                        </label>
                      {% endif %}
                    {% endfor %}
                    <button type="button" class="multi-done" data-multi-done>Done</button>
                  </div>
                </details>
              </div>

              <div class="filterbar-item">
                <label class="filterbar-label">Overage (mph over)</label>
                {# Compact multi-select dropdown (no big chip grid). #}
                {% set sel = [] %}
                {% for b in over_buckets %}
                  {% if b.value in filter_over_list %}
                    {% set _ = sel.append(b.label) %}
                  {% endif %}
                {% endfor %}

                <details class="multi" data-multi>
                  <summary class="multi-summary">
                    {% if sel|length == 0 %}Any{% else %}{{ sel|join(', ') }}{% endif %}
                  </summary>
                  <div class="multi-panel">
                    {% for b in over_buckets %}
                      {% if b.value != 'all' %}
                        {% set _id = 'ov-' ~ b.value %}
                        <label class="multi-opt">
                          <input type="checkbox" id="{{ _id }}" name="overage" value="{{ b.value }}" data-label="{{ b.label }}" {% if b.value in filter_over_list %}checked{% endif %}>
                          <span>{{ b.label }}</span>
                        </label>
                      {% endif %}
                    {% endfor %}
                    <button type="button" class="multi-done" data-multi-done>Done</button>
                  </div>
                </details>
              </div>

              <div class="filterbox-section">Evidence</div>

              <div class="filterbar-item filterbar-item--tight">
                <div class="filterbar-rowline filterbar-rowline--tight">
                  <label class="filterbar-label" for="filter-photo-only" style="margin:0;">Photo submitted</label>
                  <label class="switch">
                    <input type="checkbox" id="filter-photo-only" name="photo_only" value="1" {% if filter_photo_only %}checked{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>

                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                  <label class="filterbar-label" for="filter-verify" style="margin:0;">Auto-Extracted</label>
                  <label class="switch">
                    <input type="checkbox" id="filter-verify" name="verify" value="verified" {% if filter_verify == 'verified' %}checked{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>

              <div class="filterbox-section">Visibility</div>

              <div class="filterbar-item filterbar-item--tight">
                <div class="filterbar-rowline filterbar-rowline--tight">
                  <label class="filterbar-label" for="filter-hide-anon" style="margin:0;">Hide anonymous{% if not current_user.is_authenticated %} <span class="filter-inline-note">(must log in)</span>{% endif %}</label>
                  <label class="switch">
                    <input type="checkbox" id="filter-hide-anon" name="hide_anon" value="1" {% if hide_anon %}checked{% endif %} {% if not current_user.is_authenticated %}disabled{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>
{% if is_admin %}
                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:8px;">
                  <label class="filterbar-label" for="filter-deleted-mode" style="margin:0;">Deleted (admin)</label>
                  <select id="filter-deleted-mode" name="deleted" class="filter-select" onchange="this.form.submit()" style="max-width:140px;">
                    <option value="hide" {% if (deleted_mode or 'hide') == 'hide' %}selected{% endif %}>Hide</option>
                    <option value="include" {% if deleted_mode == 'include' %}selected{% endif %}>Include</option>
                    <option value="only" {% if deleted_mode == 'only' %}selected{% endif %}>Only</option>
                  </select>
                </div>
                {% endif %}
              </div>

              <div class="filterbox-section">Date</div>

              <div class="filterbar-item">
                <select id="filter-date" name="date" class="filterbar-select" onchange="this.form.submit()">
                  {% for o in date_options %}
                    <option value="{{ o.value }}" {% if filter_date == o.value %}selected{% endif %}>{{ o.label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="filterbox-section">Sort by</div>

              <div class="filterbar-item">
                <select id="filter-sort" name="sort" class="filterbar-select" aria-label="Sort by" onchange="this.form.submit()">
                  <option value="new" {% if filter_sort == 'new' %}selected{% endif %}>Newest</option>
                  <option value="old" {% if filter_sort == 'old' %}selected{% endif %}>Oldest</option>
                  <option value="most_over" {% if filter_sort == 'most_over' %}selected{% endif %}>Most over</option>
                  <option value="most_strict" {% if filter_sort == 'most_strict' %}selected{% endif %}>Lower median overage</option>
                  <option value="least_strict" {% if filter_sort == 'least_strict' %}selected{% endif %}>Higher median overage</option>
                </select>
              </div>

              <div class="filterbox-footer">
                <a class="filterbar-clear {% if not filters_active %}is-disabled{% endif %}" href="{{ url_for('home') }}">Clear</a>
              </div>

            </div>
          </div>

</form>

        <div class="filters-footer-links">
          <a href="{{ url_for('privacy') }}">Privacy</a>
          <span class="dot">·</span>
          <a href="{{ url_for('terms') }}">Terms</a>
        </div>
        <div class="filters-footer-meta">© 2025–2026 EnforcedSpeed™ · Developed by Conor Gordon · Mindra LLC</div>
      </div>
    </aside>

    <script>
      // Multi-select dropdown behavior (speed limit + overage):
      // - Do NOT submit on each checkbox click (allows multi-select)
      // - Close on outside click or Done, keeping selections
      // - Submit when the dropdown closes if selections changed
      (function(){
        var form = document.getElementById("feedFilters");
        if(!form) return;

        function textOf(cb){
          return cb.getAttribute("data-label") || "";
        }

        function updateSummary(d){
          var summary = d.querySelector(".multi-summary");
          if(!summary) return;
          var checks = Array.prototype.slice.call(d.querySelectorAll("input[type=checkbox]"));
          var selected = checks.filter(function(c){ return c.checked; }).map(textOf).filter(Boolean);
          summary.textContent = selected.length ? selected.join(", ") : "Any";
        }

        function submitIfDirty(d){
          if(!d || !d._dirty) return;
          if(d._submitting) return;
          d._submitting = true;
          d._dirty = false;
          form.submit();
        }

        var multis = Array.prototype.slice.call(document.querySelectorAll("details[data-multi]"));
        multis.forEach(function(d){
          d._dirty = false;
          d._submitting = false;
          updateSummary(d);

          d.addEventListener("change", function(e){
            if(e.target && e.target.matches && e.target.matches("input[type=checkbox]")){
              d._dirty = true;
              updateSummary(d);
            }
          });

          var done = d.querySelector("[data-multi-done]");
          if(done){
            done.addEventListener("click", function(ev){
              ev.preventDefault();
              d.open = false;
              submitIfDirty(d);
            });
          }

          d.addEventListener("toggle", function(){
            if(!d.open){
              submitIfDirty(d);
            }
          });
        });

        document.addEventListener("click", function(e){
          multis.forEach(function(d){
            if(!d.open) return;
            if(d.contains(e.target)) return;
            d.open = false;
            submitIfDirty(d);
          });
        });
      })();
    </script>

    {# Main column: welcome tile + feed (unchanged) #}
    <div class="home-center">

      {# Mobile-only toggle button for the filter sidebar #}
      <button type="button" class="home-filters-toggle" id="homeFiltersToggle">Filters</button>

      {# --- Welcome tile --- #}
      <div class="filters-rail">
    <div class="home-intro" style="margin: 0;">
      <div class="home-intro-title">Welcome to EnforcedSpeed.</div>

      <div class="home-intro-body">
        EnforcedSpeed aggregates real-world speeding ticket data submitted by drivers to identify the speeds at which enforcement most commonly occurs. By analyzing thousands of tickets, EnforcedSpeed highlights the speed at which the vast majority of drivers are cited.
      </div>

      <div class="home-intro-disclaimer">
        <span class="home-intro-disclaimer-lead">Important:</span> EnforcedSpeed is an informational data platform only. Posted speed limits are the law and must always be obeyed. This site does not provide legal advice, encourage speeding, or suggest that enforcement thresholds replace posted limits.
      </div>

    {% if is_admin %}
      </span>
    {% endif %}

    </div>
  </div>

      {# Feed starts immediately below welcome card. #}

{% for r in reports %}
  {% set state_code = (r.state.split(' - ')[0] if ' - ' in r.state else r.state) %}
  {% set state_name = (r.state.split(' - ')[-1] if ' - ' in r.state else r.state) %}
  <div class="card ticket-card{% if r.is_deleted %} ticket-card--deleted{% endif %}" style="margin-top:16px;">

  

{# --- Header: Username (X) + time, OCR pill on right --- #}
<div class="ticket-headwrap">
  <div class="ticket-headrow">
    <div class="ticket-user">
      {% if r.user %}
        {% set user_count = user_ticket_counts.get(r.user_id, 0) %}
        <div class="ticket-userline">
          <a href="{{ url_for('profile', username=r.user.username) }}" class="user-link">{{ r.user.username }}</a>
          <span class="ticket-usercount">({{ user_count }})</span>

          {% if is_admin and r.is_deleted %}
            <span class="pill pill-deleted" title="This ticket is soft-deleted and excluded from public views and analytics.">Deleted</span>
          {% endif %}
        </div>
      {% else %}
        <div class="ticket-userline">Anonymous</div>
      {% endif %}
    </div>

    <div class="ticket-ocr">
    {# Photo submitted pill: only true if we actually stored an R2 key. #}
    {% set photo_submitted = (r.photo_key is not none) %}
    {% if photo_submitted %}
      <span class="pill pill-photo pill-photo-submitted">Photo Submitted</span>
    {% else %}
      <span class="pill pill-photo pill-photo-unsubmitted">Photo Unsubmitted</span>
    {% endif %}

    {# OCR status pill: only show when a photo exists. #}
    {% if photo_submitted %}
      {% if r.ocr_status == 'processing' or r.ocr_status == 'pending' or r.verification_status == 'pending' %}
        <span class="pill pill-ocr pill-ocr-pending">Photo OCR Processing</span>
        <span class="pill-info" title="OCR is processing this photo now.">i</span>
      {% elif r.ocr_status == 'verified' or r.verification_status == 'verified' %}
        <span class="pill pill-ocr pill-ocr-verified">Auto-Extracted ✓</span>
        <span class="pill-info" title="OCR completed and key fields were validated automatically.">i</span>
      {% else %}
        <span class="pill pill-ocr pill-ocr-unverified">Not Auto-Extracted</span>
        {# Subtle reassurance: OCR did run. Tooltip text varies based on what we observed internally. #}
        {% set _vr = (r.verify_reason or '') %}
        {% set _err = (r.ocr_error or '') %}
        {% if _vr in ['no_text','missing_candidates','no_image','no_speeds','ocr_exception','ocr_error'] or _err in ['no_image','no_speeds'] %}
          {% set _tip = "OCR completed, but we couldn't read the key speed details clearly enough to verify." %}
        {% else %}
          {% set _tip = "OCR completed, but the extracted speeds didn't match closely enough to verify." %}
        {% endif %}
        <span class="pill-info" title="{{ _tip }}">i</span>
      {% endif %}
    {% endif %}

    </div>
  </div>

  <div class="subtle ticket-date" style="margin-top:4px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <span class="js-localtime" data-utc="{{ r.created_at.isoformat() }}Z">{{ r.created_at.strftime("%b %d, %Y %I:%M %p") }} UTC</span>

    {% if is_admin %}
      <span>
        {% if r.is_deleted %}
          <form method="post" action="{{ url_for('admin_restore_report', report_id=r.id) }}" style="margin:0;">
            <input type="hidden" name="next" value="{{ request.full_path if request.full_path.startswith('/') else url_for('home') }}">
            <button type="submit" class="admin-meta-link">Admin · Restore</button>
          </form>
        {% else %}
          <form method="post" action="{{ url_for('admin_delete_report', report_id=r.id) }}" style="margin:0;" onsubmit="return confirm('Delete this ticket?');">
            <input type="hidden" name="next" value="{{ request.full_path if request.full_path.startswith('/') else url_for('home') }}">
            <button type="submit" class="admin-meta-link">Admin · Delete</button>
          </form>
        {% endif %}
      </span>
    {% endif %}
  </div>

{# --- Static map preview (feed hero) --- #}
{% if r.lat and r.lng and maps_api_key %}
  {% set _sm = static_map_url(r.lat, r.lng, zoom=11, width=640, height=340) %}
  {% if _sm %}
    <div class="ticket-staticmap-wrap">
      {% if current_user.is_authenticated and r.user_id and (r.user_id == current_user.id) %}
        <button type="button" class="ticket-pin-refine" data-report-id="{{ r.id }}" data-lat="{{ r.lat }}" data-lng="{{ r.lng }}">Refine pin</button>
      {% endif %}
      <img class="ticket-staticmap" loading="lazy" src="{{ _sm }}" alt="Map preview">
    </div>
  {% endif %}
{% endif %}

</div>

{# --- Center: Road + State, speed/limit, ticket overage --- #}
{% set ticket_over = (r.ticketed_speed - r.posted_speed)|round|int %}
{% set enforced_over = enforced_a.get(r.id, (r.ticketed_speed - r.posted_speed)) %}
{% set enforced_speed_mph = (r.posted_speed + enforced_over)|round|int %}

<div class="ticket-center">
  <div class="ticket-roadstate">{{ format_road_bucket(r.road_name) }} in {{ state_name }}</div>

  <div class="ticket-speedrow">
    <div class="ticket-speedtext">
      <span class="ticket-speednum">{{ r.ticketed_speed }}</span>
      <span class="ticket-speedin">in a</span>
      <span class="ticket-speedlimit">{{ r.posted_speed }}</span>
      <span class="ticket-overageblue ticket-overageinline">({% if ticket_over > 0 %}+{{ ticket_over }}{% elif ticket_over < 0 %}{{ ticket_over }}{% else %}0{% endif %} mph)</span>
    </div>
  </div>

  <div class="ticket-enforcedline">
    This location, 90% of submitted tickets occur ≥ {{ enforced_speed_mph }} mph.
  </div>
</div>

<div class="row ticket-actions" style="display:flex;gap:12px;align-items:center;flex-wrap:nowrap;">
        <div class="row" style="display:flex;gap:14px;align-items:center;flex-wrap:nowrap;justify-content:flex-start;">

          {% set lc = like_counts.get(r.id, 0) %}

          {% if current_user.is_authenticated %}
            <form method="post" action="{{ url_for('toggle_like', report_id=r.id) }}" style="margin:0;display:inline;">
              {{ like_form.hidden_tag() }}
              <input type="hidden" name="next" value="{{ request.full_path }}">
              <button type="submit" class="action-btn">
                {% if r.id in user_liked %}Liked{% else %}Like{% endif %}
              </button>
            </form>

            <span class="subtle">{{ lc }} like{% if lc != 1 %}s{% endif %}</span>

            <a class="action-link" href="#" onclick="toggleComment({{ r.id }}); return false;">Comment</a>

          {% else %}
            <a class="action-link" href="#" onclick="membersOnly({{ r.id }}); return false;">Like</a>
            <span class="subtle">{{ lc }} like{% if lc != 1 %}s{% endif %}</span>
            <a class="action-link" href="#" onclick="membersOnly({{ r.id }}); return false;">Comment</a>
            <span id="mo-{{ r.id }}" class="subtle" style="display:none; margin-left:8px;">(must log in)</span>
          {% endif %}
        </div>

        {% set bucket_total = a_counts.get((r.state, r.road_key), 0) %}
        <div class="ticket-total" style="margin-left:auto;text-align:right;">
        <a class="action-link ticket-total-link" href="{{ url_for('bucket_tickets', state=state_code, road=r.road_key) }}" style="font-size:14px;font-weight:600;line-height:1;color:inherit;text-decoration:none;">View all {{ bucket_total }} tickets for this state and road</a>
        </div>
        {# Report link later (v3) #}
      
</div>

      {% set thread = comment_threads_by_report.get(r.id, {"top": [], "replies": {}}) %}
      {% set top_comments = thread["top"] %}
      {% set replies_map = thread["replies"] %}
      {% set total_comments = comments_by_report.get(r.id, [])|length %}

      {# Comments are fully collapsed by default (no comments shown until user expands). #}
      {% if top_comments %}
        <div style="margin-top:12px;">
          {% for c in top_comments %}
            <div id="comment-{{ c.id }}" class="subtle" style="margin-top:6px; display:none;">
              <strong style="color:#111827;">
                <a href="{{ url_for('profile', username=c.user.username) }}" style="color:inherit;text-decoration:none;">{{ c.user.username }}</a>
              </strong>
              <span class="subtle">
                · <span class="js-localtime" data-utc="{{ c.created_at.isoformat() }}Z">{{ c.created_at.strftime("%b %d, %Y %I:%M %p") }} UTC</span>
              </span>
              <div style="margin-top:2px;">{{ c.body }}</div>

              <div class="subtle" style="margin-top:4px;">
                {% if current_user.is_authenticated %}
                  <a class="action-link" href="#" onclick="openReplyWithMention({{ c.id }}, {{ c.id }}, '{{ c.user.username|e }}'); return false;">Reply</a>
                  {% if current_user.id == c.user_id %}
                    <form method="post" action="{{ url_for('delete_comment', comment_id=c.id) }}" style="display:inline; margin-left:10px;">
                      {{ delete_comment_form.hidden_tag() }}
                      <button type="submit" style="background:none;border:none;padding:0;margin:0;color:inherit;cursor:pointer;">Delete</button>
                      <input type="hidden" name="next" value="{{ request.full_path }}">
                    </form>
                  {% endif %}
                {% endif %}
              </div>

              {# Nested replies renderer (supports replying to replies). #}
              {# Nested replies renderer with capped visual indentation and feed-collapse (fully collapsed by default). #}
              {% macro render_replies(parent_id, depth, root_id, seen) -%}
                {# Safety guard: prevent cycles/runaway nesting from hanging the page. #}
                {% if parent_id in seen or depth > 20 %}
                {% else %}
                {% set kids = replies_map.get(parent_id, []) %}
                {% if kids %}
                  <div style="margin-top:6px;">
                    {% for rc in kids %}
                      {% set d = depth if depth < 2 else 2 %}
                      <div id="comment-{{ rc.id }}" class="subtle" style="margin-top:6px; margin-left:{{ 18 * d }}px; display:none;">
                        <strong style="color:#111827;">
                          <a href="{{ url_for('profile', username=rc.user.username) }}" style="color:inherit;text-decoration:none;">{{ rc.user.username }}</a>
                        </strong>
                        <span class="subtle"> · <span class="js-localtime" data-utc="{{ rc.created_at.isoformat() }}Z">{{ rc.created_at.strftime("%b %d, %Y %I:%M %p") }} UTC</span></span>
                        <div style="margin-top:2px;">{{ rc.body }}</div>
                        {% if current_user.is_authenticated %}
                          <div class="subtle" style="margin-top:4px;">
                            <a class="action-link" href="#" onclick="openReplyWithMention({{ root_id }}, {{ rc.id }}, '{{ rc.user.username|e }}'); return false;">Reply</a>
                            {% if current_user.id == rc.user_id %}
                              <form method="post" action="{{ url_for('delete_comment', comment_id=rc.id) }}" style="display:inline; margin-left:10px;">
                                {{ delete_comment_form.hidden_tag() }}
                                <button type="submit" style="background:none;border:none;padding:0;margin:0;color:inherit;cursor:pointer;">Delete</button>
                              </form>
                            {% endif %}
                          </div>
                        {% endif %}
                      </div>
                      {{ render_replies(rc.id, depth+1, root_id, seen + [parent_id]) }}
                    {% endfor %}
                  </div>
                {% endif %}
              {% endif %}
              {%- endmacro %}

              {{ render_replies(c.id, 1, c.id, []) }}
              {% if current_user.is_authenticated %}
                <div id="replybox-{{ c.id }}" style="display:none; margin-top:10px; margin-left:18px;">
                  <form method="post" action="{{ url_for('add_comment', report_id=r.id) }}">
                    {# Render CSRF only. We'll provide parent_id manually to avoid duplicate fields. #}
                    {{ comment_form.csrf_token }}
                    <input type="hidden" name="next" value="{{ request.full_path }}">
                    <input type="hidden" name="parent_id" value="{{ c.id }}">
                    <textarea class="js-comment-body" name="body" maxlength="280" rows="2" style="width:100%;" placeholder="Write a reply…"></textarea>
                    <div style="margin-top:8px;">
                      <button type="submit">Reply</button>
                      <span class="subtle" style="margin-left:10px;">280 characters max.</span>
                    </div>
                  </form>
                </div>
              {% endif %}
            </div>
          {% endfor %}

          <div class="subtle" style="margin-top:6px;">
            <a class="action-link" href="javascript:void(0)" id="toggle-comments-{{ r.id }}" onclick="return toggleComments({{ r.id }}, {{ total_comments }});" data-expanded="0" data-label="View all {{ total_comments }} comment{% if total_comments != 1 %}s{% endif %}">View all {{ total_comments }} comment{% if total_comments != 1 %}s{% endif %}</a>
          </div>

        </div>
      {% endif %}

      {% if current_user.is_authenticated %}
        <div id="commentbox-{{ r.id }}" style="display:none; margin-top:12px;">
          <form method="post" action="{{ url_for('add_comment', report_id=r.id) }}">
            {# Render CSRF only. We'll provide parent_id manually to avoid duplicate fields. #}
            {{ comment_form.csrf_token }}
            <input type="hidden" name="next" value="{{ request.full_path }}">
            <input type="hidden" name="parent_id" value="">
            <textarea class="js-comment-body" name="body" maxlength="280" rows="2" style="width:100%;" placeholder="Write a comment…"></textarea>
            <div style="margin-top:8px;">
              <button type="submit">Post</button>
              <span class="subtle" style="margin-left:10px;">280 characters max.</span>
            </div>
          </form>
        </div>
      {% endif %}

    </div>
  {% else %}
    <div class="card ticket-card" style="margin-top:16px;">
      <p>No posts yet. Be the first to <a href="{{ url_for('submit') }}">submit a ticket</a>.</p>
    </div>
  {% endfor %}

  {% if pagination.pages > 1 %}
    {# Preserve all active query params (including admin deleted mode) across pagination #}
    {% set q = request.args.to_dict() %}
    {% set _ = q.pop('page', None) %}

    <div class="card ticket-card" style="margin-top:16px;">
      <div class="row" style="justify-content:space-between;gap:12px;">
        <div>
          {% if pagination.has_prev %}
            <a class="action-link" href="{{ url_for('home', page=pagination.prev_num, **q) }}">← Newer</a>
          {% endif %}
        </div>
        <div class="subtle">Page {{ pagination.page }} of {{ pagination.pages }}</div>
        <div>
          {% if pagination.has_next %}
            <a class="action-link" href="{{ url_for('home', page=pagination.next_num, **q) }}">Older →</a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

</div>

<style>

  /* Reuse the exact thank_you thermometer styling (scoped to this template). */
  .ticket-card{padding-top:18px;padding-bottom:18px}

  .thermo-label{font-size:13px;font-weight:700;color:#374151}
  .thermo-line{display:flex;align-items:center;gap:10px}
  .thermo-bar{flex:1;height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden;position:relative}
  .thermo-fill{height:100%;background:#cbd5e1;border-radius:999px}
  .thermo-tick{position:absolute;top:0;bottom:0;width:2px;background:#9ca3af;opacity:.85;transform:translateX(-1px)}
  .thermo-tick.tick-90{left:90%;background:#111827;opacity:1}
  .thermo-value{min-width:54px;text-align:right;font-size:12px;font-weight:800;color:#111827}
  .thermo-p90{position:absolute;left:90%;top:-32px;transform:translateX(-50%);font-size:11px;font-weight:700;color:#111827;white-space:nowrap}

  .ticket-top{margin-top:-10px}
  .ticket-user{font-weight:400}
  .ticket-user .user-link{font-weight:500}
  .ticket-date{font-weight:400}
  /* Header layout: username on the left, OCR pill top-right aligned to username line. */
  .ticket-headwrap{display:block}
  .ticket-headrow{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .ticket-userline{display:flex;align-items:baseline;gap:6px}
  .ticket-usercount{font-size:13px;font-weight:600;color:#6b7280}
  .ticket-ocr{align-self:flex-start;margin-top:0}
  .user-link{text-decoration:none;color:inherit}
  .user-link:hover{text-decoration:underline}

  /* Ticket card center (Version 5). */
  .ticket-center{margin-top:12px;text-align:center;position:relative}
  .ticket-roadstate{font-size:20px;font-weight:600;color:#111827;letter-spacing:.01em}
  /* Speed line: keep the "90 in a 65" centered, and place "+25 mph" in the center of the right-hand side. */
  .ticket-speedrow{margin-top:10px;display:flex;justify-content:center;align-items:baseline}
    .ticket-speedtext{font-size:18px;font-weight:600;color:#111827;display:flex;align-items:baseline;gap:10px}
  .ticket-speedin{font-weight:600;color:#111827}
  .ticket-overageblue{font-size:18px;font-weight:600;color:#2563eb;white-space:nowrap}
  .ticket-overageinline{font-size:14px;margin-left:8px;}
  /* Float the +mph BETWEEN road/state and speed line (center-right). */
  .ticket-overagefloat{position:absolute;top:36px;left: calc(70% + 14px);transform:translate(-50%,-50%);}
  /* Add a touch more whitespace above/below the EnforcedSpeed sentence. */
  .ticket-enforcedline{margin-top:30px;margin-bottom:30px;font-size:13.5px;font-weight:400;color:#374151;line-height:1.35}

  .ticket-actions{margin-top:0px;padding-top:0;border-top:0}
  /* Force "View all…" to match Like/Comment exactly (no local overrides). */
  .ticket-total .action-link{font-size:inherit;line-height:inherit;font-weight:inherit;text-align:right;display:inline}
  .ticket-total{flex:1;min-width:160px}

  /* v58 refinements */
  .ticket-card{padding-top:18px;padding-bottom:18px}
  .ticket-top{margin-top:-10px}
  .thermo-line{display:flex;align-items:center;gap:10px}
  .thermo-bar{flex:1}
  .thermo-value{position:static;font-size:12px;font-weight:800;color:#111827;min-width:52px;text-align:right}

</style>

<script>
  function membersOnly(id){
    var el=document.getElementById('mo-'+id);
    if(!el){return;}
    el.style.display='inline';
    setTimeout(function(){ el.style.display='none'; }, 900);
  }
  function toggleComment(id){
    var el=document.getElementById('commentbox-'+id);
    if(!el){return;}
    el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
  }
  function toggleReply(commentId){
    var el=document.getElementById('replybox-'+rootId);
    if(!el){return;}
    el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
  }

  // Open the reply box for a comment and (if empty) prefill an @mention.
  function openReplyWithMention(rootId, parentId, username){
    var box = document.getElementById('replybox-'+rootId);
    if(!box){return;}
    box.style.display = 'block';
    try{
      var pid = box.querySelector('input[name="parent_id"]');
      if(pid && parentId){ pid.value = parentId; }
    }catch(e){}
    try{
      var ta = box.querySelector('textarea[name="body"]');
      if(!ta){return;}
      var current = (ta.value || '').trim();
      if(!current && username){
        ta.value = '@' + username + ' ';
      }
      ta.focus();
      // Move cursor to end
      ta.selectionStart = ta.selectionEnd = ta.value.length;
    }catch(e){}
  }

  // Enter submits, Shift+Enter adds a new line (comments + replies only)
  (function bindEnterToSubmit(){
    try{
      document.addEventListener('keydown', function(e){
        var t = e.target;
        if(!t) return;
        if(t.classList && t.classList.contains('js-comment-body')){
          if(e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            var form = t.closest('form');
            if(form){ form.submit(); }
          }
        }
      });
    }catch(e){}
  })();

  // Note: comment/reply boxes are closed by default on page load.
</script>


<script>
  function convertLocalTimes(){
    var nodes = document.querySelectorAll('.js-localtime[data-utc]');
    if(!nodes || nodes.length === 0) return;

    function formatLocal(d){
      try{
        return new Intl.DateTimeFormat(undefined, {
          month: 'short',
          day: '2-digit',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        }).format(d);
      }catch(e){
        return d.toLocaleString();
      }
    }

    nodes.forEach(function(el){
      var iso = el.getAttribute('data-utc');
      if(!iso) return;
      var d = new Date(iso);
      if(isNaN(d.getTime())) return;
      el.textContent = formatLocal(d);
    });
  }

  function toggleComments(reportId, totalCount){
    var link = document.getElementById('toggle-comments-' + reportId);
    if(!link) return false;
    var isExpanded = link.getAttribute('data-expanded') === '1';

    var card = link.closest('.card');
    if(!card) return false;

    var items = card.querySelectorAll('[id^="comment-"]');

    if(!isExpanded){
      items.forEach(function(el){ el.style.display = ''; });
      link.textContent = 'Collapse comments';
      link.setAttribute('data-expanded','1');
      try{ convertLocalTimes(); }catch(e){}
    }else{
      items.forEach(function(el){ el.style.display = 'none'; });
      var lbl = link.getAttribute('data-label');
      link.textContent = lbl ? lbl : ('View all ' + totalCount + ' comments');
      link.setAttribute('data-expanded','0');
    }
    return false;
  }

  


  // --- Mobile helpers (home) ---
  function initHomeFiltersToggle(){
    var btn = document.getElementById('homeFiltersToggle');
    var sidebar = document.getElementById('homeFiltersSidebar');
    if(!btn || !sidebar) return;

    function setCollapsed(v){
      if(v){ sidebar.classList.add('is-collapsed'); }
      else{ sidebar.classList.remove('is-collapsed'); }
    }

    try{
      if(window.matchMedia && window.matchMedia('(max-width: 980px)').matches){
        setCollapsed(true);
      }
    }catch(e){}

    btn.addEventListener('click', function(){
      sidebar.classList.toggle('is-collapsed');
    });
  }
document.addEventListener('DOMContentLoaded', function(){
    try{ convertLocalTimes(); }catch(e){}
    try{ initHomeFiltersToggle(); }catch(e){}
  });
</script>

    </div> {# /home-center #}

    {# Right rail: mini-map of the current feed page (only tickets with lat/lng). #}
    <aside class="home-right" aria-label="Ticket map">
      <div class="maps-rail">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div style="display:flex; flex-direction:column; line-height:1.1;">
            <div style="font-weight:600;">Ticket mini-map</div>
            <div style="font-size:12px; color:#6b7280; margin-top:2px;">Last 20 tickets</div>
          </div>
          <a class="subtle" href="{{ url_for('map_view') }}" style="text-decoration:none;">Open full map</a>
        </div>

        {% if map_pins and map_pins|length > 0 and maps_api_key %}
          <div class="subtle" style="margin-top:6px;">
          </div>
          <div id="homeMiniMap" style="width:100%; height:346px; margin-top:10px; border:1px solid #e5e7eb; border-radius:12px; background:#f3f4f6;"></div>
        {% elif not maps_api_key %}
          <div class="subtle" style="margin-top:10px;">Map not configured yet (missing GOOGLE_MAPS_API_KEY).</div>
        {% else %}
          <div class="subtle" style="margin-top:10px;">No pinned tickets on this page yet.</div>
        {% endif %}
      </div>
    </aside>

    {% if map_pins and map_pins|length > 0 and maps_api_key %}
    <script>
      (function(){
        const mapsKey = "{{ maps_api_key|e }}";
        const pins = {{ map_pins|tojson }};
        const el = document.getElementById('homeMiniMap');
        if(!mapsKey || !el || !pins || !pins.length) return;

        let _loaded = false;
        function loadGoogleMaps(cb){
          if(_loaded && window.google && window.google.maps){ cb(); return; }
          const existing = document.getElementById('gmapMiniScript');
          if(existing){
            const iv = setInterval(()=>{
              if(window.google && window.google.maps){ clearInterval(iv); _loaded = true; cb(); }
            }, 50);
            return;
          }
          window.__esMiniMapInit = function(){ _loaded = true; cb(); };
          const s = document.createElement('script');
          s.id = 'gmapMiniScript';
          s.async = true;
          s.defer = true;
          s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(mapsKey)}&callback=__esMiniMapInit`;
          document.head.appendChild(s);
        }

        function init(){
          if(!(window.google && window.google.maps)) return;

          // Center on the average pin (simple, stable).
          let avgLat = 0, avgLng = 0;
          pins.forEach(p => { avgLat += p.lat; avgLng += p.lng; });
          avgLat /= pins.length; avgLng /= pins.length;

          const map = new google.maps.Map(el, {
            center: { lat: avgLat, lng: avgLng },
            zoom: 6,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
          });

          const bounds = new google.maps.LatLngBounds();
          pins.forEach(p => {
            const pos = { lat: p.lat, lng: p.lng };
            bounds.extend(pos);
            const m = new google.maps.Marker({ position: pos, map: map });
            m.addListener('click', function(){
              // Keep it simple: go to the bucket list (stable route).
              if(p.url){ window.location.href = p.url; }
            });
          });

          if(pins.length === 1){
            map.setZoom(10);
          }else{
            map.fitBounds(bounds, 28);
          }
        }

        // Lazy-load when the rail is likely visible.
        function start(){ loadGoogleMaps(init); }
        if('IntersectionObserver' in window){
          const io = new IntersectionObserver((entries)=>{
            entries.forEach(e=>{ if(e.isIntersecting){ io.disconnect(); start(); } });
          }, { root: null, threshold: 0.05 });
          io.observe(el);
        }else{
          setTimeout(start, 150);
        }
      })();
    </script>
    {% endif %}

</div> {# /home-shell #}


{# --- Owner-only pin refine modal (feed) --- #}
{% if current_user.is_authenticated and maps_api_key %}
<div id="feedPinModal" class="modal" style="display:none;">
  <div class="modal-backdrop" id="feedPinBackdrop"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="feedPinTitle">
    <div class="modal-title" id="feedPinTitle">Refine pin</div>
    <div class="subtle" style="margin-top:6px;">
      Drag the pin to the closest spot on the road. We'll snap it to the nearest road line.
    </div>
    <div id="feedPinMap" style="width:100%; height:360px; margin-top:12px; border:1px solid #e5e7eb; border-radius:12px;"></div>
    <div class="subtle" id="feedPinStatus" style="margin-top:10px; display:none;"></div>
    <div class="modal-actions">
      <button type="button" class="btn btn-ghost" id="feedPinCancel">Cancel</button>
      <button type="button" class="btn" id="feedPinSave">Save pin</button>
    </div>
  </div>
</div>
{% endif %}


{% if current_user.is_authenticated and maps_api_key %}
<script>
  (function(){
    const modal = document.getElementById('feedPinModal');
    if(!modal) return;

    const backdrop = document.getElementById('feedPinBackdrop');
    const btnCancel = document.getElementById('feedPinCancel');
    const btnSave = document.getElementById('feedPinSave');
    const statusEl = document.getElementById('feedPinStatus');
    const mapEl = document.getElementById('feedPinMap');

    let activeReportId = null;
    let map = null;
    let marker = null;

    function showStatus(msg){
      if(!statusEl) return;
      statusEl.textContent = msg;
      statusEl.style.display = 'block';
    }
    function clearStatus(){
      if(!statusEl) return;
      statusEl.textContent = '';
      statusEl.style.display = 'none';
    }

    function close(){
      modal.style.display = 'none';
      activeReportId = null;
      clearStatus();
    }

    function ensureGoogleMaps(cb){
      if(window.google && google.maps){ cb(); return; }
      if(window.__esFeedMapsLoading){
        window.__esFeedMapsCallbacks.push(cb);
        return;
      }
      window.__esFeedMapsLoading = true;
      window.__esFeedMapsCallbacks = [cb];
      const s = document.createElement('script');
      s.src = "https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}";
      s.async = true;
      s.defer = true;
      s.onload = function(){
        const cbs = window.__esFeedMapsCallbacks || [];
        window.__esFeedMapsCallbacks = [];
        cbs.forEach(fn => { try{ fn(); }catch(e){} });
      };
      document.head.appendChild(s);
    }

    function open(reportId, lat, lng){
      activeReportId = reportId;
      modal.style.display = 'block';
      clearStatus();

      ensureGoogleMaps(function(){
        const center = { lat: lat, lng: lng };
        if(!map){
          map = new google.maps.Map(mapEl, {
            center: center,
            zoom: 16,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
          });
          marker = new google.maps.Marker({ position: center, map: map, draggable: true });
        }else{
          map.setCenter(center);
          map.setZoom(16);
          marker.setPosition(center);
        }
      });
    }

    function bindTriggers(){
      document.querySelectorAll('.ticket-pin-refine').forEach(btn => {
        btn.addEventListener('click', function(){
          const rid = parseInt(btn.getAttribute('data-report-id') || '0', 10);
          const lat = parseFloat(btn.getAttribute('data-lat') || '0');
          const lng = parseFloat(btn.getAttribute('data-lng') || '0');
          if(!rid || !lat || !lng) return;
          open(rid, lat, lng);
        });
      });
    }

    async function save(){
      if(!activeReportId || !marker) return;
      const pos = marker.getPosition();
      const lat = pos.lat();
      const lng = pos.lng();
      btnSave.disabled = true;
      try{
        const res = await fetch('/api/update_ticket_pin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ report_id: activeReportId, lat: lat, lng: lng })
        });
        const data = await res.json().catch(()=>({}));
        if(res.ok && data && data.ok){
          showStatus(data.snapped ? 'Saved. Pin snapped to nearest road.' : 'Saved.');
          // Reload to refresh static map image + any downstream aggregates.
          setTimeout(()=>{ window.location.reload(); }, 450);
        }else{
          showStatus('Could not save pin. Please try again.');
          btnSave.disabled = false;
        }
      }catch(e){
        showStatus('Could not save pin. Please try again.');
        btnSave.disabled = false;
      }
    }

    if(backdrop) backdrop.addEventListener('click', close);
    if(btnCancel) btnCancel.addEventListener('click', close);
    if(btnSave) btnSave.addEventListener('click', save);

    bindTriggers();
  })();
</script>
{% endif %}

{% endblock %}


