{% extends "base.html" %}
{% block content %}

<div class="home-shell">

  <aside class="home-left" id="homeFiltersSidebar">
    <div class="filters-rail">
      <div class="filters-scroll">
      <form method="get" action="{{ url_for('strictness') }}" class="filterbar" id="strictnessFilters">
          <div class="filterbox">
            <div class="filterbox-title">Filter Speeding Tickets</div>
            <div class="filterbar-row filterbar-row--stack">

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-state">State</label>
                <select id="filter-state" name="state" class="filterbar-select" onchange="this.form.submit()">
                  <option value="" {% if not filter_state %}selected{% endif %}>All states</option>
                  {% for opt in state_filter_options %}
                    <option value="{{ opt.code }}" {% if filter_state == opt.code %}selected{% endif %}>{{ opt.code }}</option>
                  {% endfor %}
                </select>
              </div>

                            <div class="filterbar-item">
                <label class="filterbar-label" for="filter-county">County</label>
                <div class="filter-autocomplete-wrap">
                  <input id="filter-county" value="{{ filter_county_label or '' }}" placeholder="Start typing (e.g., Franklin)" autocomplete="off">
                  <input type="hidden" id="filter-county-geoid" name="county_geoid" value="{{ filter_county_geoid or '' }}">
                  <div class="filter-suggestions" id="filter-county-suggestions" style="display:none"></div>
                </div>
              </div>

<div class="filterbar-item filterbar-item--tight">
                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                  <label class="filterbar-label" for="filter-verify" style="margin:0;">Photo <span class="filter-check">✓</span></label>
                  <label class="switch">
                    <input type="checkbox" id="filter-verify" name="verify" value="verified" {% if filter_verify == 'verified' %}checked{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
<div class="filterbar-item filterbar-item--tight">
  <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
    <label class="filterbar-label" for="filter-pin" style="margin:0;">Map pin <span class="filter-check">✓</span></label>
    <label class="switch">
      <input type="checkbox" id="filter-pin" name="pin" value="1" {% if filter_pin %}checked{% endif %} onchange="this.form.submit()">
      <span class="slider"></span>
    </label>
  </div>
</div>



              <div class="filterbar-item">
  <label class="filterbar-label" for="filter-speed-limit">Posted speed limit</label>
  <select id="filter-speed-limit" name="speed_limit" class="filterbar-select" onchange="this.form.submit()">
    <option value="any" {% if (filter_speed_limit_list|length == 0) %}selected{% endif %}>Any</option>
    <option value="lte35" {% if 'lte35' in filter_speed_limit_list %}selected{% endif %}>≤ 35 mph</option>
    <option value="40-55" {% if '40-55' in filter_speed_limit_list %}selected{% endif %}>40–55 mph</option>
    <option value="gte60" {% if 'gte60' in filter_speed_limit_list %}selected{% endif %}>≥ 60 mph</option>
  </select>
</div>

              <div class="filterbar-item">
  <label class="filterbar-label" for="filter-overage">Overage (mph over)</label>
  <select id="filter-overage" name="overage" class="filterbar-select" onchange="this.form.submit()">
    <option value="all" {% if (filter_over_list|length == 0) %}selected{% endif %}>Any</option>
    <option value="1-10" {% if '1-10' in filter_over_list %}selected{% endif %}>1–10 mph over</option>
    <option value="11-20" {% if '11-20' in filter_over_list %}selected{% endif %}>11–20 mph over</option>
    <option value="21+" {% if '21+' in filter_over_list %}selected{% endif %}>≥ 21 mph over</option>
  </select>
</div>
              
              

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-date">Date</label>
                <select id="filter-date" name="date" class="filterbar-select" onchange="this.form.submit()">
                  {% for o in date_options %}
                    <option value="{{ o.value }}" {% if filter_date == o.value %}selected{% endif %}>{{ o.label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-sort">Sort by</label>
                <select id="filter-sort" name="sort" class="filterbar-select" aria-label="Sort by" onchange="this.form.submit()">
                  <option value="new" {% if filter_sort == 'new' %}selected{% endif %}>Newest</option>
                  <option value="old" {% if filter_sort == 'old' %}selected{% endif %}>Oldest</option>
                  <option value="most_over" {% if filter_sort == 'most_over' %}selected{% endif %}>Most over</option>
                  <option value="most_strict" {% if filter_sort == 'most_strict' %}selected{% endif %}>Lower median overage</option>
                  <option value="least_strict" {% if filter_sort == 'least_strict' %}selected{% endif %}>Higher median overage</option>
                </select>
              </div>

              

<div class="filterbar-item filterbar-item--tight">
{% if is_admin %}
                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                  <label class="filterbar-label" for="filter-deleted-mode" style="margin:0;">Deleted (admin)</label>
                  <select id="filter-deleted-mode" name="deleted" class="filter-select" onchange="this.form.submit()" style="max-width:140px;">
                    <option value="hide" {% if (deleted_mode or 'hide') == 'hide' %}selected{% endif %}>Hide</option>
                    <option value="include" {% if deleted_mode == 'include' %}selected{% endif %}>Include</option>
                    <option value="only" {% if deleted_mode == 'only' %}selected{% endif %}>Only</option>
                  </select>
                </div>
                {% endif %}
              </div>

<div class="filterbox-footer">
                <a class="filterbar-clear {% if not filters_active %}is-disabled{% endif %}" href="{{ url_for('strictness') }}">Clear</a>
              </div>

            </div>
          </div>

</form>
      </div>

      <div class="filters-footer">
        <div class="filters-footer-links">
        <a href="{{ url_for('privacy') }}">Privacy</a>
        <span class="dot">·</span>
        <a href="{{ url_for('terms') }}">Terms</a>
          <span class="dot">·</span>
          <a href="{{ url_for('cookies') }}">Cookie Policy</a>
      </div>
        <div class="filters-footer-meta">© 2025–2026 EnforcedSpeed™ · Developed by Conor Gordon · Mindra LLC</div>
      </div>
    </div>
  </aside>

  <main class="home-center">
  <div class="card" style="padding:14px;">
    <div style="margin-bottom:14px; text-align:center;">
      <h1 style="margin:0;">County Statistics</h1>
      <div class="subtle" style="margin-top:6px; font-size:14px;">Based on median ticketed speed over posted speed</div>
    </div>

    <div class="blocks">
      <div class="block">
        <strong>Lower median overage</strong>
        <ol class="stat-list">
          {% for i in range(20) %}
            {% if i < most_strict|length %}
              {% set r = most_strict[i] %}
              <li class="stat-row">
                <div class="stat-place">
                  <span class="stat-state">{{ r.state_name }}</span>,
                  <a class="stat-county" href="{{ url_for('map_view', state=r.state, county_geoid=r.county_geoid) }}">{{ r.county_name }}</a>
                </div>
                <div class="stat-metrics">
                  +{{ '%.1f'|format(r.median_overage) }} mph <span class="stat-tickets">({{ r.tickets }} tickets)</span>
                </div>
              </li>
            {% else %}
              <li class="subtle">Waiting for more data…</li>
            {% endif %}
          {% endfor %}
        </ol>
      </div>

      <div class="block">
        <strong>Higher median overage</strong>
        <ol class="stat-list">
          {% for i in range(20) %}
            {% if i < least_strict|length %}
              {% set r = least_strict[i] %}
              <li class="stat-row">
                <div class="stat-place">
                  <span class="stat-state">{{ r.state_name }}</span>,
                  <a class="stat-county" href="{{ url_for('map_view', state=r.state, county_geoid=r.county_geoid) }}">{{ r.county_name }}</a>
                </div>
                <div class="stat-metrics">
                  +{{ '%.1f'|format(r.median_overage) }} mph <span class="stat-tickets">({{ r.tickets }} tickets)</span>
                </div>
              </li>
            {% else %}
              <li class="subtle">Waiting for more data…</li>
            {% endif %}
          {% endfor %}
        </ol>
      </div>
    </div>

  </div>
</main>

</div>

<script>
  // Multi-select dropdown behavior (speed limit + overage):
  // - Do NOT submit on each checkbox click (allows multi-select)
  // - Close on outside click or Done, keeping selections
  // - Submit when the dropdown closes if selections changed
  (function(){
    var form = document.getElementById("strictnessFilters");
    if(!form) return;

    function textOf(cb){
      return cb.getAttribute("data-label") || "";
    }

    function updateSummary(d){
      var summary = d.querySelector(".multi-summary");
      if(!summary) return;
      var checks = Array.prototype.slice.call(d.querySelectorAll("input[type=checkbox]"));
      var selected = checks.filter(function(c){ return c.checked; }).map(textOf).filter(Boolean);
      summary.textContent = selected.length ? selected.join(", ") : "Any";
    }

    function submitIfDirty(d){
      if(!d || !d._dirty) return;
      if(d._submitting) return;
      d._submitting = true;
      d._dirty = false;
      form.submit();
    }

    var multis = Array.prototype.slice.call(form.querySelectorAll("details[data-multi]"));
    multis.forEach(function(d){
      d._dirty = false;
      d._submitting = false;
      updateSummary(d);

      d.addEventListener("change", function(e){
        if(e.target && e.target.matches && e.target.matches("input[type=checkbox]")){
          d._dirty = true;
          updateSummary(d);
        }
      });

      var done = d.querySelector("[data-multi-done]");
      if(done){
        done.addEventListener("click", function(ev){
          ev.preventDefault();
          d.open = false;
          submitIfDirty(d);
        });
      }

      d.addEventListener("toggle", function(){
        if(!d.open){
          submitIfDirty(d);
        }
      });
    });

    document.addEventListener("click", function(e){
      multis.forEach(function(d){
        if(!d.open) return;
        if(d.contains(e.target)) return;
        d.open = false;
        submitIfDirty(d);
      });
    });
  })();
</script>

{% endblock %}
