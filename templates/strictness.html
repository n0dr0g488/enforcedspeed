{% extends "base.html" %}
{% block content %}

<div class="home-shell">

  <aside class="home-left" id="homeFiltersSidebar">
    <div class="filters-rail">
      <form method="get" action="{{ url_for('strictness') }}" class="filterbar" id="strictnessFilters">
          <div class="filterbox">
            <div class="filterbox-title">Filter Speeding Tickets</div>
            <div class="filterbox-section">Location</div>

            <div class="filterbar-row filterbar-row--stack">

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-state">State</label>
                <select id="filter-state" name="state" class="filterbar-select" onchange="this.form.submit()">
                  <option value="" {% if not filter_state %}selected{% endif %}>All states</option>
                  {% for opt in state_filter_options %}
                    <option value="{{ opt.code }}" {% if filter_state == opt.code %}selected{% endif %}>{{ opt.code }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-road">Road</label>
                <input id="filter-road" name="road" class="filterbar-input" type="text" value="{{ filter_road or '' }}" placeholder="I-95, US-1, SR-520" autocomplete="off" list="road_suggestions">
                <datalist id="road_suggestions">
                  {% for s in road_suggestions %}
                    <option value="{{ s }}"></option>
                  {% endfor %}
                </datalist>
              </div>

              <div class="filterbox-section">Enforcement</div>

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-speed-limit">Posted speed limit</label>
                {% set ssel = [] %}
                {% for b in speed_limit_buckets %}
                  {% if b.value in filter_speed_limit_list and b.value != 'any' %}
                    {% set _ = ssel.append(b.label) %}
                  {% endif %}
                {% endfor %}

                <details class="multi" data-multi>
                  <summary class="multi-summary">
                    {% if ssel|length == 0 %}Any{% else %}{{ ssel|join(', ') }}{% endif %}
                  </summary>
                  <div class="multi-panel">
                    {% for b in speed_limit_buckets %}
                      {% if b.value != 'any' %}
                        {% set _id = 'sl-' ~ b.value %}
                        <label class="multi-opt">
                          <input type="checkbox" id="{{ _id }}" name="speed_limit" value="{{ b.value }}" data-label="{{ b.label }}" {% if b.value in filter_speed_limit_list %}checked{% endif %}>
                          <span>{{ b.label }}</span>
                        </label>
                      {% endif %}
                    {% endfor %}
                    <button type="button" class="multi-done" data-multi-done>Done</button>
                  </div>
                </details>
              </div>

              <div class="filterbar-item">
                <label class="filterbar-label">Overage (mph over)</label>
                {# Compact multi-select dropdown (no big chip grid). #}
                {% set sel = [] %}
                {% for b in over_buckets %}
                  {% if b.value in filter_over_list %}
                    {% set _ = sel.append(b.label) %}
                  {% endif %}
                {% endfor %}

                <details class="multi" data-multi>
                  <summary class="multi-summary">
                    {% if sel|length == 0 %}Any{% else %}{{ sel|join(', ') }}{% endif %}
                  </summary>
                  <div class="multi-panel">
                    {% for b in over_buckets %}
                      {% if b.value != 'all' %}
                        {% set _id = 'ov-' ~ b.value %}
                        <label class="multi-opt">
                          <input type="checkbox" id="{{ _id }}" name="overage" value="{{ b.value }}" data-label="{{ b.label }}" {% if b.value in filter_over_list %}checked{% endif %}>
                          <span>{{ b.label }}</span>
                        </label>
                      {% endif %}
                    {% endfor %}
                    <button type="button" class="multi-done" data-multi-done>Done</button>
                  </div>
                </details>
              </div>

              <div class="filterbox-section">Evidence</div>

              <div class="filterbar-item filterbar-item--tight">
                <div class="filterbar-rowline filterbar-rowline--tight">
                  <label class="filterbar-label" for="filter-photo-only" style="margin:0;">Photo submitted</label>
                  <label class="switch">
                    <input type="checkbox" id="filter-photo-only" name="photo_only" value="1" {% if filter_photo_only %}checked{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>

                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                  <label class="filterbar-label" for="filter-verify" style="margin:0;">Auto-Extracted</label>
                  <label class="switch">
                    <input type="checkbox" id="filter-verify" name="verify" value="verified" {% if filter_verify == 'verified' %}checked{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>

              <div class="filterbox-section">Visibility</div>

              <div class="filterbar-item filterbar-item--tight">
                <div class="filterbar-rowline filterbar-rowline--tight">
                  <label class="filterbar-label" for="filter-hide-anon" style="margin:0;">Hide anonymous{% if not current_user.is_authenticated %} <span class="filter-inline-note">(must log in)</span>{% endif %}</label>
                  <label class="switch">
                    <input type="checkbox" id="filter-hide-anon" name="hide_anon" value="1" {% if hide_anon %}checked{% endif %} {% if not current_user.is_authenticated %}disabled{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>
{% if is_admin %}
                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:8px;">
                  <label class="filterbar-label" for="filter-deleted-mode" style="margin:0;">Deleted (admin)</label>
                  <select id="filter-deleted-mode" name="deleted" class="filter-select" onchange="this.form.submit()" style="max-width:140px;">
                    <option value="hide" {% if (deleted_mode or 'hide') == 'hide' %}selected{% endif %}>Hide</option>
                    <option value="include" {% if deleted_mode == 'include' %}selected{% endif %}>Include</option>
                    <option value="only" {% if deleted_mode == 'only' %}selected{% endif %}>Only</option>
                  </select>
                </div>
                {% endif %}
              </div>

              <div class="filterbox-section">Date</div>

              <div class="filterbar-item">
                <select id="filter-date" name="date" class="filterbar-select" onchange="this.form.submit()">
                  {% for o in date_options %}
                    <option value="{{ o.value }}" {% if filter_date == o.value %}selected{% endif %}>{{ o.label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="filterbox-section">Sort by</div>

              <div class="filterbar-item">
                <select id="filter-sort" name="sort" class="filterbar-select" aria-label="Sort by" onchange="this.form.submit()">
                  <option value="new" {% if filter_sort == 'new' %}selected{% endif %}>Newest</option>
                  <option value="old" {% if filter_sort == 'old' %}selected{% endif %}>Oldest</option>
                  <option value="most_over" {% if filter_sort == 'most_over' %}selected{% endif %}>Most over</option>
                  <option value="most_strict" {% if filter_sort == 'most_strict' %}selected{% endif %}>Lower median overage</option>
                  <option value="least_strict" {% if filter_sort == 'least_strict' %}selected{% endif %}>Higher median overage</option>
                </select>
              </div>

              <div class="filterbox-footer">
                <a class="filterbar-clear {% if not filters_active %}is-disabled{% endif %}" href="{{ url_for('strictness') }}">Clear</a>
              </div>

            </div>
          </div>

</form>

      <div class="filters-footer-links">
        <a href="{{ url_for('privacy') }}">Privacy</a>
        <span class="dot">·</span>
        <a href="{{ url_for('terms') }}">Terms</a>
      </div>
      <div class="filters-footer-meta">© 2025–2026 EnforcedSpeed™ · Developed by Conor Gordon · Mindra LLC</div>
    </div>
  </aside>

  <main class="home-center">
    <div class="card" style="padding:14px;">
      <div class="submit-title" style="margin:0 0 2px;">Median Overage Rankings</div>
      <div class="submit-note" style="margin:0 0 12px;">Rankings based on median ticketed speed over posted speed.</div>

      <div class="blocks">
          <div class="block">
            <strong>Lower Median Overage</strong>
            <ol>
              {% for i in range(20) %}
                {% if i < most_strict|length %}
                  {% set r = most_strict[i] %}
                  <li>
                    <span class="pill">{{ r.state }}</span>
                    <span class="pill">{{ format_road_bucket(r.road) }}</span>
	                    <br>
                    +{{ '%.1f'|format(r.median_overage) }} mph <a class="action-link" href="{{ url_for('bucket_tickets', state=r.state, road=r.road) }}">(tickets: {{ r.tickets }})</a>
                  </li>
                {% else %}
                  <li class="subtle">Waiting for more data…</li>
                {% endif %}
              {% endfor %}
            </ol>
          </div>

          <div class="block">
            <strong>Higher Median Overage</strong>
            <ol>
              {% for i in range(20) %}
                {% if i < least_strict|length %}
                  {% set r = least_strict[i] %}
                  <li>
                    <span class="pill">{{ r.state }}</span>
                    <span class="pill">{{ format_road_bucket(r.road) }}</span>
	                    <br>
                    +{{ '%.1f'|format(r.median_overage) }} mph <a class="action-link" href="{{ url_for('bucket_tickets', state=r.state, road=r.road) }}">(tickets: {{ r.tickets }})</a>
                  </li>
                {% else %}
                  <li class="subtle">Waiting for more data…</li>
                {% endif %}
              {% endfor %}
            </ol>
          </div>
        </div>

    </div>
  </main>

</div>


<script>
  // Multi-select dropdown behavior (speed limit + overage):
  // - Do NOT submit on each checkbox click (allows multi-select)
  // - Close on outside click or Done, keeping selections
  // - Submit when the dropdown closes if selections changed
  (function(){
    var form = document.getElementById("strictnessFilters");
    if(!form) return;

    function textOf(cb){
      return cb.getAttribute("data-label") || "";
    }

    function updateSummary(d){
      var summary = d.querySelector(".multi-summary");
      if(!summary) return;
      var checks = Array.prototype.slice.call(d.querySelectorAll("input[type=checkbox]"));
      var selected = checks.filter(function(c){ return c.checked; }).map(textOf).filter(Boolean);
      summary.textContent = selected.length ? selected.join(", ") : "Any";
    }

    function submitIfDirty(d){
      if(!d || !d._dirty) return;
      if(d._submitting) return;
      d._submitting = true;
      d._dirty = false;
      form.submit();
    }

    var multis = Array.prototype.slice.call(form.querySelectorAll("details[data-multi]"));
    multis.forEach(function(d){
      d._dirty = false;
      d._submitting = false;
      updateSummary(d);

      d.addEventListener("change", function(e){
        if(e.target && e.target.matches && e.target.matches("input[type=checkbox]")){
          d._dirty = true;
          updateSummary(d);
        }
      });

      var done = d.querySelector("[data-multi-done]");
      if(done){
        done.addEventListener("click", function(ev){
          ev.preventDefault();
          d.open = false;
          submitIfDirty(d);
        });
      }

      d.addEventListener("toggle", function(){
        if(!d.open){
          submitIfDirty(d);
        }
      });
    });

    document.addEventListener("click", function(e){
      multis.forEach(function(d){
        if(!d.open) return;
        if(d.contains(e.target)) return;
        d.open = false;
        submitIfDirty(d);
      });
    });
  })();
</script>

{% endblock %}
