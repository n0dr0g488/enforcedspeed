{% extends "base.html" %}
{% block content %}

<style>
  /* Map page: lock to viewport (no page scroll). */
  html, body { height: 100%; }
  body { overflow: hidden; }

  /* Map page already has footer links in the left rail; hide the base footer to avoid viewport math drift. */
  .footer{ display:none; }

  /* v401: Map page uses the SAME "overlay rails" layout as Home.
     - Left/right rails remain fixed (from global CSS)
     - Center column stays truly centered to the viewport (aligns with header search)
     - Center column is viewport-locked for a full-height map with symmetric top/bottom buffer
  */
  .home-shell.map-shell{
    position: relative;
    height: calc(100vh - 62px);
    padding: 0 20px;
    box-sizing: border-box;
    overflow: hidden;
  }

  /* Center map column: fixed 720px column, vertically fills the viewport area. */
  .home-shell.map-shell .home-center{
    height: 100%;
    padding: 12px 0;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    min-width: 0;
    min-height: 0;
  }

  /* Map card fills available height; the shell padding provides the outer buffer. */
  .map-card{ flex: 1 1 auto; display: flex; flex-direction: column; padding: 12px; margin: 0; box-sizing: border-box; min-height: 0; }

  /* Map frame: rounded map + a centered title pill overlay (matches the outlined scope). */
  .map-frame{ position: relative; flex: 1 1 auto; width: 100%; border-radius: 14px; overflow: hidden; min-height: 0; }
  #esMap{ position: absolute; inset: 0; }

  .map-pill-row{
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 5;
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: calc(100% - 28px);
    pointer-events: none;
  }

  .map-title-pill{
    background: rgba(255,255,255,0.96);
    border: 1px solid rgba(0,0,0,0.10);
    border-radius: 999px;
    padding: 7px 12px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(0,0,0,0.10);
    line-height: 1;
    pointer-events: none;
    flex: 1 1 auto;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .map-follow-pill{
    pointer-events: auto;
    border-radius: 999px;
    padding: 7px 12px;
    font-size: 12px;
    font-weight: 600;
    line-height: 1;
    border: 1px solid rgba(0,0,0,0.12);
    background: rgba(255,255,255,0.96);
    box-shadow: 0 6px 18px rgba(0,0,0,0.10);
    cursor: pointer;
    user-select: none;
    text-decoration: none;
    color: inherit;
    flex: 0 0 auto;
  }
  .map-follow-pill.is-following{
    background: rgba(17,24,39,0.92);
    color: #fff;
    border-color: rgba(17,24,39,0.92);
  }
  .map-follow-pill:disabled{
    opacity: .55;
    cursor: default;
  }

  /* Simple zoom controls (+ / -) for users without a mouse wheel */
  .map-zoom-controls{
    position: absolute;
    right: 12px;
    bottom: 12px;
    z-index: 6;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: auto;
  }
  .map-zoom-btn{
    width: 38px;
    height: 38px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.12);
    background: rgba(255,255,255,0.96);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
    line-height: 1;
    cursor: pointer;
    user-select: none;
  }
  .map-zoom-btn:active{ transform: translateY(1px); }
  .map-zoom-btn:disabled{ opacity: .45; cursor: default; transform: none; }

  /* Right panel cards */
  .map-right{ height: 100%; overflow: auto; padding-left: 0; min-height: 0; }
  .map-right{ scrollbar-width: none; -ms-overflow-style: none; }
  .map-right::-webkit-scrollbar{ width: 0; height: 0; }

  .map-right .card { border-radius: 9px; }
  .map-right .mini-ticket { padding: 12px; }
  .map-right .mini-ticket .mini-title { font-weight: 600; margin: 0 0 4px 0; }
  .map-right .mini-ticket .mini-sub { font-size: 13px; opacity: .85; }
  .map-right .stat-card { padding: 12px; margin-top: 12px; }
  .map-right .stat-row { display: flex; justify-content: space-between; gap: 10px; font-size: 13px; padding: 6px 0; border-top: 1px solid rgba(0,0,0,0.06); }
  .map-right .stat-row:first-of-type { border-top: 0; }
  .map-right .stat-k { opacity: .8; }
  .map-right .stat-v { font-weight: 600; white-space: nowrap; }
  .map-right .stat-title { font-weight: 600; margin: 0 0 8px 0; }
  .map-right .speed-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
  .map-right .speed-table th, .map-right .speed-table td { padding: 6px 0; border-top: 1px solid rgba(0,0,0,0.06); }
  .map-right .speed-table th { text-align: left; font-weight: 600; opacity: .85; }
  .map-right .speed-table td:last-child, .map-right .speed-table th:last-child { text-align: right; }
</style>

<div class="home-shell map-shell">
    <aside class="home-left" id="homeFiltersSidebar">
      <div class="filters-rail">
        <div class="filters-scroll">
          <form method="get" action="{{ url_for('map_view') }}" class="filterbar" id="mapFilters">
            <div class="filterbox">
              <div class="filterbox-title">Filter Speeding Tickets</div>
              <div class="filterbar-row filterbar-row--stack">

                <div class="filterbar-item">
                  <label class="filterbar-label" for="filter-state">State</label>
                  <select id="filter-state" name="state" class="filterbar-select" onchange="this.form.submit()">
                    <option value="" {% if not filter_state %}selected{% endif %}>All states</option>
                    {% for opt in state_filter_options %}
                      <option value="{{ opt.code }}" {% if filter_state == opt.code %}selected{% endif %}>{{ opt.code }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="filterbar-item">
                  <label class="filterbar-label" for="filter-county">County</label>
                  <div class="filter-autocomplete-wrap">
                    <input id="filter-county" value="{{ filter_county_label or '' }}" placeholder="Start typing (e.g., Franklin)" autocomplete="off">
                    <input type="hidden" id="filter-county-geoid" name="county_geoid" value="{{ filter_county_geoid or '' }}">
                    <div class="filter-suggestions" id="filter-county-suggestions" style="display:none"></div>
                  </div>
                </div>

                <div class="filterbar-item filterbar-item--tight">
                  <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                    <label class="filterbar-label" for="filter-verify" style="margin:0;">Photo <span class="filter-check">✓</span></label>
                    <label class="switch">
                      <input type="checkbox" id="filter-verify" name="verify" value="verified" {% if filter_verify == 'verified' %}checked{% endif %} onchange="this.form.submit()">
                      <span class="slider"></span>
                    </label>
                  </div>
                </div>

                <div class="filterbar-item filterbar-item--tight">
                  <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                    <label class="filterbar-label" for="filter-pin" style="margin:0;">Map pin <span class="filter-check">✓</span></label>
                    <label class="switch">
                      <input type="checkbox" id="filter-pin" name="pin" value="1" {% if filter_pin %}checked{% endif %} onchange="this.form.submit()">
                      <span class="slider"></span>
                    </label>
                  </div>
                </div>

                <div class="filterbar-item">
                  <label class="filterbar-label" for="filter-speed-limit">Posted speed limit</label>
                  <select id="filter-speed-limit" name="speed_limit" class="filterbar-select" onchange="this.form.submit()">
                    <option value="any" {% if (filter_speed_limit_list|length == 0) %}selected{% endif %}>Any</option>
                    <option value="lte35" {% if 'lte35' in filter_speed_limit_list %}selected{% endif %}>≤ 35 mph</option>
                    <option value="40-55" {% if '40-55' in filter_speed_limit_list %}selected{% endif %}>40–55 mph</option>
                    <option value="gte60" {% if 'gte60' in filter_speed_limit_list %}selected{% endif %}>≥ 60 mph</option>
                  </select>
                </div>

                <div class="filterbar-item">
                  <label class="filterbar-label" for="filter-overage">Overage (mph over)</label>
                  <select id="filter-overage" name="overage" class="filterbar-select" onchange="this.form.submit()">
                    <option value="all" {% if (filter_over_list|length == 0) %}selected{% endif %}>Any</option>
                    <option value="1-10" {% if '1-10' in filter_over_list %}selected{% endif %}>1–10 mph over</option>
                    <option value="11-20" {% if '11-20' in filter_over_list %}selected{% endif %}>11–20 mph over</option>
                    <option value="21+" {% if '21+' in filter_over_list %}selected{% endif %}>≥ 21 mph over</option>
                  </select>
                </div>

                <div class="filterbar-item">
                  <label class="filterbar-label" for="filter-date">Date</label>
                  <select id="filter-date" name="date" class="filterbar-select" onchange="this.form.submit()">
                    {% for o in date_options %}
                      <option value="{{ o.value }}" {% if filter_date == o.value %}selected{% endif %}>{{ o.label }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="filterbar-item">
                  <label class="filterbar-label" for="filter-sort">Sort by</label>
                  <select id="filter-sort" name="sort" class="filterbar-select" aria-label="Sort by" onchange="this.form.submit()">
                    <option value="new" {% if filter_sort == 'new' %}selected{% endif %}>Newest</option>
                    <option value="old" {% if filter_sort == 'old' %}selected{% endif %}>Oldest</option>
                    <option value="most_over" {% if filter_sort in ['most_over', 'least_strict'] %}selected{% endif %}>Highest overage</option>
                    <option value="least_over" {% if filter_sort == 'least_over' or filter_sort == 'least_strict' %}selected{% endif %}>Least over</option>
                  </select>
                </div>

                <div class="filterbar-item filterbar-item--tight">
                  {% if is_admin %}
                    <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                      <label class="filterbar-label" for="filter-deleted-mode" style="margin:0;">Deleted (admin)</label>
                      <select id="filter-deleted-mode" name="deleted" class="filter-select" onchange="this.form.submit()" style="max-width:140px;">
                        <option value="hide" {% if (deleted_mode or 'hide') == 'hide' %}selected{% endif %}>Hide</option>
                        <option value="include" {% if deleted_mode == 'include' %}selected{% endif %}>Include</option>
                        <option value="only" {% if deleted_mode == 'only' %}selected{% endif %}>Only</option>
                      </select>
                    </div>
                  {% endif %}
                </div>

                <div class="filterbox-footer">
                  <a class="filterbar-clear {% if not filters_active %}is-disabled{% endif %}" href="{{ url_for('map_view') }}">Clear</a>
                </div>

              </div>
            </div>
          </form>
        </div>

        <div class="filters-footer">
          <div class="filters-footer-links">
            <a href="{{ url_for('privacy') }}">Privacy</a>
            <span class="dot">·</span>
            <a href="{{ url_for('terms') }}">Terms</a>
            <span class="dot">·</span>
            <a href="{{ url_for('cookies') }}">Cookie Policy</a>
          </div>
          <div class="filters-footer-meta">© 2025–2026 EnforcedSpeed™ · Developed by Conor Gordon · Mindra LLC</div>
        </div>
      </div>
    </aside>

    <main class="home-center">
      <div class="card ticket-card map-card">

        {% if not maps_api_key %}
          <div class="subtle" style="margin-top:12px;">
            Google Maps key not configured. Set <code>GOOGLE_MAPS_API_KEY</code> to enable the map.
          </div>
        {% else %}
          <div class="map-frame">
            <div class="map-pill-row" aria-label="Map region header">
              <div class="map-title-pill" id="esMapTitlePill">{{ region_title if region_title else 'United States' }}</div>

              {% if follow_county_geoid %}
                {% if current_user.is_authenticated %}
                  <button
                    type="button"
                    class="map-follow-pill {% if follow_is_following %}is-following{% endif %}"
                    id="esFollowPill"
                    data-geoid="{{ follow_county_geoid }}"
                    aria-label="Follow county"
                  >{% if follow_is_following %}Following{% else %}Follow{% endif %}</button>

                  <form id="esFollowForm" style="display:none;">
                    {{ follow_form.csrf_token }}
                    <input type="hidden" name="county_geoid" value="{{ follow_county_geoid }}">
                    <input type="hidden" name="next" value="{{ request.full_path }}">
                  </form>
                {% else %}
                  <a class="map-follow-pill" href="{{ follow_login_url or url_for('login', next=request.full_path) }}">Follow</a>
                {% endif %}
              {% endif %}
            </div>
            <div class="map-zoom-controls" aria-label="Map zoom controls">
              <button type="button" class="map-zoom-btn" id="esZoomIn" aria-label="Zoom in">+</button>
              <button type="button" class="map-zoom-btn" id="esZoomOut" aria-label="Zoom out">−</button>
            </div>
            <div id="esMap"></div>
          </div>
        {% endif %}
      </div>
    </main>

    <aside class="home-right map-right" aria-label="Selected ticket">
      <div class="card mini-ticket" id="esSelectedTicketCard">
        {% if selected_ticket %}
          <div class="mini-title">{{ selected_ticket.road_name or 'Road' }}, {{ (selected_ticket.state or '')[:2] }}</div>
          <div class="mini-sub">{{ selected_ticket.posted_speed }} → {{ selected_ticket.ticketed_speed }} mph
            {% set _ov = (selected_ticket.ticketed_speed|int - selected_ticket.posted_speed|int) %}
            <span style="opacity:.75;">(+{{ _ov }} mph)</span>
          </div>
          <div class="mini-sub" style="margin-top:6px;"><a href="{{ url_for('result', report_id=selected_ticket.id) }}">View ticket</a></div>
        {% else %}
          <div class="mini-title">Select a pin</div>
          <div class="mini-sub">Click a pin on the map to see its ticket details here.</div>
        {% endif %}
      </div>

      <div class="card stat-card" id="esCountyStatsCard">
        <div class="stat-title">{% if region_title %}{{ region_title }}{% else %}Select a county or state{% endif %}</div>

        <div class="stat-row">
          <div class="stat-k">Pins shown</div>
          <div class="stat-v" id="esMapMeta">—</div>
        </div>

        {% if region_stats and region_stats.ok %}
          <div class="stat-row"><div class="stat-k">Total (all time)</div><div class="stat-v">{{ region_stats.total_all }}</div></div>
          <div class="stat-row"><div class="stat-k">Last 7 days</div><div class="stat-v">{{ region_stats.total_7 }}</div></div>
          <div class="stat-row"><div class="stat-k">Last 30 days</div><div class="stat-v">{{ region_stats.total_30 }}</div></div>
          <div class="stat-row"><div class="stat-k">Last 1 year</div><div class="stat-v">{{ region_stats.total_365 }}</div></div>

          <div style="margin-top:10px; font-weight:600;">Avg overage by posted speed</div>
          <table class="speed-table" aria-label="Average overage by posted speed">
            <thead>
              <tr><th>Posted</th><th>Avg over</th></tr>
            </thead>
            <tbody>
              {% for row in region_stats.by_posted %}
                <tr>
                  <td>{{ row.posted }} mph</td>
                  <td>+{{ row.avg_over }} mph</td>
                </tr>
              {% endfor %}
              {% if (region_stats.by_posted|length) == 0 %}
                <tr><td colspan="2" style="opacity:.75;">No data yet.</td></tr>
              {% endif %}
            </tbody>
          </table>
        {% else %}
          
        {% endif %}
      </div>
    </aside>

</div>

{% if maps_api_key %}
  <script>
    let ES_MAP;
    let ES_INFO;
    let ES_MARKERS = [];
    let ES_FOCUS = { type: null, value: null };
    let ES_PINS_DEBOUNCE;

    // Follow/Following pill (county focus only)
    (function(){
      const btn = document.getElementById('esFollowPill');
      if(!btn) return;

      const form = document.getElementById('esFollowForm');
      function _get(name){
        if(!form) return '';
        const el = form.querySelector(`input[name="${name}"]`);
        return el ? (el.value || '') : '';
      }

      btn.addEventListener('click', async function(){
        const geoid = (btn.getAttribute('data-geoid') || '').trim();
        if(!geoid) return;

        btn.disabled = true;
        try{
          const csrf = _get('csrf_token');
          const nextUrl = _get('next') || window.location.pathname + window.location.search;

          const body = new URLSearchParams();
          body.set('csrf_token', csrf);
          body.set('county_geoid', geoid);
          body.set('next', nextUrl);

          const resp = await fetch('{{ url_for("api_toggle_follow_county") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            credentials: 'same-origin',
            body: body.toString(),
          });

          const data = await resp.json().catch(()=>null);

          if(resp.status === 401 && data && data.login_url){
            window.location.href = data.login_url;
            return;
          }

          if(!data || !data.ok){
            // Best-effort: do nothing besides re-enable.
            return;
          }

          const following = !!data.following;
          btn.textContent = following ? 'Following' : 'Follow';
          btn.classList.toggle('is-following', following);
        } finally {
          btn.disabled = false;
        }
      });
    })();

    // Pin style (Option 3: classic teardrop + thicker outline)
    // Pin colors (unified scheme across site):
    // - Selected: Deep red (the primary pin)
    // - In-focus context: Mid-gray
    // - Out-of-focus context: Same gray, ghosted
    const ES_PIN_COLORS = {
      selected: '#dc2626', // deep red
      inside:   '#a1a1aa', // mid gray
      outside:  '#d4d4d8'  // ghost gray
    };

    function esSvgPinDataUrl(fill) {
      const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
  <path d="M24 46c-7.2-10.1-14-17.4-14-26.1C10 11.4 16.3 5 24 5s14 6.4 14 14.9C38 28.6 31.2 35.9 24 46z"
        fill="${fill}" stroke="rgba(0,0,0,0.55)" stroke-width="1.6"/>
  <circle cx="24" cy="19.8" r="6.0" fill="#111827" opacity="0.22"/>
</svg>`;
      return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg.trim());
    }

    const ES_PIN_ICON_CACHE = {
      selected: null,
      inside: null,
      outside: null
    };

    function esGetPinIcon(kind) {
      const k = (kind || 'inside');
      if (ES_PIN_ICON_CACHE[k]) return ES_PIN_ICON_CACHE[k];
      // Use hosted PNG assets (so Static Maps + interactive map can share the exact same art).
      const url = ({
        // Selected pin is deep red.
        selected: '/static/img/pins/pin_inside_deepred.png',
        // In-focus context pins are mid-gray.
        inside:   '/static/img/pins/pin_outside_warmgray.png',
        // Out-of-focus context pins are the same gray, ghosted.
        outside:  '/static/img/pins/pin_outside_ghostgray.png'
      }[k] || '/static/img/pins/pin_inside_deepred.png');
      // Keep sizing consistent across all colors.
      const scaledSize = new google.maps.Size(36, 36);
      const anchor = new google.maps.Point(18, 35);
      ES_PIN_ICON_CACHE[k] = { url, scaledSize, anchor };
      return ES_PIN_ICON_CACHE[k];
    }

    function esClearMarkers() {
      for (const m of ES_MARKERS) {
        try { m.setMap(null); } catch(e) {}
      }
      ES_MARKERS = [];
    }

    function esUpdateSelectedCard(p) {
      const el = document.getElementById('esSelectedTicketCard');
      if (!el || !p) return;
      const title = `${p.road || 'Road'}, ${p.state || ''}`;
      const over = (Number(p.ticketed) - Number(p.posted));
      el.innerHTML = `
        <div class="mini-title">${title}</div>
        <div class="mini-sub">${p.posted} → ${p.ticketed} mph <span style="opacity:.75;">(+${over} mph)</span></div>
        <div class="mini-sub" style="margin-top:6px;"><a href="/result/${p.id}">View ticket</a></div>
      `;
    }

    async function esLoadCountyGeomIfAny() {
  const params = new URLSearchParams(window.location.search);
  const geoid = (params.get('focus_county_geoid') || params.get('county_geoid') || params.get('county') || '').trim();
  if (!geoid) return { ok: false };

  try {
    const res = await fetch(`/api/county_geom/${encodeURIComponent(geoid)}`, { headers: { 'Accept': 'application/json' } });
    const data = await res.json();
    if (!data || !data.ok || !data.geojson) return { ok: false };

    try {
      ES_MAP.data.forEach((f) => ES_MAP.data.remove(f));
    } catch(e) {}

    ES_MAP.data.addGeoJson(data.geojson);
    ES_MAP.data.setStyle({ strokeWeight: 2, fillOpacity: 0.08 });

    const bounds = new google.maps.LatLngBounds();
    function processGeom(g) {
      if (!g) return;
      if (g instanceof google.maps.LatLng) {
        bounds.extend(g);
        return;
      }
      if (g.get) {
        // Data.Point
        const p = g.get();
        if (p) bounds.extend(p);
        return;
      }
      if (g.getArray) {
        for (const part of g.getArray()) processGeom(part);
      }
    }

    ES_MAP.data.forEach(function(feature){
      const geom = feature.getGeometry();
      if (geom) processGeom(geom);
    });

    try {
      if (!bounds.isEmpty()) {
        // Fit to the county boundary, then nudge one zoom level closer (tighter county view).
        ES_MAP.fitBounds(bounds, { top: 24, right: 24, bottom: 24, left: 24 });
        google.maps.event.addListenerOnce(ES_MAP, 'bounds_changed', () => {
          try {
            const z = ES_MAP.getZoom();
            if (typeof z === 'number') ES_MAP.setZoom(Math.min(z + 1, 18));
          } catch(e) {}
        });
      }
    } catch(e) {}

    ES_FOCUS = { type: 'county', value: data.geoid || geoid };
    return { ok: true, geoid: data.geoid, centroid: data.centroid || null };
  } catch(e) {
    return { ok: false };
  }
}


async function esLoadStateGeomIfAny() {
  const params = new URLSearchParams(window.location.search);
  const geoid = (params.get('focus_county_geoid') || params.get('county_geoid') || params.get('county') || '').trim();
  if (geoid) return { ok: false }; // county wins

  const st = (params.get('focus_state') || params.get('state') || '').trim().toUpperCase();
  if (!st || st.length !== 2) return { ok: false };

  try {
    const res = await fetch(`/api/state_geom/${encodeURIComponent(st)}`, { headers: { 'Accept': 'application/json' } });
    const data = await res.json();
    if (!data || !data.ok || !data.geojson) return { ok: false };

    try {
      ES_MAP.data.forEach((f) => ES_MAP.data.remove(f));
    } catch(e) {}

    ES_MAP.data.addGeoJson(data.geojson);
    ES_MAP.data.setStyle({ strokeWeight: 2, fillOpacity: 0.08 });

    const bounds = new google.maps.LatLngBounds();
    function processGeom(g) {
      if (!g) return;
      if (g instanceof google.maps.LatLng) { bounds.extend(g); return; }
      if (g.get) { const p = g.get(); if (p) bounds.extend(p); return; }
      if (g.getArray) { for (const part of g.getArray()) processGeom(part); }
    }

    ES_MAP.data.forEach(function(feature){
      const geom = feature.getGeometry();
      if (geom) processGeom(geom);
    });

    try {
      if (!bounds.isEmpty()) {
        ES_MAP.fitBounds(bounds, { top: 24, right: 24, bottom: 24, left: 24 });
      }
    } catch(e) {}

    ES_FOCUS = { type: 'state', value: (data.stusps || st) };
    return { ok: true, stusps: data.stusps || st, centroid: data.centroid || null };
  } catch(e) {
    return { ok: false };
  }
}

async function esLoadBoundaryGeomIfAny() {
  const countyFocus = await esLoadCountyGeomIfAny();
  if (countyFocus && countyFocus.ok) return countyFocus;
  const stateFocus = await esLoadStateGeomIfAny();
  if (stateFocus && stateFocus.ok) return stateFocus;
  return { ok: false };
}

function esGetViewportBoundsParams() {
  try {
    const b = ES_MAP.getBounds();
    if (!b) return null;
    const ne = b.getNorthEast();
    const sw = b.getSouthWest();
    if (!ne || !sw) return null;
    return {
      north: ne.lat(),
      south: sw.lat(),
      east: ne.lng(),
      west: sw.lng(),
    };
  } catch(e) {
    return null;
  }
}

async function esLoadPins(opts) {
  opts = opts || {};
  const meta = document.getElementById('esMapMeta');
  if (meta) meta.textContent = 'Loading pins...';

  const params = new URLSearchParams(window.location.search);
  const vp = esGetViewportBoundsParams();
  if (vp) {
    params.set('north', String(vp.north));
    params.set('south', String(vp.south));
    params.set('east', String(vp.east));
    params.set('west', String(vp.west));
  }

  // Also pass focus through explicitly for the API (lets focus work without filtering).
  if (ES_FOCUS && ES_FOCUS.type === 'state' && ES_FOCUS.value) {
    params.set('focus_state', String(ES_FOCUS.value));
  }
  if (ES_FOCUS && ES_FOCUS.type === 'county' && ES_FOCUS.value) {
    params.set('focus_county_geoid', String(ES_FOCUS.value));
  }

  // context_mode=1 tells the API to keep focus for coloring but NOT hard-filter pins to the focus area.
  if (ES_FOCUS && ES_FOCUS.type && ES_FOCUS.value) {
    params.set('context_mode', '1');
  }

  const url = '/api/map_pins?' + params.toString();
  const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
  const data = await res.json();

  if (!data || !data.ok) {
    if (meta) meta.textContent = 'Could not load pins.';
    return;
  }

  esClearMarkers();
  const pins = data.pins || [];
  if (meta) {
    if (data.inside_count != null && ES_FOCUS && ES_FOCUS.type && ES_FOCUS.value) {
      meta.textContent = String(data.inside_count) + ' in focus • ' + pins.length + ' pins shown (max 1500).';
    } else {
      meta.textContent = pins.length + ' pins shown (max 1500).';
    }
  }

  const selectedId = (data.selected_id != null) ? String(data.selected_id) : null;

  let bounds = new google.maps.LatLngBounds();
  for (const p of pins) {
    if (p.lat == null || p.lng == null) continue;
    const pos = { lat: Number(p.lat), lng: Number(p.lng) };
    bounds.extend(pos);

    const isSelected = (selectedId && String(p.id) === selectedId);
    const isInside = !!p.inside_focus;
    const icon = isSelected ? esGetPinIcon('selected') : (isInside ? esGetPinIcon('inside') : esGetPinIcon('outside'));

    const m = new google.maps.Marker({ position: pos, map: ES_MAP, icon: icon, zIndex: (isSelected ? 999999 : undefined) });
    m.addListener('click', () => {
      const title = `${p.road || 'Road'}, ${p.state || ''}`;
      const over = (Number(p.ticketed) - Number(p.posted));
      const html = `
        <div style="font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width:240px;">
          <div style="font-weight:600; margin-bottom:4px;">${title}</div>
          <div style="font-size:13px;">${p.posted} → ${p.ticketed} mph <span style="opacity:.75;">(+${over})</span></div>
          <div style="font-size:13px; margin-top:6px;"><a href="/result/${p.id}">View ticket</a></div>
        </div>
      `;
      ES_INFO.setContent(html);
      ES_INFO.open({ anchor: m, map: ES_MAP });

      // Also populate the right-side selected ticket card.
      esUpdateSelectedCard(p);
    });
    ES_MARKERS.push(m);
  }

  try {
    if (pins.length > 0 && !opts.skipFit) {
      ES_MAP.fitBounds(bounds);
    }
  } catch(e) {}
}

window.esInitMap = async function() {
  ES_MAP = new google.maps.Map(document.getElementById('esMap'), {
    center: { lat: 39.5, lng: -98.35 },
    zoom: 4,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false,
    gestureHandling: "greedy",
  });
  ES_INFO = new google.maps.InfoWindow();

  // Custom zoom controls (+ / -) that are always available (even without a mouse wheel)
  (function esWireZoomControls(){
    const zin = document.getElementById('esZoomIn');
    const zout = document.getElementById('esZoomOut');
    if (!zin || !zout) return;

    const Z_MIN = 2;
    const Z_MAX = 20;

    function clampZoom(z){
      if (typeof z !== 'number') return z;
      return Math.max(Z_MIN, Math.min(Z_MAX, z));
    }

    function updateDisabled(){
      try {
        const z = ES_MAP.getZoom();
        zin.disabled = (typeof z === 'number') ? (z >= Z_MAX) : false;
        zout.disabled = (typeof z === 'number') ? (z <= Z_MIN) : false;
      } catch(e) {}
    }

    zin.addEventListener('click', function(){
      try {
        const z = ES_MAP.getZoom();
        ES_MAP.setZoom(clampZoom((typeof z === 'number' ? z : 10) + 1));
      } catch(e) {}
    });

    zout.addEventListener('click', function(){
      try {
        const z = ES_MAP.getZoom();
        ES_MAP.setZoom(clampZoom((typeof z === 'number' ? z : 10) - 1));
      } catch(e) {}
    });

    ES_MAP.addListener('zoom_changed', updateDisabled);
    updateDisabled();
  })();

  const focus = await esLoadBoundaryGeomIfAny();

  // Initial pin load
  await esLoadPins({ skipFit: focus && focus.ok });

  // Refresh pins as the viewport changes (debounced)
  ES_MAP.addListener('idle', () => {
    clearTimeout(ES_PINS_DEBOUNCE);
    ES_PINS_DEBOUNCE = setTimeout(() => {
      esLoadPins({ skipFit: true });
    }, 220);
  });
}
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key|urlencode }}&callback=esInitMap"></script>
{% endif %}

<script>
  // Multi-select dropdown behavior (speed limit + overage):
  // - Do NOT submit on each checkbox click (allows multi-select)
  // - Close on outside click or Done, keeping selections
  // - Submit when the dropdown closes if selections changed
  (function(){
    var form = document.getElementById("mapFilters");
    if(!form) return;

    function textOf(cb){
      return cb.getAttribute("data-label") || "";
    }

    function updateSummary(d){
      var summary = d.querySelector(".multi-summary");
      if(!summary) return;
      var checks = Array.prototype.slice.call(d.querySelectorAll("input[type=checkbox]"));
      var selected = checks.filter(function(c){ return c.checked; }).map(textOf).filter(Boolean);
      summary.textContent = selected.length ? selected.join(", ") : "Any";
    }

    function submitIfDirty(d){
      if(!d || !d._dirty) return;
      if(d._submitting) return;
      d._submitting = true;
      d._dirty = false;
      form.submit();
    }

    var multis = Array.prototype.slice.call(form.querySelectorAll("details[data-multi]"));
    multis.forEach(function(d){
      d._dirty = false;
      d._submitting = false;
      updateSummary(d);

      d.addEventListener("change", function(e){
        if(e.target && e.target.matches && e.target.matches("input[type=checkbox]")){
          d._dirty = true;
          updateSummary(d);
        }
      });

      var done = d.querySelector("[data-multi-done]");
      if(done){
        done.addEventListener("click", function(ev){
          ev.preventDefault();
          d.open = false;
          submitIfDirty(d);
        });
      }

      d.addEventListener("toggle", function(){
        if(!d.open){
          submitIfDirty(d);
        }
      });
    });

    document.addEventListener("click", function(e){
      multis.forEach(function(d){
        if(!d.open) return;
        if(d.contains(e.target)) return;
        d.open = false;
        submitIfDirty(d);
      });
    });
  })();
</script>

{% endblock %}
