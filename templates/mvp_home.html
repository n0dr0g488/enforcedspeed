{% extends "base.html" %}
{% block content %}

    <div class="wrap">
      <div class="card">
        



        
        <div class="submit-title">Received a speeding ticket? Submit your details to see how you compare.</div>
        <div class="submit-note">
          {% if current_user.is_authenticated %}
            Submissions from logged-in users help improve trust and credibility.
          {% else %}
            <a href="{{ url_for('login', next='/submit') }}">Log in</a> or <a href="{{ url_for('register', next='/submit') }}">create an account</a> · Submissions from logged-in users help improve trust and credibility.
          {% endif %}
        </div>

<form method="post" action="{{ url_for('submit_ticket') }}" id="ticketForm" enctype="multipart/form-data">
          {{ form.hidden_tag() }}

          <input type="hidden" id="city_place_id" name="city_place_id" value="" />

          <div class="stepper">
            <div class="stepper-row">
              <div class="stepper-item" id="stepLabel1"><span class="stepper-num">1</span> Location</div>
              <div class="stepper-item" id="stepLabel2"><span class="stepper-num">2</span> Pin & Road</div>
              <div class="stepper-item" id="stepLabel3"><span class="stepper-num">3</span> Photo (optional)</div>
            </div>
          </div>

          <!-- STEP 1 -->
          <div class="step" id="step1">
            <div class="submit-inline-row" style="grid-template-columns: 1fr 260px; align-items:start;">
              <div>
                <label for="city_query">Nearest city / town</label>
                <!-- Anchor the autocomplete dropdown to this relative wrapper (matches road autocomplete styling) -->
                <div class="submit-inline-row__road">
                  <input id="city_query" type="text" autocomplete="off" placeholder="Start typing a city…" />
                  <div id="citySuggest" class="road-suggest" style="display:none;"></div>
                </div>
                <div class="subtle" style="margin-top:6px;">
                  Pick the nearest city/town to the ticket location. This helps us auto-fill the state and center the map.
                </div>
              </div>
              <div>
                <label for="state_display">State</label>
                <input id="state_display" type="text" disabled placeholder="Auto-filled from city" />
                <!-- Keep the real state field hidden but populated -->
                <div style="display:none;">
                  {{ form.state(id="state", list="state_list") }}
                  <datalist id="state_list">
                    {% for s in state_options %}
                      <option value="{{ s }}"></option>
                    {% endfor %}
                  </datalist>
                </div>
              </div>
            </div>


            <div class="submit-inline-row" style="grid-template-columns: 1fr 1fr;">
              <div>
                <label for="posted_speed">{{ form.posted_speed.label.text }}</label>
                {{ form.posted_speed(id="posted_speed", placeholder="e.g., 65") }}
              </div>
              <div>
                <label for="ticketed_speed">{{ form.ticketed_speed.label.text }}</label>
                {{ form.ticketed_speed(id="ticketed_speed", placeholder="e.g., 77") }}
              </div>
            </div>

            <input type="hidden" id="route_class" name="route_class" value="" />

<div class="submit-inline-row" style="grid-template-columns: 1fr;">
  <label>Road type</label>

  <div class="route-class-grid" id="routeClassGrid">
    <button type="button" class="route-card" data-val="interstate" aria-pressed="false">
      <img class="route-icon-img" src="{{ url_for('static', filename='img/route_interstate.png') }}" alt="Interstate shield">
      <div class="route-title">Interstate</div>
</button>

    <button type="button" class="route-card" data-val="numbered" aria-pressed="false">
      <img class="route-icon-img" src="{{ url_for('static', filename='img/route_numbered.png') }}" alt="Numbered route shield">
      <div class="route-title">Route / Highway</div>
</button>

    <button type="button" class="route-card" data-val="local" aria-pressed="false">
      <img class="route-icon-img" src="{{ url_for('static', filename='img/route_local.png') }}" alt="Local street sign">
      <div class="route-title">Street</div>
</button>
  </div>
</div>


            <div class="subtle" id="step1Err" style="margin-top:10px; color:#991b1b; display:none;"></div>

            <div class="submit-inline-row" style="grid-template-columns: 1fr; margin-top:14px;">
              <button type="button" class="btn" id="step1Next">Next: place pin on map</button>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="step" id="step2" style="display:none;">
<div class="submit-inline-row" style="grid-template-columns: 1fr;">
  <div class="subtle">Preview your pin and road. Use “Edit pin” if you need to adjust.</div>
</div>

<div id="pinPreviewWrap" class="pin-preview-wrap" style="display:none;">
  <img id="pinPreviewImg" class="pin-preview-img" src="" alt="Location preview">
  <div class="subtle" style="margin-top:6px;"><a href="#" id="editPinLink">Edit pin</a></div>
</div>

<div class="subtle" id="pinStatus" style="margin-top:10px; display:none;"></div>

<div id="roadWrap" style="display:none;">

            <div class="submit-inline-row" style="grid-template-columns: 1fr;">
              <label for="road_name">Road (auto-detected)</label>
              {{ form.road_name(id="road_name", autocomplete="off", readonly=True) }}
              <div class="subtle" style="margin-top:6px;">
                Road is auto-detected from the pin. <a href="#" id="editRoadLink">Edit</a>
              </div>
            </div>
            </div>


            <div class="subtle" id="step2Err" style="margin-top:10px; color:#991b1b; display:none;"></div>

            <div class="submit-inline-row" style="grid-template-columns: 1fr 1fr; gap:12px;">
              <button type="button" class="btn btn-secondary" id="step2Back">Back</button>
              <button type="button" class="btn" id="step2Next">Looks good: add photo (optional)</button>
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="step" id="step3" style="display:none;">
            <div class="submit-inline-row" style="grid-template-columns: 1fr;">
              <label for="photo">{{ form.photo.label.text }}</label>
              {{ form.photo(id="photo") }}
              <div class="subtle" style="margin-top:8px;">
                Uploaded photos are used only to attempt OCR verification and are automatically deleted shortly after processing (and always within 24 hours).
              </div>
            </div>

            <div class="submit-inline-row" style="grid-template-columns: 1fr 1fr; gap:12px;">
              <button type="button" class="btn btn-secondary" id="step3Back">Back</button>
              <button type="submit" class="btn">Submit ticket</button>
            </div>
          </div>

<!-- Pin confirm modal (Google Maps) -->
<div id="pinModal" class="modal" style="display:none;">
  <div class="modal-backdrop" id="pinModalBackdrop"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pinModalTitle">
    <div class="modal-title" id="pinModalTitle">Confirm location</div>
    <div class="subtle" style="margin-top:6px;">
      Drag the pin to the closest spot on the road, then confirm. We'll snap it to the nearest road line.
    </div>
    <div id="pinMap" style="width:100%; height:340px; margin-top:12px; border:1px solid #e5e7eb; border-radius:12px;"></div>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" id="cancelPin">Cancel</button>
      <button type="button" class="btn" id="savePin">Confirm location</button>
    </div>
    <div class="subtle" id="pinModalMsg" style="margin-top:8px;"></div>
  </div>
</div>

<style>
  .stepper{margin: 14px 0 18px;}
  .stepper-row{display:flex; gap:14px; flex-wrap:wrap;}
  .stepper-item{display:flex; align-items:center; gap:8px; font-weight:600; color:#0f172a;}
  .stepper-num{display:inline-flex; width:22px; height:22px; border-radius:999px; align-items:center; justify-content:center; background:#0f172a; color:#fff; font-size:12px;}
  .modal{position:fixed;inset:0;z-index:2000;}
  .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.35);}
  .modal-card
  {position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(92vw,720px);background:#fff;border-radius:14px;padding:18px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);}
  .modal-title{font-weight:700;font-size:18px;}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;}

  .route-class-grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:8px;}
  @media (max-width: 640px){
    .route-class-grid{grid-template-columns: 1fr;}
  }
  .route-card{display:flex; flex-direction:column; align-items:center; gap:8px; padding:12px; border-radius:14px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; text-align:center;}
  .route-card[aria-pressed="true"]{border-color:#0f172a; box-shadow:0 0 0 2px rgba(15,23,42,0.15);}
  .route-icon-img{width:84px; height:64px; object-fit:contain; display:block; margin:0 auto;}
  .route-card[data-val="interstate"] .route-icon-img{transform:scale(1.35); transform-origin:center;}
.route-card[data-val="local"] .route-icon-img{transform:scale(1.2); transform-origin:center;}

.pin-preview-wrap{margin-top:12px;}
.pin-preview-img{width:100%; max-width:100%; height:auto; display:block; border-radius:12px; border:1px solid #e5e7eb;}

  .route-title{font-weight:800; color:#0f172a;}
  .route-subtle{font-size:12px; color:#475569;}
</style>

        </form>

      </div>
    </div>

    
<script defer src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&v=weekly"></script>

<script>
  // Elements
  const formEl = document.getElementById("ticketForm");
  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const step3 = document.getElementById("step3");

  const cityInput = document.getElementById("city_query");
  const citySuggest = document.getElementById("citySuggest");
  const cityPlaceIdEl = document.getElementById("city_place_id");

  const stateHidden = document.getElementById("state");
  const stateDisplay = document.getElementById("state_display");

  const postedEl = document.getElementById("posted_speed");
  const ticketedEl = document.getElementById("ticketed_speed");

  const step1Err = document.getElementById("step1Err");
  const step2Err = document.getElementById("step2Err");

  const step1Next = document.getElementById("step1Next");
  const step2Back = document.getElementById("step2Back");
  const step2Next = document.getElementById("step2Next");
  const step3Back = document.getElementById("step3Back");

  const roadEl = document.getElementById("road_name");
  const editRoadLink = document.getElementById("editRoadLink");
  const routeClassGrid = document.getElementById("routeClassGrid");
  const pinModal = document.getElementById("pinModal");
  const pinModalBackdrop = document.getElementById("pinModalBackdrop");
  const cancelPinBtn = document.getElementById("cancelPin");
  const savePinBtn = document.getElementById("savePin");
  const pinStatus = document.getElementById("pinStatus");
  const pinModalMsg = document.getElementById("pinModalMsg");

const editPinLink = document.getElementById("editPinLink");
const pinPreviewWrap = document.getElementById("pinPreviewWrap");
const pinPreviewImg = document.getElementById("pinPreviewImg");
const roadWrap = document.getElementById("roadWrap");
const routeExInterstate = document.getElementById("routeExInterstate");
const routeExNumbered = document.getElementById("routeExNumbered");
const routeExLocal = document.getElementById("routeExLocal");

  const rawLatEl = document.getElementById("raw_lat");
  const rawLngEl = document.getElementById("raw_lng");
  const latEl = document.getElementById("lat");
  const lngEl = document.getElementById("lng");
  const googlePlaceIdEl = document.getElementById("google_place_id");

  // State
  let selectedCity = null;   // { place_id, description }
  let cityCenter = null;     // { lat, lng }
  let pinConfirmed = false;
  let map = null;
  let marker = null;
  let cityDebounce = null;

  function showStep(n) {
    step1.style.display = (n === 1) ? "" : "none";
    step2.style.display = (n === 2) ? "" : "none";
    step3.style.display = (n === 3) ? "" : "none";
  }

  function showErr(el, msg) {
    el.textContent = msg;
    el.style.display = msg ? "" : "none";
  }

  function parseIntSafe(v) {
    const n = parseInt(String(v || "").trim(), 10);
    return Number.isFinite(n) ? n : null;
  }

  function validateStep1() {
    showErr(step1Err, "");
    const posted = parseIntSafe(postedEl?.value);
    const ticketed = parseIntSafe(ticketedEl?.value);

    if (!selectedCity || !selectedCity.place_id) {
      showErr(step1Err, "Select a city/town from the suggestions.");
      return false;
    }
    if (!stateHidden || !stateHidden.value) {
      showErr(step1Err, "State did not auto-fill. Pick a different city/town.");
      return false;
    }
    if (posted == null || posted <= 0) {
      showErr(step1Err, "Enter a valid posted speed.");
      return false;
    }
    if (ticketed == null || ticketed <= 0) {
      showErr(step1Err, "Enter a valid ticketed speed.");
      return false;
    }
    if (ticketed <= posted) {
      showErr(step1Err, "Ticketed speed must be greater than posted speed.");
      return false;
    }
    return true;
  }

  function validateStep2() {
    showErr(step2Err, "");
    const rcEl = document.getElementById("route_class");
    const rcVal = (rcEl?.value || "").trim();
    if (!rcVal) {
      showErr(step2Err, "Pick a road type first: Interstate, US Route, or Other.");
      return false;
    }
    if (!pinConfirmed) {
      showErr(step2Err, "Confirm a pin on the map first.");
      return false;
    }
    if (!roadEl || !roadEl.value || roadEl.value.trim().length < 2) {
      showErr(step2Err, "Road is required. Edit the road name if auto-detection was wrong.");
      return false;
    }
    if (!latEl || !lngEl || !latEl.value || !lngEl.value) {
      showErr(step2Err, "Missing coordinates. Confirm the pin again.");
      return false;
    }
    return true;
  }

  function closeCitySuggest() {
    citySuggest.style.display = "none";
    citySuggest.innerHTML = "";
  }

  async function fetchCitySuggest(q) {
    const url = `/api/city_autocomplete?q=${encodeURIComponent(q)}`;
    const r = await fetch(url, { credentials: "same-origin" });
    return await r.json();
  }

  async function fetchCityDetails(placeId) {
    const url = `/api/city_details?place_id=${encodeURIComponent(placeId)}`;
    const r = await fetch(url, { credentials: "same-origin" });
    return await r.json();
  }
async function fetchRouteExamples(stateCode) {
  const url = `/api/route_examples?state=${encodeURIComponent(stateCode)}`;
  const r = await fetch(url, { credentials: "same-origin" });
  return await r.json();
}


  function renderCitySuggest(predictions) {
    if (!predictions || predictions.length === 0) {
      closeCitySuggest();
      return;
    }
    citySuggest.innerHTML = predictions.map(p => {
      const main = p.main_text || p.description || "";
      const sec = p.secondary_text || "";
      return `<div class="road-suggest-item" data-place-id="${p.place_id}" data-desc="${encodeURIComponent(p.description || "")}">
                <div class="road-suggest-main">${main}</div>
                <div class="road-suggest-sub">${sec}</div>
              </div>`;
    }).join("");
    citySuggest.style.display = "";
  }

  cityInput?.addEventListener("input", () => {
    const q = (cityInput.value || "").trim();
    selectedCity = null;
    cityPlaceIdEl.value = "";
    if (googlePlaceIdEl) googlePlaceIdEl.value = "";
    stateDisplay.value = "";
    if (stateHidden) stateHidden.value = "";
    cityCenter = null;
    pinConfirmed = false;
    pinStatus.style.display = "none";
    roadEl.value = "";
    roadEl.readOnly = true;
    if (roadWrap) roadWrap.style.display = "none";
    if (pinPreviewWrap) pinPreviewWrap.style.display = "none";
    if (pinPreviewImg) pinPreviewImg.removeAttribute("src");
    if (step2Next) step2Next.textContent = "Next: place pin on map";
    const rcEl = document.getElementById("route_class");
    if (rcEl) rcEl.value = "";
    routeClassGrid?.querySelectorAll?.("button.route-card")?.forEach?.((b) => b.setAttribute("aria-pressed","false"));
    if (routeExInterstate) routeExInterstate.textContent = "Examples: —";
    if (routeExNumbered) routeExNumbered.textContent = "Examples: —";
    if (routeExLocal) routeExLocal.textContent = "Examples: —";

    if (q.length < 2) {
      closeCitySuggest();
      return;
    }
    clearTimeout(cityDebounce);
    cityDebounce = setTimeout(async () => {
      try {
        const data = await fetchCitySuggest(q);
        if (!data.ok) {
          closeCitySuggest();
          return;
        }
        renderCitySuggest(data.predictions || []);
      } catch (e) {
        closeCitySuggest();
      }
    }, 250);
  });

  citySuggest?.addEventListener("click", async (e) => {
    const item = e.target?.closest?.(".road-suggest-item");
    if (!item) return;

    const placeId = item.getAttribute("data-place-id");
    const desc = decodeURIComponent(item.getAttribute("data-desc") || "");
    selectedCity = { place_id: placeId, description: desc };
    cityPlaceIdEl.value = placeId || "";
    if (googlePlaceIdEl) googlePlaceIdEl.value = placeId || "";
    cityInput.value = desc;
    closeCitySuggest();

    try {
      const data = await fetchCityDetails(placeId);
      if (!data.ok) {
        showErr(step1Err, "Couldn't resolve that city. Try another.");
        return;
      }
      if (data.state_value) {
        stateDisplay.value = data.state_value;
        if (stateHidden) stateHidden.value = data.state_value;
      } else if (data.state_code) {
        stateDisplay.value = data.state_code;
        if (stateHidden) stateHidden.value = data.state_code;
      }

      // Populate route examples for this state
if (typeof data.lat === "number" && typeof data.lng === "number") {
        cityCenter = { lat: data.lat, lng: data.lng };
      }
      showErr(step1Err, "");
    } catch (e) {
      showErr(step1Err, "Couldn't resolve that city. Try another.");
    }
  });

  document.addEventListener("click", (e) => {
    if (!citySuggest.contains(e.target) && e.target !== cityInput) {
      closeCitySuggest();
    }
  });

  step1Next?.addEventListener("click", () => {
    if (!validateStep1()) return;
    showStep(2);
    openPinModal();
  });

  step2Back?.addEventListener("click", () => showStep(1));
  step2Next?.addEventListener("click", () => {
    if (!pinConfirmed) {
      openPinModal();
      return;
    }
    if (!validateStep2()) return;
    showStep(3);
  });
  step3Back?.addEventListener("click", () => showStep(2));

  editRoadLink?.addEventListener("click", (e) => {
    e.preventDefault();
    roadEl.readOnly = false;
    roadEl.focus();
  });

  // Pin modal
  function openPinModal() {
    showErr(step2Err, "");
    if (!validateStep1()) {
      showStep(1);
      return;
    }

    const rc = (document.getElementById('route_class')?.value || '').trim();
    if (!rc) {
      showErr(step2Err, "Pick a road type in Step 1 first.");
      showStep(1);
      return;
    }
    pinModal.style.display = "";
    pinModalMsg.textContent = "";
    setTimeout(initMap, 50);
  }

  function closePinModal() {
    pinModal.style.display = "none";
  }

  function initMap() {
    if (!window.google || !google.maps) return;

    // If the user already confirmed a pin (static preview exists), start the edit-map
    // at that exact location instead of snapping back to the city-center (e.g., Richmond).
    const latEl = document.getElementById("lat");
    const lngEl = document.getElementById("lng");
    const rawLatEl = document.getElementById("raw_lat");
    const rawLngEl = document.getElementById("raw_lng");

    const existingLat = parseFloat((rawLatEl?.value || latEl?.value || "").trim());
    const existingLng = parseFloat((rawLngEl?.value || lngEl?.value || "").trim());

    const hasExisting = Number.isFinite(existingLat) && Number.isFinite(existingLng);
    const center = hasExisting
      ? { lat: existingLat, lng: existingLng }
      : (cityCenter || { lat: 39.8283, lng: -98.5795 }); // US center fallback

    // Slightly zoomed out when editing an existing pin so you can see nearby roads.
    const zoom = hasExisting ? 13 : (cityCenter ? 8 : 4);

    if (!map) {
      map = new google.maps.Map(document.getElementById("pinMap"), {
        center,
        zoom,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });
      marker = new google.maps.Marker({
        position: center,
        map,
        draggable: true,
      });
    } else {
      map.setCenter(center);
      map.setZoom(zoom);
      marker.setPosition(center);
    }
  }
  editPinLink?.addEventListener("click", (e) => { e.preventDefault(); openPinModal(); });

  pinModalBackdrop?.addEventListener("click", closePinModal);
  cancelPinBtn?.addEventListener("click", closePinModal);

  routeClassGrid?.addEventListener('click', (e) => {
    const btn = e.target?.closest?.('button.route-card');
    if (!btn) return;
    const val = (btn.getAttribute('data-val') || '').trim();
    const hid = document.getElementById('route_class');
    if (hid) hid.value = val;

    routeClassGrid.querySelectorAll('button.route-card').forEach((b) => b.setAttribute('aria-pressed', 'false'));
    btn.setAttribute('aria-pressed', 'true');
  });


  async function fetchJsonWithTimeout(url, options, timeoutMs = 15000) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs);
    try {
      const r = await fetch(url, { ...options, signal: controller.signal });
      const text = await r.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch (_) {}

      if (!r.ok) {
        const msg = (data && (data.error || data.message)) || text || `HTTP ${r.status}`;
        throw new Error(msg);
      }
      return data;
    } finally {
      clearTimeout(t);
    }
  }

  async function confirmLocation(lat, lng) {
    return await fetchJsonWithTimeout(
      "/api/confirm_location",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({
          lat,
          lng,
          route_class: (document.getElementById('route_class')?.value || '').trim()
        }),
      },
      15000
    );
  }

  savePinBtn?.addEventListener("click", async () => {
    if (!marker) return;

    const pos = marker.getPosition();
    const rawLat = pos.lat();
    const rawLng = pos.lng();

    savePinBtn.disabled = true;
    pinModalMsg.textContent = "Confirming…";
    try {
      const data = await confirmLocation(rawLat, rawLng);
      if (!data.ok) {
        pinModalMsg.textContent = "Could not confirm location. Try again.";
        savePinBtn.disabled = false;
        return;
      }

      // Hidden fields (WTForms hidden_tag)
      if (rawLatEl) rawLatEl.value = String(data.raw_lat ?? rawLat);
      if (rawLngEl) rawLngEl.value = String(data.raw_lng ?? rawLng);
      if (latEl) latEl.value = String(data.snapped_lat ?? rawLat);
      if (lngEl) lngEl.value = String(data.snapped_lng ?? rawLng);

      if (roadEl) roadEl.value = data.road_name || "Map pin";
      roadEl.readOnly = true;

pinConfirmed = true;
if (pinStatus) {
  pinStatus.style.display = "";
  pinStatus.textContent = `Location confirmed. Road: ${roadEl.value}`;
}
if (roadWrap) roadWrap.style.display = "";
if (pinPreviewWrap && pinPreviewImg) {
  const z = cityCenter ? 12 : 5;
  pinPreviewImg.src = `/api/staticmap?lat=${encodeURIComponent(latEl.value)}&lng=${encodeURIComponent(lngEl.value)}&zoom=${z}&w=700&h=360`;
  pinPreviewWrap.style.display = "";
}
if (step2Next) step2Next.textContent = "Looks good: add photo (optional)";

closePinModal();
    } catch (e) {
      const msg = (e && e.message) ? e.message : "";
      pinModalMsg.textContent = `Could not confirm location. ${msg}`.trim();
    } finally {
      savePinBtn.disabled = false;
    }
  });

  // Final guard on submit
  formEl?.addEventListener("submit", (e) => {
    if (!validateStep1()) { e.preventDefault(); showStep(1); return; }
    if (!validateStep2()) { e.preventDefault(); showStep(2); return; }
  });

  showStep(1);
</script>

{% endblock %}
