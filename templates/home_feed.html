{% extends "base.html" %}
{% block content %}
<style>
  /* Right rail: match left filter rail (flush to edge, sharp corners) */
  .home-right{background:#fff;border-left:1px solid #e5e7eb;border-radius:0;box-shadow:none;}
  /* Two stacked blocks (mini-map + stats) but flush; divider between them */
  .rail-card{border:0;border-radius:0;background:transparent;overflow:hidden;}
  .rail-card + .rail-card{margin-top:0;border-top:1px solid #e5e7eb;}
  .rail-card-head{padding:14px 14px 12px;background:#fff;}
  .rail-section{padding:14px 14px 12px;border-top:1px solid #e5e7eb;background:#fff;}
  .rail-section:first-of-type{border-top:0;}

  /* Home right-rail minimap crop:
     Keep the underlying CONUS framing/zoom unchanged, but crop top/bottom to save vertical space. */
  .minimap-crop{height:235px; overflow:hidden; background:#f3f4f6;}
  .minimap-crop img{width:100%; height:130%; object-fit:cover; object-position:50% 42%; display:block;}

</style>


<div class="home-shell">

    {# Left sidebar: sticky filters (desktop). Collapses behind button on mobile. #}
    <aside class="home-left" id="homeFiltersSidebar">
      <div class="filters-rail">
        <div class="filters-scroll">
        <form method="get" action="{{ url_for('home') }}" class="filterbar" id="feedFilters">
          <div class="filterbox">
            <div class="filterbox-title">Filter Speeding Tickets</div>
            <div class="filterbar-row filterbar-row--stack">

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-state">State</label>
                <select id="filter-state" name="state" class="filterbar-select" onchange="this.form.submit()">
                  <option value="" {% if not filter_state %}selected{% endif %}>All states</option>
                  {% for opt in state_filter_options %}
                    <option value="{{ opt.code }}" {% if filter_state == opt.code %}selected{% endif %}>{{ opt.code }}</option>
                  {% endfor %}
                </select>
              </div>

                            <div class="filterbar-item">
                <label class="filterbar-label" for="filter-county">County</label>
                <div class="filter-autocomplete-wrap">
                  <input id="filter-county" value="{{ filter_county_label or '' }}" placeholder="Start typing (e.g., Franklin)" autocomplete="off">
                  <input type="hidden" id="filter-county-geoid" name="county_geoid" value="{{ filter_county_geoid or '' }}">
                  <div class="filter-suggestions" id="filter-county-suggestions" style="display:none"></div>
                </div>
              </div>

<div class="filterbar-item filterbar-item--tight">
                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                  <label class="filterbar-label" for="filter-verify" style="margin:0;">Photo <span class="filter-check">✓</span></label>
                  <label class="switch">
                    <input type="checkbox" id="filter-verify" name="verify" value="verified" {% if filter_verify == 'verified' %}checked{% endif %} onchange="this.form.submit()">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
<div class="filterbar-item filterbar-item--tight">
  <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
    <label class="filterbar-label" for="filter-pin" style="margin:0;">Map pin <span class="filter-check">✓</span></label>
    <label class="switch">
      <input type="checkbox" id="filter-pin" name="pin" value="1" {% if filter_pin %}checked{% endif %} onchange="this.form.submit()">
      <span class="slider"></span>
    </label>
  </div>
</div>



              <div class="filterbar-item">
  <label class="filterbar-label" for="filter-speed-limit">Posted speed limit</label>
  <select id="filter-speed-limit" name="speed_limit" class="filterbar-select" onchange="this.form.submit()">
    <option value="any" {% if (filter_speed_limit_list|length == 0) %}selected{% endif %}>Any</option>
    <option value="lte35" {% if 'lte35' in filter_speed_limit_list %}selected{% endif %}>≤ 35 mph</option>
    <option value="40-55" {% if '40-55' in filter_speed_limit_list %}selected{% endif %}>40–55 mph</option>
    <option value="gte60" {% if 'gte60' in filter_speed_limit_list %}selected{% endif %}>≥ 60 mph</option>
  </select>
</div>

              <div class="filterbar-item">
  <label class="filterbar-label" for="filter-overage">Overage (mph over)</label>
  <select id="filter-overage" name="overage" class="filterbar-select" onchange="this.form.submit()">
    <option value="all" {% if (filter_over_list|length == 0) %}selected{% endif %}>Any</option>
    <option value="1-10" {% if '1-10' in filter_over_list %}selected{% endif %}>1–10 mph over</option>
    <option value="11-20" {% if '11-20' in filter_over_list %}selected{% endif %}>11–20 mph over</option>
    <option value="21+" {% if '21+' in filter_over_list %}selected{% endif %}>≥ 21 mph over</option>
  </select>
</div>
              
              

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-date">Date</label>
                <select id="filter-date" name="date" class="filterbar-select" onchange="this.form.submit()">
                  {% for o in date_options %}
                    <option value="{{ o.value }}" {% if filter_date == o.value %}selected{% endif %}>{{ o.label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="filterbar-item">
                <label class="filterbar-label" for="filter-sort">Sort by</label>
                <select id="filter-sort" name="sort" class="filterbar-select" aria-label="Sort by" onchange="this.form.submit()">
                  <option value="new" {% if filter_sort == 'new' %}selected{% endif %}>Newest</option>
                  <option value="old" {% if filter_sort == 'old' %}selected{% endif %}>Oldest</option>
                  <option value="most_over" {% if filter_sort in ['most_over', 'least_strict'] %}selected{% endif %}>Highest overage</option>
                  <option value="least_over" {% if filter_sort in ['least_over', 'most_strict'] %}selected{% endif %}>Lowest overage</option>
</select>
              </div>

              

<div class="filterbar-item filterbar-item--tight">
{% if is_admin %}
                <div class="filterbar-rowline filterbar-rowline--tight" style="margin-top:0;">
                  <label class="filterbar-label" for="filter-deleted-mode" style="margin:0;">Deleted (admin)</label>
                  <select id="filter-deleted-mode" name="deleted" class="filter-select" onchange="this.form.submit()" style="max-width:140px;">
                    <option value="hide" {% if (deleted_mode or 'hide') == 'hide' %}selected{% endif %}>Hide</option>
                    <option value="include" {% if deleted_mode == 'include' %}selected{% endif %}>Include</option>
                    <option value="only" {% if deleted_mode == 'only' %}selected{% endif %}>Only</option>
                  </select>
                </div>
                {% endif %}
              </div>

<div class="filterbox-footer">
                <a class="filterbar-clear {% if not filters_active %}is-disabled{% endif %}" href="{{ url_for('home') }}">Clear</a>
              </div>

            </div>
          </div>

</form>
        </div>

        <div class="filters-footer">
          <div class="filters-footer-links">
          <a href="{{ url_for('privacy') }}">Privacy</a>
          <span class="dot">·</span>
          <a href="{{ url_for('terms') }}">Terms</a>
          <span class="dot">·</span>
          <a href="{{ url_for('cookies') }}">Cookie Policy</a>
        </div>
          <div class="filters-footer-meta">© 2025–2026 EnforcedSpeed™ · Developed by Conor Gordon · Mindra LLC</div>
        </div>
      </div>
    </aside>

    <script>
      // Multi-select dropdown behavior (speed limit + overage):
      // - Do NOT submit on each checkbox click (allows multi-select)
      // - Close on outside click or Done, keeping selections
      // - Submit when the dropdown closes if selections changed
      (function(){
        var form = document.getElementById("feedFilters");
        if(!form) return;

        function textOf(cb){
          return cb.getAttribute("data-label") || "";
        }

        function updateSummary(d){
          var summary = d.querySelector(".multi-summary");
          if(!summary) return;
          var checks = Array.prototype.slice.call(d.querySelectorAll("input[type=checkbox]"));
          var selected = checks.filter(function(c){ return c.checked; }).map(textOf).filter(Boolean);
          summary.textContent = selected.length ? selected.join(", ") : "Any";
        }

        function submitIfDirty(d){
          if(!d || !d._dirty) return;
          if(d._submitting) return;
          d._submitting = true;
          d._dirty = false;
          form.submit();
        }

        var multis = Array.prototype.slice.call(document.querySelectorAll("details[data-multi]"));
        multis.forEach(function(d){
          d._dirty = false;
          d._submitting = false;
          updateSummary(d);

          d.addEventListener("change", function(e){
            if(e.target && e.target.matches && e.target.matches("input[type=checkbox]")){
              d._dirty = true;
              updateSummary(d);
            }
          });

          var done = d.querySelector("[data-multi-done]");
          if(done){
            done.addEventListener("click", function(ev){
              ev.preventDefault();
              d.open = false;
              submitIfDirty(d);
            });
          }

          d.addEventListener("toggle", function(){
            if(!d.open){
              submitIfDirty(d);
            }
          });
        });

        document.addEventListener("click", function(e){
          multis.forEach(function(d){
            if(!d.open) return;
            if(d.contains(e.target)) return;
            d.open = false;
            submitIfDirty(d);
          });
        });
      })();
    </script>

    {# Main column: welcome tile + feed (unchanged) #}
    <div class="home-center">

      {# Mobile-only toggle button for the filter sidebar #}
      <button type="button" class="home-filters-toggle" id="homeFiltersToggle">Filters</button>

      {# --- Welcome tile --- #}
      <div class="filters-rail">
    <div class="home-intro" style="margin: 0;">
      <div class="home-intro-title">Welcome to EnforcedSpeed.</div>

      <div class="home-intro-body">
        EnforcedSpeed aggregates real-world speeding ticket data submitted by drivers. Posted speed limits are the law and must always be obeyed. This site does not provide legal advice, encourage speeding, or suggest that any enforcement patterns replace posted limits.
      </div>

{% if is_admin %}
      </span>
    {% endif %}

    </div>
  </div>

      {# Feed starts immediately below welcome card. #}

{% for r in reports %}
  {% set state_code = (r.state.split(' - ')[0] if ' - ' in r.state else r.state) %}
  {% set state_name = (r.state.split(' - ')[-1] if ' - ' in r.state else r.state) %}
  <div class="card ticket-card{% if r.is_deleted %} ticket-card--deleted{% endif %}" style="margin-top:16px;">

  

{# --- Header: Username (X) + time, OCR pill on right --- #}
<div class="ticket-headwrap">
  <div class="ticket-headrow">
    <div class="ticket-user">
      {% if r.user %}
        {% set user_count = user_ticket_counts.get(r.user_id, 0) %}
        <div class="ticket-userline">
          <a href="{{ url_for('profile', username=r.user.username) }}" class="user-link">{{ r.user.username }}</a>
          <span class="ticket-usercount">({{ user_count }})</span>

          {% if is_admin and r.is_deleted %}
            <span class="pill pill-deleted" title="This ticket is soft-deleted and excluded from public views and analytics.">Deleted</span>
          {% endif %}
        </div>

        {# Under-username metadata line (State / County / Road). #}
        <div class="ticket-submeta">
          {# State click should focus the interactive map without forcing a state filter. #}
          <span class="ticket-submeta-item"><a class="ticket-state-link" href="{{ url_for('map_view', focus_state=state_code, ticket_id=r.id) }}">{{ state_name }}</a> <span class="ticket-submeta-count">({{ state_ticket_counts.get(r.state, 0) }})</span></span>
          <span class="ticket-submeta-sep">·</span>
          {# County click should focus the interactive map without forcing a county filter. #}
          <span class="ticket-submeta-item">{% if r.county_geoid and r.county_name %}<a class="ticket-county-link" href="{{ url_for('map_view', focus_state=(r.state[:2] if r.state else ''), focus_county_geoid=r.county_geoid, ticket_id=r.id) }}">{{ r.county_name }}</a>{% else %}{{ r.county_name or '—' }}{% endif %} <span class="ticket-submeta-count">({{ county_ticket_counts.get(r.county_geoid, 0) }})</span></span>
          <span class="ticket-submeta-sep">·</span>
          <span class="ticket-submeta-item">{{ format_road_bucket(r.road_name) }}</span>
        </div>
      {% else %}
        <div class="ticket-userline">Anonymous</div>
      {% endif %}
    </div>

    <div class="ticket-ocr">
      {# Pin pill: only when the user has a refined pin. (Pin left) #}
      {% if r.location_source in ['user_pin','user_pin_snapped'] %}
        <span class="pill pill-photo pill-photo-ok">Pin ✓</span>
      {% endif %}

      {# Photo pill with status (Option 2): one pill when a photo exists. (Photo right) #}
      {% set has_photo = (r.photo_key is not none) %}
      {% if has_photo %}
        {% set pk = (r.photo_key|string) %}
        {% set st = (r.ocr_status or '') %}
        {% set vs = (r.verification_status or '') %}
        {% if pk.startswith('pending:') or st in ['pending','processing'] %}
          <span class="pill pill-photo pill-photo-processing">Photo …</span>
        {% elif pk.startswith('failed:') or st in ['failed','not_verified','no_text','ocr_error','ocr_exception'] %}
          <span class="pill pill-photo pill-photo-fail">Photo !</span>
        {% elif st == 'verified' or vs == 'verified' %}
          <span class="pill pill-photo pill-photo-ok">Photo ✓</span>
        {% else %}
          <span class="pill pill-photo pill-photo-fail">Photo !</span>
        {% endif %}
      {% endif %}

      {# Info icon (top-right) - click for verification details. (far right of pills row) #}
      <button type="button" class="ticket-info" data-report-id="{{ r.id }}"
              data-photo-key="{{ r.photo_key or '' }}"
              data-ocr-status="{{ r.ocr_status or '' }}"
              data-ocr-error="{{ r.ocr_error or '' }}"
              data-verification-status="{{ r.verification_status or '' }}"
              data-verify-attempts="{{ r.verify_attempts if r.verify_attempts is not none else '' }}"
              data-verify-reason="{{ r.verify_reason or '' }}"
              data-posted-speed="{{ r.posted_speed if r.posted_speed is not none else '' }}"
              data-ticketed-speed="{{ r.ticketed_speed if r.ticketed_speed is not none else '' }}"
              data-overage="{{ r.overage if r.overage is not none else '' }}"
              title="Details">i</button>
          <div class="ticket-date-right">
            <span class="js-localtime" data-utc="{{ r.created_at.isoformat() }}Z">{{ r.created_at.strftime("%b %d, %Y, %I:%M %p") }} UTC</span>
          </div>
            </div>
	</div>
	</div>
{# --- Precompute speeds for map overlay + display --- #}
{% set disp_posted = r.posted_speed %}
{% set disp_ticketed = r.ticketed_speed %}
{% if disp_posted is not none and disp_ticketed is not none and disp_ticketed < disp_posted %}
  {% set _tmp = disp_posted %}
  {% set disp_posted = disp_ticketed %}
  {% set disp_ticketed = _tmp %}
{% endif %}
{% set ticket_over = (disp_ticketed - disp_posted)|round|int %}
{% set enforced_over = enforced_a.get(r.id, ticket_over) %}
{% set enforced_speed_mph = (disp_posted + enforced_over)|round|int %}

{# --- Static map preview (feed hero) --- #}
{# Don't gate this on a template var (maps_api_key) because home() may not pass it.
   The helper returns None when static maps are not configured. #}
{% set _pin_lat = r.lat if r.location_source in ['user_pin','user_pin_snapped','route_class:interstate','route_class:numbered','route_class:local','prefer_highway','nearest'] else None %}
{% set _pin_lng = r.lng if _pin_lat is not none else None %}
{% set _pinmode = False %}
{# IMPORTANT (v370): Route ticket-card static maps through our own proxy endpoint so the
   Google Static Maps API key is never exposed to browsers (avoids referrer differences across browsers)
   and lets us cache responses server-side. #}
{% set _sm = url_for('api_county_staticmap', geoid=r.county_geoid, pin_lat=_pin_lat, pin_lng=_pin_lng, center_on_pin=('1' if _pinmode else '0'), w=640, h=640) %}
{% if _sm %}

  <div class="ticket-staticmap-frame">
  <div class="ticket-staticmap-wrap">
    {# Centered speed pill overlay ("84 in a 65 (+19 mph)") #}
    <div class="ticket-speedpill{% if _pinmode %} ticket-speedpill--pinmode{% endif %}">
      {{ disp_ticketed }} in a {{ disp_posted }}
      <span class="ticket-speedpill-over">({% if ticket_over > 0 %}+{{ ticket_over }}{% elif ticket_over < 0 %}{{ ticket_over }}{% else %}0{% endif %} mph)</span>
    </div>
    {% if current_user.is_authenticated and r.user_id and (r.user_id == current_user.id) %}
      <button type="button" class="ticket-pin-refine" data-report-id="{{ r.id }}" data-lat="{{ r.lat }}" data-lng="{{ r.lng }}" data-county-geoid="{{ r.county_geoid }}" data-county-name="{{ r.county_name }}" data-county-state="{{ r.county_state }}">Refine pin</button>
    {% endif %}
    <img class="ticket-staticmap" loading="lazy" src="{{ _sm }}" alt="Map preview">
  </div>
  </div>
{% endif %}
<div class="row ticket-actions" style="display:flex;gap:12px;align-items:center;flex-wrap:nowrap;">
        <div class="row" style="display:flex;gap:14px;align-items:center;flex-wrap:nowrap;justify-content:flex-start;">

          {% set lc = like_counts.get(r.id, 0) %}

          {% if current_user.is_authenticated %}
            <form method="post" action="{{ url_for('toggle_like', report_id=r.id) }}" style="margin:0;display:inline;">
              {{ like_form.hidden_tag() }}
              <input type="hidden" name="next" value="{{ request.full_path }}">
              <button type="submit" class="action-btn">
                {% if r.id in user_liked %}Liked{% else %}Like{% endif %}
              </button>
            </form>

            <span class="subtle">{{ lc }} like{% if lc != 1 %}s{% endif %}</span>

            <a class="action-link" href="#" onclick="toggleComment({{ r.id }}); return false;">Comment</a>

          {% else %}
            <a class="action-link" href="#" onclick="membersOnly({{ r.id }}); return false;">Like</a>
            <span class="subtle">{{ lc }} like{% if lc != 1 %}s{% endif %}</span>
            <a class="action-link" href="#" onclick="membersOnly({{ r.id }}); return false;">Comment</a>
            <span id="mo-{{ r.id }}" class="subtle" style="display:none; margin-left:8px;">(must log in)</span>
          {% endif %}
        </div>

        {% set bucket_total = a_counts.get((r.state, r.road_key), 0) %}
        <div class="ticket-total" style="margin-left:auto;text-align:right;">
</div>
        {# Report link later (v3) #}
      
</div>
{% if r.caption %}
        <div class="ticket-caption ticket-caption--clamp">{{ r.caption }}</div>
      {% endif %}

{# date moved to header-right under pills #}

{% if r.caption and not _sm %}
        <div class="ticket-caption" style="margin-top:10px; font-size:14px; line-height:1.35; color:#111827;">{{ r.caption }}</div>
      {% endif %}
{% set thread = comment_threads_by_report.get(r.id, {"top": [], "replies": {}}) %}
      {% set top_comments = thread["top"] %}
      {% set replies_map = thread["replies"] %}
      {% set total_comments = comments_by_report.get(r.id, [])|length %}

      {# Comments are fully collapsed by default (no comments shown until user expands). #}
      {% if top_comments %}
        <div style="margin-top:12px;">
          {% for c in top_comments %}
            <div id="comment-{{ c.id }}" class="subtle" style="margin-top:6px; display:none;">
              <strong style="color:#111827;">
                <a href="{{ url_for('profile', username=c.user.username) }}" style="color:inherit;text-decoration:none;">{{ c.user.username }}</a>
              </strong>
              <span class="subtle">
                · <span class="js-localtime" data-utc="{{ c.created_at.isoformat() }}Z">{{ c.created_at.strftime("%b %d, %Y %I:%M %p") }} UTC</span>
              </span>
              <div style="margin-top:2px;">{{ c.body }}</div>

              <div class="subtle" style="margin-top:4px;">
                {% if current_user.is_authenticated %}
                  <a class="action-link" href="#" onclick="openReplyWithMention({{ c.id }}, {{ c.id }}, '{{ c.user.username|e }}'); return false;">Reply</a>
                  {% if current_user.id == c.user_id %}
                    <form method="post" action="{{ url_for('delete_comment', comment_id=c.id) }}" style="display:inline; margin-left:10px;">
                      {{ delete_comment_form.hidden_tag() }}
                      <button type="submit" style="background:none;border:none;padding:0;margin:0;color:inherit;cursor:pointer;">Delete</button>
                      <input type="hidden" name="next" value="{{ request.full_path }}">
                    </form>
                  {% endif %}
                {% endif %}
              </div>

              {# Nested replies renderer (supports replying to replies). #}
              {# Nested replies renderer with capped visual indentation and feed-collapse (fully collapsed by default). #}
              {% macro render_replies(parent_id, depth, root_id, seen) -%}
                {# Safety guard: prevent cycles/runaway nesting from hanging the page. #}
                {% if parent_id in seen or depth > 20 %}
                {% else %}
                {% set kids = replies_map.get(parent_id, []) %}
                {% if kids %}
                  <div style="margin-top:6px;">
                    {% for rc in kids %}
                      {% set d = depth if depth < 2 else 2 %}
                      <div id="comment-{{ rc.id }}" class="subtle" style="margin-top:6px; margin-left:{{ 18 * d }}px; display:none;">
                        <strong style="color:#111827;">
                          <a href="{{ url_for('profile', username=rc.user.username) }}" style="color:inherit;text-decoration:none;">{{ rc.user.username }}</a>
                        </strong>
                        <span class="subtle"> · <span class="js-localtime" data-utc="{{ rc.created_at.isoformat() }}Z">{{ rc.created_at.strftime("%b %d, %Y %I:%M %p") }} UTC</span></span>
                        <div style="margin-top:2px;">{{ rc.body }}</div>
                        {% if current_user.is_authenticated %}
                          <div class="subtle" style="margin-top:4px;">
                            <a class="action-link" href="#" onclick="openReplyWithMention({{ root_id }}, {{ rc.id }}, '{{ rc.user.username|e }}'); return false;">Reply</a>
                            {% if current_user.id == rc.user_id %}
                              <form method="post" action="{{ url_for('delete_comment', comment_id=rc.id) }}" style="display:inline; margin-left:10px;">
                                {{ delete_comment_form.hidden_tag() }}
                                <button type="submit" style="background:none;border:none;padding:0;margin:0;color:inherit;cursor:pointer;">Delete</button>
                              </form>
                            {% endif %}
                          </div>
                        {% endif %}
                      </div>
                      {{ render_replies(rc.id, depth+1, root_id, seen + [parent_id]) }}
                    {% endfor %}
                  </div>
                {% endif %}
              {% endif %}
              {%- endmacro %}

              {{ render_replies(c.id, 1, c.id, []) }}
              {% if current_user.is_authenticated %}
                <div id="replybox-{{ c.id }}" style="display:none; margin-top:10px; margin-left:18px;">
                  <form method="post" action="{{ url_for('add_comment', report_id=r.id) }}">
                    {# Render CSRF only. We'll provide parent_id manually to avoid duplicate fields. #}
                    {{ comment_form.csrf_token }}
                    <input type="hidden" name="next" value="{{ request.full_path }}">
                    <input type="hidden" name="parent_id" value="{{ c.id }}">
                    <textarea class="js-comment-body" name="body" maxlength="280" rows="2" style="width:100%;" placeholder="Write a reply…"></textarea>
                    <div style="margin-top:0;">
                      <button type="submit">Reply</button>
                      <span class="subtle" style="margin-left:10px;">280 characters max.</span>
                    </div>
                  </form>
                </div>
              {% endif %}
            </div>
          {% endfor %}

          <div class="subtle" style="margin-top:6px;">
            <a class="action-link" href="javascript:void(0)" id="toggle-comments-{{ r.id }}" onclick="return toggleComments({{ r.id }}, {{ total_comments }});" data-expanded="0" data-label="View all {{ total_comments }} comment{% if total_comments != 1 %}s{% endif %}">View all {{ total_comments }} comment{% if total_comments != 1 %}s{% endif %}</a>
          </div>

        </div>
      {% endif %}

      {% if current_user.is_authenticated %}
        <div id="commentbox-{{ r.id }}" style="display:none; margin-top:12px;">
          <form method="post" action="{{ url_for('add_comment', report_id=r.id) }}">
            {# Render CSRF only. We'll provide parent_id manually to avoid duplicate fields. #}
            {{ comment_form.csrf_token }}
            <input type="hidden" name="next" value="{{ request.full_path }}">
            <input type="hidden" name="parent_id" value="">
            <textarea class="js-comment-body" name="body" maxlength="280" rows="2" style="width:100%;" placeholder="Write a comment…"></textarea>
            <div style="margin-top:0;">
              <button type="submit">Post</button>
              <span class="subtle" style="margin-left:10px;">280 characters max.</span>
            </div>
          </form>
        </div>
      {% endif %}

    </div>
  {% else %}
    <div class="card ticket-card" style="margin-top:16px;">
      <p>No posts yet. Be the first to <a href="{{ url_for('submit') }}">submit a ticket</a>.</p>
    </div>
  {% endfor %}

  {% if pagination.pages > 1 %}
    {# Preserve all active query params (including admin deleted mode) across pagination #}
    {% set q = request.args.to_dict() %}
    {% set _ = q.pop('page', None) %}

    <div class="card ticket-card" style="margin-top:16px;">
      <div class="row" style="justify-content:space-between;gap:12px;">
        <div>
          {% if pagination.has_prev %}
            <a class="action-link" href="{{ url_for('home', page=pagination.prev_num, **q) }}">← Newer</a>
          {% endif %}
        </div>
        <div class="subtle">Page {{ pagination.page }} of {{ pagination.pages }}</div>
        <div>
          {% if pagination.has_next %}
            <a class="action-link" href="{{ url_for('home', page=pagination.next_num, **q) }}">Older →</a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

</div>

<style>

  /* Reuse the exact thank_you thermometer styling (scoped to this template). */
  .ticket-card{padding-top:18px;padding-bottom:18px;overflow:hidden}

  .thermo-label{font-size:13px;font-weight:700;color:#374151}
  .thermo-line{display:flex;align-items:center;gap:10px}
  .thermo-bar{flex:1;height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden;position:relative}
  .thermo-fill{height:100%;background:#cbd5e1;border-radius:999px}
  .thermo-tick{position:absolute;top:0;bottom:0;width:2px;background:#9ca3af;opacity:.85;transform:translateX(-1px)}
  .thermo-tick.tick-90{left:90%;background:#111827;opacity:1}
  .thermo-value{min-width:54px;text-align:right;font-size:12px;font-weight:800;color:#111827}
  .thermo-p90{position:absolute;left:90%;top:-32px;transform:translateX(-50%);font-size:11px;font-weight:700;color:#111827;white-space:nowrap}

  .ticket-top{margin-top:-10px}
  .ticket-user{font-weight:400}
  .ticket-user .user-link{font-weight:500}
  .ticket-date{font-weight:400}
  /* Header layout: username on the left, OCR pill top-right aligned to username line. */
  .ticket-headwrap{display:block}
  .ticket-headrow{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .ticket-userline{display:flex;align-items:baseline;gap:6px}
  .ticket-usercount{font-size:13px;font-weight:600;color:#6b7280}
  .ticket-ocr{align-self:flex-start;margin-top:0;display:flex;justify-content:flex-end;align-items:center;gap:8px;flex-wrap:wrap}
  .ticket-info{border:1px solid #e5e7eb;background:#fff;border-radius:999px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:13px;line-height:1;cursor:pointer}
  .ticket-info:hover{background:#f9fafb}

  /* Under-username State/County/Road line */
  .ticket-state-link{color:inherit;text-decoration:none}
  .ticket-state-link:hover{text-decoration:underline}
  .ticket-county-link{color:inherit;text-decoration:none}
  .ticket-county-link:hover{text-decoration:underline}
  .ticket-submeta{margin-top:4px;font-size:12.5px;color:#6b7280;display:flex;gap:6px;flex-wrap:wrap}
  .ticket-submeta-count{font-weight:600;color:#4b5563}
  .ticket-submeta-sep{opacity:.8}
  .user-link{text-decoration:none;color:inherit}
  .user-link:hover{text-decoration:underline}

  /* Static map (ticket card hero)
     FB-style: the *media block* (map + action row + optional caption) is square.
     The map itself becomes shorter to accommodate the footer.
  */
    /* FB-style square media frame:
     - The *frame* is square (matches FB post media).
     - The map image is allowed to be shorter inside the square (letterboxed) so it doesn't feel overly tall.
  */
  .ticket-staticmap-frame{
    margin-top:12px;
    border-radius:14px;
    overflow:hidden;
    border:1px solid #e5e7eb;
    background:#f3f4f6;
    aspect-ratio:1/1;
    position:relative;
  }

  .ticket-staticmap-frame .ticket-staticmap-wrap{
    margin-top:0;
    border:0;
    border-radius:0;
    width:100%;
    height:100%;
    background:transparent;
    position:relative;
    aspect-ratio:auto;
  }

  .ticket-staticmap-frame .ticket-staticmap{
    display:block;
    width:100%;
    height:100%;
    object-fit:contain;
    object-position:center center;
  }

.ticket-staticmap-wrap{width:100%;overflow:hidden;background:#f3f4f6;position:relative;}
  .ticket-caption--clamp{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}

  .ticket-speedpill{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:rgba(255,255,255,.95);border:1px solid #e5e7eb;border-radius:999px;padding:6px 12px;font-size:13px;font-weight:700;color:#111827;box-shadow:0 2px 8px rgba(0,0,0,.06);z-index:2;white-space:nowrap}
  .ticket-speedpill--pinmode{top:50%;left:50%;transform:translate(-50%,calc(-100% - 56px))}
  .ticket-speedpill-over{font-weight:700;color:#f97316;margin-left:8px}
  .ticket-pin-refine{position:absolute;left:12px;top:12px;z-index:2}

  /* Ticket card center (Version 5). */
  .ticket-center{margin-top:12px;text-align:center;position:relative}
  .ticket-roadstate{font-size:20px;font-weight:600;color:#111827;letter-spacing:.01em}
  /* Speed line: keep the "90 in a 65" centered, and place "+25 mph" in the center of the right-hand side. */
  .ticket-speedrow{margin-top:10px;display:flex;justify-content:center;align-items:baseline}
    .ticket-speedtext{font-size:18px;font-weight:600;color:#111827;display:flex;align-items:baseline;gap:10px}
  .ticket-speedin{font-weight:600;color:#111827}
  .ticket-overageblue{font-size:18px;font-weight:600;color:#2563eb;white-space:nowrap}
  .ticket-overageinline{font-size:14px;margin-left:8px;}
  /* Float the +mph BETWEEN road/state and speed line (center-right). */
  .ticket-overagefloat{position:absolute;top:36px;left: calc(70% + 14px);transform:translate(-50%,-50%);}
  /* Add a touch more whitespace above/below the EnforcedSpeed sentence. */
  .ticket-enforcedline{margin-top:30px;margin-bottom:30px;font-size:13.5px;font-weight:400;color:#374151;line-height:1.35}

  .ticket-actions{margin-top:0px;padding-top:0;border-top:0}
  /* Force "View all…" to match Like/Comment exactly (no local overrides). */
  .ticket-total .action-link{font-size:inherit;line-height:inherit;font-weight:inherit;text-align:right;display:inline}
  .ticket-total{flex:1;min-width:160px}

  /* v58 refinements */
  .ticket-card{padding-top:18px;padding-bottom:18px;overflow:hidden}
  .ticket-top{margin-top:-10px}
  .thermo-line{display:flex;align-items:center;gap:10px}
  .thermo-bar{flex:1}
  .thermo-value{position:static;font-size:12px;font-weight:800;color:#111827;min-width:52px;text-align:right}

</style>

<script>
  function membersOnly(id){
    var el=document.getElementById('mo-'+id);
    if(!el){return;}
    el.style.display='inline';
    setTimeout(function(){ el.style.display='none'; }, 900);
  }
  function toggleComment(id){
    var el=document.getElementById('commentbox-'+id);
    if(!el){return;}
    el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
  }
  function toggleReply(commentId){
    var el=document.getElementById('replybox-'+rootId);
    if(!el){return;}
    el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
  }

  // Open the reply box for a comment and (if empty) prefill an @mention.
  function openReplyWithMention(rootId, parentId, username){
    var box = document.getElementById('replybox-'+rootId);
    if(!box){return;}
    box.style.display = 'block';
    try{
      var pid = box.querySelector('input[name="parent_id"]');
      if(pid && parentId){ pid.value = parentId; }
    }catch(e){}
    try{
      var ta = box.querySelector('textarea[name="body"]');
      if(!ta){return;}
      var current = (ta.value || '').trim();
      if(!current && username){
        ta.value = '@' + username + ' ';
      }
      ta.focus();
      // Move cursor to end
      ta.selectionStart = ta.selectionEnd = ta.value.length;
    }catch(e){}
  }

  // Enter submits, Shift+Enter adds a new line (comments + replies only)
  (function bindEnterToSubmit(){
    try{
      document.addEventListener('keydown', function(e){
        var t = e.target;
        if(!t) return;
        if(t.classList && t.classList.contains('js-comment-body')){
          if(e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            var form = t.closest('form');
            if(form){ form.submit(); }
          }
        }
      });
    }catch(e){}
  })();

  // Note: comment/reply boxes are closed by default on page load.
</script>

<script>
  function convertLocalTimes(){
    var nodes = document.querySelectorAll('.js-localtime[data-utc]');
    if(!nodes || nodes.length === 0) return;

    function formatLocal(d){
      try{
        return new Intl.DateTimeFormat(undefined, {
          month: 'short',
          day: '2-digit',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        }).format(d);
      }catch(e){
        return d.toLocaleString();
      }
    }

    nodes.forEach(function(el){
      var iso = el.getAttribute('data-utc');
      if(!iso) return;
      var d = new Date(iso);
      if(isNaN(d.getTime())) return;
      el.textContent = formatLocal(d);
    });
  }

  function toggleComments(reportId, totalCount){
    var link = document.getElementById('toggle-comments-' + reportId);
    if(!link) return false;
    var isExpanded = link.getAttribute('data-expanded') === '1';

    var card = link.closest('.card');
    if(!card) return false;

    var items = card.querySelectorAll('[id^="comment-"]');

    if(!isExpanded){
      items.forEach(function(el){ el.style.display = ''; });
      link.textContent = 'Collapse comments';
      link.setAttribute('data-expanded','1');
      try{ convertLocalTimes(); }catch(e){}
    }else{
      items.forEach(function(el){ el.style.display = 'none'; });
      var lbl = link.getAttribute('data-label');
      link.textContent = lbl ? lbl : ('View all ' + totalCount + ' comments');
      link.setAttribute('data-expanded','0');
    }
    return false;
  }

  

  // --- Mobile helpers (home) ---
  function initHomeFiltersToggle(){
    var btn = document.getElementById('homeFiltersToggle');
    var sidebar = document.getElementById('homeFiltersSidebar');
    if(!btn || !sidebar) return;

    function setCollapsed(v){
      if(v){ sidebar.classList.add('is-collapsed'); }
      else{ sidebar.classList.remove('is-collapsed'); }
    }

    try{
      if(window.matchMedia && window.matchMedia('(max-width: 980px)').matches){
        setCollapsed(true);
      }
    }catch(e){}

    btn.addEventListener('click', function(){
      sidebar.classList.toggle('is-collapsed');
    });
  }
document.addEventListener('DOMContentLoaded', function(){
    try{ convertLocalTimes(); }catch(e){}
    try{ initHomeFiltersToggle(); }catch(e){}
  });
</script>

    </div> {# /home-center #}

    {# Right rail: static mini-map (trending counties). Click anywhere to open the full interactive map. #}
    <aside class="home-right" aria-label="Ticket map">
      {# Card 1: Static mini-map (no title; full-bleed image + tiny overlay link) #}
      <div class="rail-card" style="border-radius:0;">
        {% if maps_api_key %}
          <a href="{{ url_for('map_view') }}" style="display:block; position:relative; width:100%;">
            <div class="minimap-crop">
              <img src="{{ url_for('api_home_minimap_staticmap') }}" alt="Trending counties map">
            </div>
            <span class="subtle" style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.92); border:1px solid rgba(0,0,0,0.08); padding:4px 8px; border-radius:999px; font-size:12px; text-decoration:none;">Open full map</span>
          </a>
        {% else %}
          <div class="subtle" style="padding:12px 14px 14px;">Map not configured yet (missing GOOGLE_MAPS_API_KEY).</div>
        {% endif %}
      </div>

      {# Card 2: Trending + Followed (separate container, flush aligned) #}
      <div class="rail-card" style="border-radius:0;">

      {# Card 2: Trending + Followed (separate container, flush aligned) #}
      <div class="rail-card">
        <div class="rail-section">
  <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:8px;">
    <div style="display:flex; flex-direction:column; line-height:1.1;">
      <div style="font-weight:600;">Trending counties</div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <div style="display:flex; justify-content:flex-end; font-size:11px; color:#6b7280; gap:4px; padding:0 0;">
      <span style="width:24px; text-align:right;">7d</span>
      <span style="width:24px; text-align:right;">30d</span>
      <span style="width:24px; text-align:right;">1y</span>
      <span style="width:46px; text-align:right; line-height:1.05;"><span style="display:block; font-size:10px; font-weight:500; opacity:0.85;">Avg.</span><span style="display:block; font-size:11px; font-weight:600;">Overage</span></span>
    </div>

    {% if trending_counties and trending_counties|length > 0 %}
      <div style="margin-top:6px; display:flex; flex-direction:column; gap:8px;">
        {% for c in trending_counties %}
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <a href="{{ url_for('map_view', county=c.geoid) }}" class="subtle" style="flex:1; text-decoration:none; font-weight:500; white-space:normal; overflow:visible; text-overflow:clip; min-width:0; line-height:1.15;">
              {{ c.label }}, {{ c.st }}
            </a>

            <div style="display:flex; align-items:center; gap:4px; font-size:12px; font-variant-numeric:tabular-nums;">
              <span style="width:24px; text-align:right;">{{ c.c7 }}</span>
              <span style="width:24px; text-align:right;">{{ c.c30 }}</span>
              <span style="width:24px; text-align:right;">{{ c.c365 }}</span>
              <span style="width:46px; text-align:right;">{{ c.ovr }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="subtle" style="padding:6px 2px 2px;">Not enough data yet.</div>
    {% endif %}
  </div>

        </div>

        <div class="rail-section">
  <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:8px;">
    <div style="display:flex; flex-direction:column; line-height:1.1;">
      <div style="font-weight:600;">Counties you follow</div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <div style="display:flex; justify-content:flex-end; font-size:11px; color:#6b7280; gap:4px; padding:0 0;">
      <span style="width:24px; text-align:right;">7d</span>
      <span style="width:24px; text-align:right;">30d</span>
      <span style="width:24px; text-align:right;">1y</span>
      <span style="width:46px; text-align:right; line-height:1.05;"><span style="display:block; font-size:10px; font-weight:500; opacity:0.85;">Avg.</span><span style="display:block; font-size:11px; font-weight:600;">Overage</span></span>
    </div>

    {% if not current_user.is_authenticated %}
      <div class="subtle" style="margin-top:8px;">Log in to follow counties.</div>
    {% elif followed_counties and followed_counties|length > 0 %}
      <div style="margin-top:6px; display:flex; flex-direction:column; gap:8px;">
        {% for c in followed_counties %}
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <a href="{{ url_for('map_view', county=c.geoid) }}" class="subtle" style="flex:1; text-decoration:none; font-weight:500; white-space:normal; overflow:visible; text-overflow:clip; min-width:0; line-height:1.15;">
              {{ c.label }}, {{ c.st }}
            </a>

            <div style="display:flex; align-items:center; gap:4px; font-size:12px; font-variant-numeric:tabular-nums;">
              <span style="width:24px; text-align:right;">{{ c.c7 }}</span>
              <span style="width:24px; text-align:right;">{{ c.c30 }}</span>
              <span style="width:24px; text-align:right;">{{ c.c365 }}</span>
              <span style="width:46px; text-align:right;">{{ c.ovr }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="subtle" style="margin-top:8px;">You haven’t followed any counties yet.</div>
    {% endif %}
  </div>

        </div>
      </div>
    </aside>


</div> {# /home-shell #}

{# --- Ticket details modal (eye icon) --- #}
<div id="ticketInfoModal" class="modal" style="display:none;">
  <div class="modal-backdrop" id="ticketInfoBackdrop"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="ticketInfoTitle">
    <div class="modal-title" id="ticketInfoTitle">Ticket details</div>
    <div class="subtle" id="ticketInfoBody" style="margin-top:10px; white-space:pre-wrap;"></div>
    <div class="modal-actions">
      <button type="button" class="btn" id="ticketInfoClose">Close</button>
    </div>
  </div>
</div>

<script>
  (function(){
    const modal = document.getElementById('ticketInfoModal');
    if(!modal) return;
    const backdrop = document.getElementById('ticketInfoBackdrop');
    const closeBtn = document.getElementById('ticketInfoClose');
    const body = document.getElementById('ticketInfoBody');

    function close(){ modal.style.display='none'; }
    function open(text){
      body.textContent = text;
      modal.style.display='block';
    }

    backdrop && backdrop.addEventListener('click', close);
    closeBtn && closeBtn.addEventListener('click', close);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='block') close(); });

    document.addEventListener('click', function(e){
      const btn = e.target && e.target.closest ? e.target.closest('.ticket-info') : null;
      if(!btn) return;
      const photoKey = btn.getAttribute('data-photo-key') || '';
      const ocrStatus = btn.getAttribute('data-ocr-status') || '';
      const ocrError = btn.getAttribute('data-ocr-error') || '';
      const verStatus = btn.getAttribute('data-verification-status') || '';
      const attempts = btn.getAttribute('data-verify-attempts') || '';
      const reason = btn.getAttribute('data-verify-reason') || '';
      const posted = btn.getAttribute('data-posted-speed') || '';
      const ticketed = btn.getAttribute('data-ticketed-speed') || '';
      const overage = btn.getAttribute('data-overage') || '';

      const lines = [];
      lines.push(`Photo: ${photoKey ? 'uploaded' : 'none'}`);
      if(photoKey) lines.push(`Photo key: ${photoKey}`);
      if(posted !== '' || ticketed !== ''){
        let p = posted === '' ? null : parseInt(posted,10);
        let t = ticketed === '' ? null : parseInt(ticketed,10);
        if(p !== null && t !== null && t < p){ const tmp=p; p=t; t=tmp; }
        if(p !== null) lines.push(`Posted speed: ${p}`);
        if(t !== null) lines.push(`Ticketed speed: ${t}`);
        if(p !== null && t !== null) lines.push(`Overage: ${t - p}`);
        else if(overage !== '') lines.push(`Overage: ${overage}`);
      }
      lines.push(`OCR status: ${ocrStatus || 'n/a'}`);
      if(ocrError) lines.push(`OCR error: ${ocrError}`);
      lines.push(`Verification: ${verStatus || 'n/a'}`);
      if(attempts !== '') lines.push(`Verify attempts: ${attempts}`);
      if(reason) lines.push(`Verify reason: ${reason}`);

      open(lines.join('\n'));
    });
  })();
</script>

{# --- Owner-only pin refine modal (feed) --- #}
{% if current_user.is_authenticated and maps_api_key %}
<div id="feedPinModal" class="modal" style="display:none;">
  <div class="modal-backdrop" id="feedPinBackdrop"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="feedPinTitle">
    <div class="modal-title" id="feedPinTitle">Refine pin</div>
    <div class="subtle" style="margin-top:6px;">
      Drag the pin to the closest spot on the road. We'll snap it to the nearest road line.
    </div>
    <div id="feedPinMap" style="width:100%; height:360px; margin-top:12px; border:1px solid #e5e7eb; border-radius:12px;"></div>
    <div class="subtle" id="feedPinStatus" style="margin-top:10px; display:none;"></div>
    <div class="modal-actions">
      <button type="button" class="btn btn-ghost" id="feedPinCancel">Cancel</button>
      <button type="button" class="btn" id="feedPinSave">Save pin</button>
    </div>
  </div>
</div>
{% endif %}

{% if current_user.is_authenticated and maps_api_key %}
<script>
  (function(){
    const modal = document.getElementById('feedPinModal');
    if(!modal) return;

    const backdrop = document.getElementById('feedPinBackdrop');
    const btnCancel = document.getElementById('feedPinCancel');
    const btnSave = document.getElementById('feedPinSave');
    const statusEl = document.getElementById('feedPinStatus');
    const mapEl = document.getElementById('feedPinMap');

    let activeReportId = null;
    let map = null;
    let marker = null;

    function showStatus(msg){
      if(!statusEl) return;
      statusEl.textContent = msg;
      statusEl.style.display = 'block';
    }
    function clearStatus(){
      if(!statusEl) return;
      statusEl.textContent = '';
      statusEl.style.display = 'none';
    }

    function close(){
      modal.style.display = 'none';
      activeReportId = null;
      clearStatus();
    }

    function ensureGoogleMaps(cb){
      if(window.google && google.maps){ cb(); return; }
      if(window.__esFeedMapsLoading){
        window.__esFeedMapsCallbacks.push(cb);
        return;
      }
      window.__esFeedMapsLoading = true;
      window.__esFeedMapsCallbacks = [cb];
      const s = document.createElement('script');
      s.src = "https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}";
      s.async = true;
      s.defer = true;
      s.onload = function(){
        const cbs = window.__esFeedMapsCallbacks || [];
        window.__esFeedMapsCallbacks = [];
        cbs.forEach(fn => { try{ fn(); }catch(e){} });
      };
      document.head.appendChild(s);
    }

    function open(reportId, lat, lng){
      activeReportId = reportId;
      modal.style.display = 'block';
      clearStatus();

      ensureGoogleMaps(function(){
        const center = { lat: lat, lng: lng };
        if(!map){
          map = new google.maps.Map(mapEl, {
            center: center,
            zoom: 16,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
          });
          marker = new google.maps.Marker({ position: center, map: map, draggable: true });
          map.addListener('click', function(e){
            if(!e || !e.latLng) return;
            marker.setPosition(e.latLng);
          });
        }else{
          map.setCenter(center);
          map.setZoom(16);
          marker.setPosition(center);
        }
      });
    }

    function bindTriggers(){
      document.querySelectorAll('.ticket-pin-refine').forEach(btn => {
        btn.addEventListener('click', function(){
          const rid = parseInt(btn.getAttribute('data-report-id') || '0', 10);
          const lat = parseFloat(btn.getAttribute('data-lat') || '0');
          const lng = parseFloat(btn.getAttribute('data-lng') || '0');
          if(!rid || !lat || !lng) return;
          open(rid, lat, lng);
        });
      });
    }

    async function save(){
      if(!activeReportId || !marker) return;
      const pos = marker.getPosition();
      const lat = pos.lat();
      const lng = pos.lng();
      btnSave.disabled = true;
      try{
        const res = await fetch('/api/update_ticket_pin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ report_id: activeReportId, lat: lat, lng: lng })
        });
        const data = await res.json().catch(()=>({}));
        if(res.ok && data && data.ok){
          showStatus(data.snapped ? 'Saved. Pin snapped to nearest road.' : 'Saved.');
          // Reload to refresh static map image + any downstream aggregates.
          setTimeout(()=>{ window.location.reload(); }, 450);
        }else{
          showStatus('Could not save pin. Please try again.');
          btnSave.disabled = false;
        }
      }catch(e){
        showStatus('Could not save pin. Please try again.');
        btnSave.disabled = false;
      }
    }

    if(backdrop) backdrop.addEventListener('click', close);
    if(btnCancel) btnCancel.addEventListener('click', close);
    if(btnSave) btnSave.addEventListener('click', save);

    bindTriggers();
  })();
</script>
{% endif %}
{% endblock %}