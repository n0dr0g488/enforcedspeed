{% extends "base.html" %}
{% block content %}

<div class="wrap">

  <div class="card">
    <div style="position:relative;">
      <form action="{{ url_for('search') }}" method="get">
        <input
          type="text"
          id="global-search"
          name="q"
          placeholder="Search road, state, or username"
          autocomplete="off"
          style="width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:999px;background:#f3f4f6;outline:none;"
        >
      </form>
      <div id="search-suggest" class="search-suggest" style="display:none;"></div>
    </div>

    <div class="subtle" style="margin: 10px 0 2px 0;">
      {% if hide_anon %}
        Viewing: <strong id="viewingMode">Members only</strong> · <a href="{{ url_for('home') }}">Show anonymous too</a>
      {% else %}
        Viewing: <strong id="viewingMode">All posts</strong> · {% if current_user.is_authenticated %}
        <a href="{{ url_for('home', hide_anon=1) }}">Hide anonymous</a>
      {% else %}
        <a href="#" id="hideAnonLink" onclick="
          var vm=document.getElementById('viewingMode');
          var old=vm.innerText;
          vm.innerText='Members only';
          var msg=document.getElementById('loginRequiredMsg');
          if(msg){msg.style.display='inline';}
          setTimeout(function(){ vm.innerText=old; }, 700);
          return false;
        ">Hide anonymous</a>
        <span id="loginRequiredMsg" class="subtle" style="display:none; margin-left:8px;">Members only.</span>
      {% endif %}
      {% endif %}
    </div>
  </div>

  {% for r in reports %}
  <div class="card" style="margin-top:16px;">

      <div class="row" style="justify-content:space-between;gap:12px;">
        <div style="font-weight:800;">
          {% if r.user %}
            <a href="{{ url_for('profile', username=r.user.username) }}" style="text-decoration:none; color:inherit;">{{ r.user.username }}</a>
          {% else %}
            Anonymous
          {% endif %}
        </div>
        <div class="subtle">
          <span class="js-localtime" data-utc="{{ r.created_at.isoformat() }}Z">{{ r.created_at.strftime("%b %d, %Y %I:%M %p") }} UTC</span>
        </div>
      </div>

      <div style="margin-top:10px;">
        <span class="pill">{{ r.state }}</span>
        <span class="pill">{{ format_road_bucket(r.road_name) }}</span>
        <span class="pill">{{ r.posted_speed }} mph posted</span>
        <span class="pill">{{ r.ticketed_speed }} mph ticketed</span>
        <span class="pill">{{ (r.ticketed_speed - r.posted_speed) }} over</span>
      </div>

      <div style="margin-top:14px;">
        <div class="thermo-row">
          <div class="thermo-label">Road + State percentile</div>
          <div class="thermo-pct">{{ pct_a[r.id] }}%</div>
        </div>
        <div class="thermo-bar" aria-label="Road and state percentile">
          <div class="thermo-fill" style="width: {{ pct_a[r.id] }}%;"></div>
        </div>
      </div>

      <div style="margin-top:16px;">
        <div class="thermo-row">
          <div class="thermo-label">State + Posted Speed percentile</div>
          <div class="thermo-pct">{{ pct_b[r.id] }}%</div>
        </div>
        <div class="thermo-bar" aria-label="State and posted speed percentile">
          <div class="thermo-fill" style="width: {{ pct_b[r.id] }}%;"></div>
        </div>
      </div>

      <div class="row" style="margin-top:14px;display:flex;justify-content:space-between;gap:12px;align-items:center;">
        <div class="row" style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;justify-content:flex-start;">

          {% set lc = like_counts.get(r.id, 0) %}

          {% if current_user.is_authenticated %}
            <form method="post" action="{{ url_for('toggle_like', report_id=r.id) }}" style="margin:0;display:inline;">
              {{ like_form.hidden_tag() }}
              <input type="hidden" name="next" value="{{ request.full_path }}">
              <button type="submit" style="background:none;border:none;padding:0;color:#2563eb;cursor:pointer;font:inherit;">
                {% if r.id in user_liked %}Liked{% else %}Like{% endif %}
              </button>
            </form>

            <span class="subtle">{{ lc }} like{% if lc != 1 %}s{% endif %}</span>

            <a href="#" onclick="toggleComment({{ r.id }}); return false;">Comment</a>

          {% else %}
            <a href="#" onclick="membersOnly({{ r.id }}); return false;">Like</a>
            <span class="subtle">{{ lc }} like{% if lc != 1 %}s{% endif %}</span>
            <a href="#" onclick="membersOnly({{ r.id }}); return false;">Comment</a>
            <span id="mo-{{ r.id }}" class="subtle" style="display:none; margin-left:8px;">Members only.</span>
          {% endif %}
        </div>

        <a href="{{ url_for('bucket_tickets') }}?state={{ r.state[:2] }}&road={{ r.road_key }}">View similar</a>
        {# Report link later (v3) #}
      </div>

      {% set thread = comment_threads_by_report.get(r.id, {"top": [], "replies": {}}) %}
      {% set top_comments = thread["top"] %}
      {% set replies_map = thread["replies"] %}
      {% set total_comments = comments_by_report.get(r.id, [])|length %}
      {% set ns = namespace(shown=0) %}

      {% if top_comments %}
        <div style="margin-top:12px;">
          {% for c in top_comments %}
            {% set ns.shown = ns.shown + 1 %}
            {% set hide = ns.shown > 2 %}
            <div id="comment-{{ c.id }}" class="subtle" style="margin-top:6px;{{ ' display:none;' if hide else '' }}">
              <strong style="color:#111827;">
                <a href="{{ url_for('profile', username=c.user.username) }}" style="color:inherit;text-decoration:none;">{{ c.user.username }}</a>
              </strong>
              <span class="subtle">
                · <span class="js-localtime" data-utc="{{ c.created_at.isoformat() }}Z">{{ c.created_at.strftime("%b %d, %Y %I:%M %p") }} UTC</span>
              </span>
              <div style="margin-top:2px;">{{ c.body }}</div>

              <div class="subtle" style="margin-top:4px;">
                {% if current_user.is_authenticated %}
                  <a href="#" onclick="openReplyWithMention({{ c.id }}, {{ c.id }}, '{{ c.user.username|e }}'); return false;">Reply</a>
                  {% if current_user.id == c.user_id %}
                    <form method="post" action="{{ url_for('delete_comment', comment_id=c.id) }}" style="display:inline; margin-left:10px;">
                      {{ delete_comment_form.hidden_tag() }}
                      <button type="submit" style="background:none;border:none;padding:0;margin:0;color:inherit;cursor:pointer;">Delete</button>
                      <input type="hidden" name="next" value="{{ request.full_path }}">
                    </form>
                  {% endif %}
                {% endif %}
              </div>

              {# Nested replies renderer (supports replying to replies). #}
              {# Nested replies renderer with capped visual indentation and feed-collapse (first 2 items visible). #}
              {% macro render_replies(parent_id, depth, root_id) -%}
                {% set kids = replies_map.get(parent_id, []) %}
                {% if kids %}
                  <div style="margin-top:6px;">
                    {% for rc in kids %}
                      {% set ns.shown = ns.shown + 1 %}
                      {% set hide = ns.shown > 2 %}
                      {% set d = depth if depth < 2 else 2 %}
                      <div id="comment-{{ rc.id }}" class="subtle" style="margin-top:6px; margin-left:{{ 18 * d }}px;{{ ' display:none;' if hide else '' }}">
                        <strong style="color:#111827;">
                          <a href="{{ url_for('profile', username=rc.user.username) }}" style="color:inherit;text-decoration:none;">{{ rc.user.username }}</a>
                        </strong>
                        <span class="subtle"> · <span class="js-localtime" data-utc="{{ rc.created_at.isoformat() }}Z">{{ rc.created_at.strftime("%b %d, %Y %I:%M %p") }} UTC</span></span>
                        <div style="margin-top:2px;">{{ rc.body }}</div>
                        {% if current_user.is_authenticated %}
                          <div class="subtle" style="margin-top:4px;">
                            <a href="#" onclick="openReplyWithMention({{ root_id }}, {{ rc.id }}, '{{ rc.user.username|e }}'); return false;">Reply</a>
                            {% if current_user.id == rc.user_id %}
                              <form method="post" action="{{ url_for('delete_comment', comment_id=rc.id) }}" style="display:inline; margin-left:10px;">
                                {{ delete_comment_form.hidden_tag() }}
                                <button type="submit" style="background:none;border:none;padding:0;margin:0;color:inherit;cursor:pointer;">Delete</button>
                              </form>
                            {% endif %}
                          </div>
                        {% endif %}
                      </div>
                      {{ render_replies(rc.id, depth+1, root_id) }}
                    {% endfor %}
                  </div>
        {% if total_comments > 2 %}
          <div class="subtle" style="margin-top:6px;">
            <a href="#" id="toggle-comments-{{ r.id }}" onclick="toggleComments({{ r.id }}, {{ total_comments }}); return false;">View all {{ total_comments }} comments</a>
          </div>
        {% endif %}
                {% endif %}
              {%- endmacro %}

              {{ render_replies(c.id, 1, c.id) }}

              {% if current_user.is_authenticated %}
                <div id="replybox-{{ c.id }}" style="display:none; margin-top:10px; margin-left:18px;">
                  <form method="post" action="{{ url_for('add_comment', report_id=r.id) }}">
                    {# Render CSRF only. We'll provide parent_id manually to avoid duplicate fields. #}
                    {{ comment_form.csrf_token }}
                    <input type="hidden" name="next" value="{{ request.full_path }}">
                    <input type="hidden" name="parent_id" value="{{ c.id }}">
                    <textarea class="js-comment-body" name="body" maxlength="280" rows="2" style="width:100%;" placeholder="Write a reply…"></textarea>
                    <div style="margin-top:8px;">
                      <button type="submit">Reply</button>
                      <span class="subtle" style="margin-left:10px;">280 characters max.</span>
                    </div>
                  </form>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if current_user.is_authenticated %}
        <div id="commentbox-{{ r.id }}" style="display:none; margin-top:12px;">
          <form method="post" action="{{ url_for('add_comment', report_id=r.id) }}">
            {# Render CSRF only. We'll provide parent_id manually to avoid duplicate fields. #}
            {{ comment_form.csrf_token }}
            <input type="hidden" name="next" value="{{ request.full_path }}">
            <input type="hidden" name="parent_id" value="">
            <textarea class="js-comment-body" name="body" maxlength="280" rows="2" style="width:100%;" placeholder="Write a comment…"></textarea>
            <div style="margin-top:8px;">
              <button type="submit">Post</button>
              <span class="subtle" style="margin-left:10px;">280 characters max.</span>
            </div>
          </form>
        </div>
      {% endif %}

    </div>
  {% else %}
    <div class="card">
      <p>No posts yet. Be the first to <a href="{{ url_for('submit') }}">submit a ticket</a>.</p>
    </div>
  {% endfor %}

  {% if pagination.pages > 1 %}
    <div class="card">
      <div class="row" style="justify-content:space-between;gap:12px;">
        <div>
          {% if pagination.has_prev %}
            <a href="{{ url_for('home', page=pagination.prev_num, hide_anon=(1 if hide_anon else None)) }}">← Newer</a>
          {% endif %}
        </div>
        <div class="subtle">Page {{ pagination.page }} of {{ pagination.pages }}</div>
        <div>
          {% if pagination.has_next %}
            <a href="{{ url_for('home', page=pagination.next_num, hide_anon=(1 if hide_anon else None)) }}">Older →</a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

</div>

<style>
  /* Reuse the exact thank_you thermometer styling (scoped to this template). */
  .thermo-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
  .thermo-label{font-size:13px;font-weight:700;color:#374151}
  .thermo-pct{font-size:13px;font-weight:800;color:#111827}
  .thermo-bar{height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .thermo-fill{height:100%;background:#111827;border-radius:999px}
</style>

<script>
  function membersOnly(id){
    var el=document.getElementById('mo-'+id);
    if(!el){return;}
    el.style.display='inline';
    setTimeout(function(){ el.style.display='none'; }, 900);
  }
  function toggleComment(id){
    var el=document.getElementById('commentbox-'+id);
    if(!el){return;}
    el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
  }
  function toggleReply(commentId){
    var el=document.getElementById('replybox-'+rootId);
    if(!el){return;}
    el.style.display = (el.style.display==='none' || el.style.display==='') ? 'block' : 'none';
  }

  // Open the reply box for a comment and (if empty) prefill an @mention.
  function openReplyWithMention(rootId, parentId, username){
    var box = document.getElementById('replybox-'+rootId);
    if(!box){return;}
    box.style.display = 'block';
    try{
      var pid = box.querySelector('input[name="parent_id"]');
      if(pid && parentId){ pid.value = parentId; }
    }catch(e){}
    try{
      var ta = box.querySelector('textarea[name="body"]');
      if(!ta){return;}
      var current = (ta.value || '').trim();
      if(!current && username){
        ta.value = '@' + username + ' ';
      }
      ta.focus();
      // Move cursor to end
      ta.selectionStart = ta.selectionEnd = ta.value.length;
    }catch(e){}
  }

  // Enter submits, Shift+Enter adds a new line (comments + replies only)
  (function bindEnterToSubmit(){
    try{
      document.addEventListener('keydown', function(e){
        var t = e.target;
        if(!t) return;
        if(t.classList && t.classList.contains('js-comment-body')){
          if(e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            var form = t.closest('form');
            if(form){ form.submit(); }
          }
        }
      });
    }catch(e){}
  })();

  // Note: comment/reply boxes are closed by default on page load.
</script>


  <script>
    (function convertLocalTimes(){
      var nodes = document.querySelectorAll('.js-localtime[data-utc]');
      if(!nodes || nodes.length === 0) return;

      function formatLocal(d){
        try{
          return new Intl.DateTimeFormat(undefined, {
            month: 'short',
            day: '2-digit',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          }).format(d);
        }catch(e){
          return d.toLocaleString();
        }
      }

      nodes.forEach(function(el){
        var iso = el.getAttribute('data-utc');
        if(!iso) return;
        var d = new Date(iso);
        if(isNaN(d.getTime())) return;
        el.textContent = formatLocal(d);
      });
    })();
  
<script>
function toggleComments(reportId, totalCount) {
  const link = document.getElementById('toggle-comments-' + reportId);
  const isExpanded = link.getAttribute('data-expanded') === '1';
  // Find all comment elements for this report beyond the first two, based on inline display:none inserted server-side.
  // We'll toggle any element inside this report card that currently has style containing 'display:none' and an id starting with 'comment-'.
  const card = link.closest('.card');
  if (!card) return;
  const hidden = card.querySelectorAll('[id^="comment-"][style*="display:none"]');
  const shownExtra = card.querySelectorAll('[id^="comment-"][data-extra="1"]');
  if (!isExpanded) {
    hidden.forEach(el => { el.style.display = ''; el.setAttribute('data-extra','1'); });
    link.textContent = 'Collapse comments';
    link.setAttribute('data-expanded','1');
  } else {
    // re-hide extras we previously revealed
    shownExtra.forEach(el => { el.style.display = 'none'; el.removeAttribute('data-extra'); });
    link.textContent = 'View all ' + totalCount + ' comments';
    link.setAttribute('data-expanded','0');
  }
}
</script>
</script>

{% endblock %}